<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.18.2/cytoscape.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type=text/javascript>
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.3.2/cytoscape-dagre.min.js"></script>
        <script src="https://unpkg.com/layout-base@1.0.2/layout-base.js"></script>
        <script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
        <script src="https://unpkg.com/cose-base@1.0.3/cose-base.js"></script>
        <script src="https://unpkg.com/cytoscape-graphml/cytoscape-graphml.js"></script>
        <script src="https://raw.githack.com/iVis-at-Bilkent/cytoscape.js-layvo/unstable/cytoscape-layvo.js"></script>
        <script src="{{url_for('static', filename='cytoscape.js-cise/cytoscape-cise.js')}}"></script>
        <script src="{{url_for('static', filename='cytoscape-no-overlap/cytoscape-no-overlap.js')}}"></script>
        <script src="https://unpkg.com/layout-base/layout-base.js"></script>
        <script src="https://unpkg.com/cose-base/cose-base.js"></script>
        <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
        <script src="https://unpkg.com/layout-base/layout-base.js"></script>
        <script src="https://unpkg.com/cose-base/cose-base.js"></script>
        <title>Result</title>
    </head>
    <style>
        #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
        background: #FFFFFF;
        z-index: -1;
        }
        .modal {
        display: none;
        /* Hidden by default */
        position: absolute;
        /* Stay in place */
        z-index: 1;
        /* Sit on top */
        padding-top: 100px;
        /* Location of the box */
        left: 0;
        top: 0;
        width: 100%;
        /* Full width */
        height: 100%;
        /* Full height */
        overflow: auto;
        /* Enable scroll if needed */
        background-color: rgb(0, 0, 0);
        /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4);
        /* Black w/ opacity */
        }
        /* Modal Content */
        .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        height: 85%;
        font-family: Arial, Helvetica, sans-serif;
        }
        .modal-body {
        max-height: ca(100vh - 210px);
        overflow-y: auto;
        }
        .hiddenHeader {
            visibility: hidden;
            max-height: 0;
        }
        .circle {
        width: 300px;
        height: 200px;
        line-height: 200px;
        border-radius: 50%;
        font-size: 12px;
        color: #000;
        text-align: top;
        background: #000
        }
        .loader {
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #4CAF50;
        width: 25px;
        height: 25px;
        animation: spin 2s linear infinite;
        opacity: 0;
        }
        .loading {
        color:#4CAF50
        }
        .loader.show {
        opacity: 1;
        }
        .loader.tc_scheme {
        opacity: 1;
        }
        @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }
        /* The Close Button */
        .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        }
        .close:hover,
        .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
        }
        #menuDiv {
        padding: 0px 20px 20px 0px
        }
        #posEv {
        float: left;
        padding-right: 20px;
        width: 33%;
        font-size: large;
        }
        #negEv {
        float: left;
        width: 33%;
        padding-right: 20px;
        font-size: large;
        }
        #incEv {
        float: right;
        width: 33%;
        font-size: large;
        }
        #posThickness {
        float: left;
        width: 33%;
        padding-bottom: 10px;
        }
        #negThickness {
        float: left;
        width: 33%;
        padding-bottom: 10px;
        }
        #incThickness {
        float: right;
        width: 33%;
        padding-bottom: 10px;
        }
        dl{height:200px;}
        dl{overflow:hidden; overflow-y:scroll;}
        .itemconfiguration
        {
            height:175px;
            /* background-color:#CCC; */	
            overflow:hidden;
            overflow-y:scroll;
            border:1px solid lightgrey;
            margin-bottom:10px;
            padding-top:5px;
        }
        .evDiv
        {
            height:500px;
            /* background-color:#CCC; */	
            overflow:hidden;
            overflow-y:scroll;

        }
        .matchDiv
        {
            padding-left:10px;
        }
        label {
          margin-left: 5px;
        }
        
        .collapsible {
          background-color: #FFFFFF;
          cursor: pointer;
          padding: 5px;
          width: 80%;
          height: 10%;
          border: none;
          text-align: left;
          outline: none;
          font-size: 15px;
          word-break: break-all;
        }

        .collapsible:hover {
          background-color: #f1f1f1;
        }

        .collapsible:after {
          color: white;
          font-weight: bold;
          float: right;
          margin-left: 5px;
          border: "none";
        }

        .content {
          padding: 0 4%;
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.2s ease-out;
        }

        li{
            word-break: break-all;
        }
        
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }

        /* Firefox */
        input[type=number] {
          -moz-appearance: textfield;
        }
        
        .src_tar_button {
            padding: 0;
            border: none;
            background: none;
        }
        
        .tooltip-text {
          visibility: hidden;
          position: absolute;
          z-index: 1;
          width: 150px;
          color: white;
          font-size: 12px;
          background-color: #192733;
          border-radius: 10px;
          padding: 10px 15px 10px 15px;
        }
        
        .hover-text:hover .tooltip-text {
          visibility: visible;
        }
        
        #top {
          top: -40px;
          left: -50%;
        }
        
        .hover-text {
          position: relative;
          display: block;
          font-size: 0.85em;
        }

</style>



    <body>
        <div id="floatParent">
        <div id="cy"></div>
        <div class="w3-sidebar w3-bar-block w3-border-right" style="display:block;width:30%" id="mySidebar">
            <button onclick="w3_close()" class="w3-bar-item w3-large">Close &times;</button>
            <form id="queryForm" method="POST" action="{{ url_for('go_home') }}">
                <p><input class="w3-bar-item w3-button w3-border-bottom" style="color:#4CAF50;" type="submit" value="Return to Homepage" /></p>
            </form>
            <div style="padding:20px;padding-top:0px">
                <h2 style="padding-bottom:10px;">Details</h2>
                <h6>
                    Click on connections between nodes to see the evidence for that connection. <br> <br>
                    Mouseover nodes to see only the nodes that the node directly targets. <br> <br>
                    Red, blue, and white edges indicate down, up, and inconclusive relationships, respectively.
                    Details found in README. <br> <br>
                    Click the <span class=".reload;">&#x21bb;</span> icon to reload the visualization after making
                    adjustments.
                </h6>
            </div>
            
            <hr>
            
            <div style="padding-left:20px;" class="slidecontainer" id="thickness_div">
                <h2 style="padding-bottom:10px;">Parameters</h2>
                <h6>Filter by thickness:</h6>
             <p id="totalLabel" style="color:grey;margin-left:20px;margin-right:40px;display:none">Total thickness</p>
            <input type="range" min="2" value="2" class="slider" id="myRange" style="width:50%;margin-left:20px">
            <form action="#" id="input_thickness" style="display:inline;">
               <input type="number" id="quantity" min="2" value="2" style="width:15%">
               <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
            </form>
             <div id="IndFilter" style="display:none">
             <p style="color:grey;margin-left:20px;margin-right:40px;">REACH thickness</p>
           <input type="range" min="2" value="2" class="slider" id="myRangeR" style="width:50%;margin-left:20px">
            <form action="#" id="input_thicknessR" style="display:inline;">
               <input type="number" id="quantityR" min="2" value="2" style="width:15%">
               <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
            </form>
             <p style="color:grey;margin-left:20px;margin-right:40px;">BIOGRID thickness</p>
           <input type="range" min="1" value="1" class="slider" id="myRangeBG" style="width:50%;margin-left:20px">
            <form action="#" id="input_thicknessBG" style="display:inline;">
               <input type="number" id="quantityBG" min="1" value="1" style="width:15%">
               <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
            </form>
             </div>
          <ul class="nav">
                    <li style="display:inline;margin-left:20px;">
                        <div class="loading" id="filter_loading"></div>
                    </li>
                    <li style="display:inline">
                        <div id="filter_loader" class="loader"></div>
                    </li>
                </ul>
            </div>
            
            
          <div style="padding-left:20px;" class="slidecontainer" id="kb_div">
              <h6>Filter by knowledge base:</h6>
              
                <form id="kb_form" action="#" style="width:82%;">
                  <dl style="border:1px solid lightgrey;margin-left:20px;margin-bottom:5px;">

                     <dt style="margin-left:10px;padding-top:10px">
                          <input class="allCheckbox" id="all_prot" value="all_prot" type="checkbox" />
                          <label class="allLabel" for="all_prot" style="margin-left:5px">Genes/proteins</label>
                      </dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="uniprot" value="uniprot" type="checkbox"/>
                              <label for="uniprot" style="margin-left:5px">Uniprot</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="fplx" value="fplx" type="checkbox" />
                              <label for="fplx" style="margin-left:5px">FamPlex</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="PR" value="PR" type="checkbox" />
                              <label for="PR" style="margin-left:5px">PR</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="interpro" value="interpro" type="checkbox" />
                              <label for="interpro" style="margin-left:5px">Interpro</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="pfam" value="pfam" type="checkbox" />
                              <label for="pfam" style="margin-left:5px">Pfam</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px">
                          <input class="allCheckbox" id="all_chem" value="all_chem" type="checkbox" />
                          <label class="allLabel" for="all_prot" style="margin-left:5px">Chemicals</label>
                     </dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="CHEBI" value="CHEBI" type="checkbox" />
                              <label for="CHEBI" style="margin-left:5px">CHEBI</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="pubchem" value="pubchem" type="checkbox" />
                              <label for="pubchem" style="margin-left:5px">PubChem</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px">Cellular events</dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="GO" value="GO" type="checkbox" />
                              <label for="GO" style="margin-left:5px">GO</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px" style="margin-left:5px">Diseases</dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="mesh" value="mesh" type="checkbox" />
                              <label for="mesh" style="margin-left:5px">Mesh</label>
                           </li>
                        </ul>
                     </dd>
                  </dl>

                <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;float:right;margin-bottom:20px;"><span class=reload>&#x21bb;</span></button>
            </form>
          <br><br>
          </div>
            
            
            <div style="padding-left:20px">
                
                <h6>Node/Edge Toggles:</h6>
                <div style="margin-right:40%;margin-bottom:10px;margin-left:20px">
                    <div class="hover-text" style="margin-right:5px;display:inline;">Direct Neighbors:
                        <span class="tooltip-text" style="left:0px;top:-150px;">Toggle showing direct neighbors to the query nodes. Only edges with >20 thickness are retrieved to limit network size.</span>
                    </div>
                    <div class="form-check form-switch" style="display:inline;float:right;">
                        <input class="form-check-input" type="checkbox" role="switch" id="direct-button" onchange="run_show_direct()" style="display:inline">
                        <label class="form-check-label" for="direct-button" style="display:inline"></label>
                    </div>
                </div>

                <div style="margin-right:40%;margin-bottom:10px;margin-left:20px">
                    <div class="hover-text" style="margin-right:5px;display:inline;">Linkers:
                        <span class="tooltip-text" style="left:0px;top:-200px;">Toggle showing linkers between query nodes. If a node is both a direct neighbor and linker, the linker attribute will take priority. Only works if "Edges between endpoints" parameter >1.</span>
                    </div>
                    <div class="form-check form-switch" style="display:inline;float:right;">
                        <input class="form-check-input" type="checkbox" role="switch" id="linker-button" onchange="run_show_linker()" style="display:inline">
                        <label class="form-check-label" for="linker-button" style="display:inline"></label>
                    </div>
                </div>

                <div style="margin-right:40%;margin-bottom:10px;margin-left:20px">
                    <div class="hover-text" style="margin-right:5px;display:inline;">Hide edges:
                        <span class="tooltip-text" style="left:0px;top:-130px;">Toggle showing edges. Click on a node to view its edges. Useful when a high density of edges is obstructive.</span>
                    </div>
                    <div class="form-check form-switch" style="display:inline;float:right;">
                        <input class="form-check-input" type="checkbox" role="switch" id="edges-button" onchange="run_hide_edges()" style="display:inline">
                        <label class="form-check-label" for="edges-button" style="display:inline"></label>
                    </div>
                </div>
                
                <div style="margin-right:40%;margin-bottom:10px;margin-left:20px">
                    <div class="hover-text" style="margin-right:5px;display:inline;">Hide query orphans:
                        <span class="tooltip-text" style="left:0px;top:-115px;">Toggle showing orphaned query nodes with a degree of 0. Autoregulation counts as 1 degree.</span>
                    </div>
                    <div class="form-check form-switch" style="display:inline;float:right;">
                        <input class="form-check-input" type="checkbox" role="switch" id="orphan-button" onchange="run_hide_orphans()" style="display:inline">
                        <label class="form-check-label" for="orphan-button" style="display:inline"></label>
                    </div>
                </div>
                
                
                <div style="margin-right:40%;margin-bottom:10px;margin-left:20px">
                    <div class="hover-text" style="margin-right:5px;display:inline;">Hide unlinked linkers:
                        <span class="tooltip-text" style="left:0px;top:-150px;">Toggle showing nodes that no longer function as linkers between at least two query nodes. Usually used after filtering thickness.</span>
                    </div>
                    <div class="form-check form-switch" style="display:inline;float:right;">
                        <input class="form-check-input" type="checkbox" role="switch" id="unlinked-button" onchange="run_hide_unlinked()" style="display:inline">
                        <label class="form-check-label" for="unlinked-button" style="display:inline"></label>
                    </div>
                </div>


                <ul class="nav">
                    <li style="display:inline;margin-left:20px;margin-top:10px;">
                        <div class="loading" id="direct_loading"></div>
                    </li>
                    <li style="display:inline;margin-top:10px;">
                        <div id="direct_loader" class="loader"></div>
                    </li>
                </ul>
            </div>


            <div style="padding-left:20px;">
                <h6>Search for a node:</h6>
                <form action="#" id="node_search" style="display:inline;">
                    <input type="text" id="node_name" style="width:66%;margin-left:20px;">
                    <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
                </form>
                <button id="reset" onclick="reset_query()" class="btn btn-primary" style="display:none;background-color:#4CAF50;"><span class=reload>&#171;</span></button>
                <p style="color:grey;margin-left:20px;">Current search: <span id="current_query">None</span></p>
            </div>

             <div style="padding-left:20px;padding-bottom:10px">

                <h6>Find all paths between two nodes:</h6>

                <form action="#" id="path_finding" style="display:inline;">
                    <div style="padding-left:20px;display:inline;">
                        <input id="node1" name="path" type="text" placeholder="Node 1" style="width:27%;display:inline;">
                        <p style="display:inline;margin-left:3%;margin-right:3%;"> to </p>
                        <input id="node2" name="path" type="text" placeholder="Node 2" style="width:27%;display:inline;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;display:inline"><span class="reload">&#x21bb;</span></button>
                </form>

                <button id="reset_path" onclick="reset_query()" class="btn btn-primary" style="display:none;background-color:#4CAF50;"><span class=reload>&#171;</span></button>

                 <div style="clear:both;">
                    <p style="color:grey;margin-left:20px;margin-right:100px">Current path: <span id="current_path">None</span></p>
                </div>
                 
            </div>

            
            <div style="padding-left:20px">
                <h6>Change Layout:</h6>
                <select id="layout-button"  class="form-select"
                    style="margin-left:20px;width:50%;display:inline">
                    <option value="lc">Layered Concentric</option>
                    <option value="clc">Cluster Layered Concentric</option>
                    <option value="CiSE">CiSE</option>
                    <option value="fCose">fCose</option>
                </select>
                <button id="reset_clc" onclick="run_switch_layout()" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;display:inline"><span class=reload>&#x21bb;</span></button>
                <div style="padding-left:20px;display:none" class="slidecontainer" id="fCose_settings">
                    Node repulsion: <input type="range" min="3" max="18" value="9" class="slider" id="nr_slider" style="display:inline">
                    <p style="width:15%;display:inline;font-size:16px">10<sup><input type="number" id="cur_nr" min="3" max="18" value="9" ></sup></p>
                    <p style="color:grey;margin-right:40px">Description: parameter for adjusting internodal distance.</p>
                </div>
                                
                <div style="padding-left:20px;display:none" class="slidecontainer" id="cise_settings">
                    Node repulsion: <input type="range" min="3" max="18" value="3" class="slider" id="cise_nr_slider" style="display:inline;">
                    <p style="width:15%;display:inline;font-size:16px">10<sup><input type="number" id="cise_cur_nr" min="3" max="18" value="3" ></sup></p>
                    <p style="color:grey;margin-right:40px">Description: parameter for adjusting internodal distance.</p>
                </div>

                <div style="padding-left:20px;margin-top:5px;display:none" class="slidecontainer" id="clc_settings">
                    Inter-cluster padding: <input type="range" min="0" max="20000" value="500" class="slider" id="icp_slider" style="display:inline">
                    <input type="number" id="quantityIcp" min="0" max="20000" value="500" style="width:15%;display:inline;font-size:10px">
                </div>
                
                <ul class="nav">
                    <li style="display:inline;margin-left:20px;margin-top:10px;">
                        <div class="loading" id="layout_loading"></div>
                    </li>
                    <li style="display:inline;margin-top:10px;">
                        <div id="layout_loader" class="loader"></div>
                    </li>
                </ul>
            
            </div>

            
            <div id="layer-div" style="padding-left:20px;">
                <h6>Network Layer:</h6>
                <select id="layer-button" onchange="run_switch_layer()" class="form-select"
                    style="margin-left:20px;width:50%;" value="reach">
                    <option value="reach">Reach</option>
                    <option value="biogrid">BIOGRID</option>
                    <option value="union">Reach + BIOGRID</option>
                </select>

               <div style="padding-left:20px;padding-top:10px;display:none" id="color-scheme">

                    <h6 style="margin-right:5px;display:inline;">Dataset edge coloring:</h6>

                    <div class="form-check form-switch" style="display:inline;">
                        <input class="form-check-input" type="checkbox" role="switch" id="cs-button" onchange="run_change_scheme()" style="display:inline">
                        <label class="form-check-label" for="cs-button" style="display:inline"></label>
                    </div>

                    <p style="color:grey;margin-right:20px;">
                        Description: Toggle edge color to display dataset membership.
                    </p>
                </div>
                
                <p id="legend" style="color:gray;margin-left:20px;margin-top:10px;display:none">
                    Dataset membership legend: <br>
                    
                    <svg width="20" height="20">
                    <rect width="20" height="20" style="fill:#42a7f5;stroke-width:2;stroke:rgb(0,0,0)" />
                    </svg>
                    Reach + BIOGRID <br>
                
                    <svg width="20" height="20">
                    <rect width="20" height="20" style="fill:#9d49f2;stroke-width:2;stroke:rgb(0,0,0)" />
                    </svg>
                    Reach <br>
                    
                    <svg width="20" height="20">
                    <rect width="20" height="20" style="fill:#77ed40;stroke-width:2;stroke:rgb(0,0,0)" />
                    </svg>
                    BIOGRID <br>
                </p>
                 <ul class="nav">
                    <li style="display:inline">
                        <div class="loading" id="layer_loading"></div>
                    </li>
                    <li style="display:inline">
                        <div id="layer_loader" class="loader"></div>
                    </li>
                </ul>
            </div>
            
            <hr>
            
            
            <div style="padding:20px;padding-top:0px;text-align:center">
                <h6>
                    Note: Inaccuracies should be expected due to errors in the NLP.
                </h6> <br>

                <a href="#" onclick="getNodes()" style="padding-right:20px;">Export nodes (.tsv)</a>
                <a href="#" onclick="getEdges()" style="padding-right:20px;">Export edges (.tsv)</a>
            </div>
            
        </div>
        <script>
            function w3_open() {
                document.getElementById("mySidebar").style.display = "block";
            }
            
            function w3_close() {
                document.getElementById("mySidebar").style.display = "none";
            }
            
                    $('.allCheckbox').change(function(event) {  
            var proteins = ["uniprot", "fplx", "PR", "interpro", "pfam"]
            var chemicals = ["pubchem", "CHEBI"]
            console.log("checked box")
            if(this.checked) {
                if (this.value=="all_prot") {
                    $(':checkbox').each(function() {
                        console.log(this.value)
                        if (proteins.includes(this.value)) {
                            this.checked = true;
                        }            
                    });
                } else {
                     $(':checkbox').each(function() {
                        if (chemicals.includes(this.value)) {
                            this.checked = true;
                        }            
                    });
                }
                // Iterate each checkbox
            } else {
                if (this.value=="all_prot") {
                    $(':checkbox').each(function() {
                        if (proteins.includes(this.value)) {
                            this.checked = false;
                        }            
                    });
                } else {
                     $(':checkbox').each(function() {
                        if (chemicals.includes(this.value)) {
                            this.checked = false;
                        }            
                    });
                }
            }
        }); 
        </script>
        <button class="w3-button w3-teal w3-xlarge" onclick="w3_open()" style="z-index:2">â˜°</button>
            
        <div id="newModal" class="modal" style="z-index: 9999;">
            <div class="modal-content" style="height:85%;">
                <span class="close">&times;</span>
                 <div id="reachHeader" class="modal-header text-center" style="background-color:#a6a6a6;height:120px">
                 <svg  xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
                        <g>
                            <circle id="source" cx="230" cy="75" r="30" />
                            <text id="source_lab" x="230" y="70" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="source_id" x="230" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>                                      
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 100">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="0" refY="3.5" orient="auto">
                                <polygon id="triangle" points="0 2, 8 3.5, 0 5" />
                            </marker>
                        </defs>
                        
                        <text id="line_lab" dominant-baseline="central" text-anchor="middle" x="138" y="38" font-family="Verdana" font-size="12" fill="black"></text>
                        
                        <line id="line" x1="10" y1="50" x2="270" y2="50" stroke="#000" 
                            stroke-width="8" marker-end="url(#arrowhead)" />
                    </svg>                  
                    <svg  xmlns="http://www.w3.org/2000/svg" style="overflow: visible">
                        <g>
                            <circle id="target" cx="70" cy="75" r="30" />
                            <text id="target_lab" x="70" y="70" dominant-baseline="central" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="target_id" x="70" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>
            </div>
                 <div id="BGHeader" class="modal-header text-center" style="background-color:#a6a6a6;height:120px">
                 <svg  xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
                        <g>
                            <circle id="sourceBG" cx="230" cy="75" r="30" />
                            <text id="source_labBG" x="230" y="70" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="source_idBG" x="230" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>                                      
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 100">
                        
                        <text id="line_labBG" dominant-baseline="central" text-anchor="middle" x="138" y="38" font-family="Verdana" font-size="12" fill="black"></text>
                        
                        <line id="lineBG" x1="0" y1="50" x2="800" y2="50" stroke="#000" 
                            stroke-width="8" />
                    </svg>                  
                    <svg  xmlns="http://www.w3.org/2000/svg" style="overflow: visible">
                        <g>
                            <circle id="targetBG" cx="70" cy="75" r="30" />
                            <text id="target_labBG" x="70" y="70" dominant-baseline="central" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="target_idBG" x="70" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>
            </div>
            <nav>
			<div class="nav nav-tabs mb-3" id="nav-tab" role="tablist">
				<button class="nav-link active" id="reach-tab" data-bs-toggle="tab" data-bs-target="#nav-reach" type="button" role="tab" aria-controls="nav-reach" aria-selected="true" style="visibility:hidden">NLP</button>
				<button class="nav-link" id="biogrid-tab" data-bs-toggle="tab" data-bs-target="#nav-biogrid" type="button" role="tab" aria-controls="nav-biogrid" aria-selected="false" style="visibility:hidden">BIOGRID</button>
			</div>
		</nav>
		<div id="tablist" class="tab-content p-3 border bg-light" id="nav-tabContent" style="height:55%;">
			<div class="tab-pane fade" id="nav-reach" role="tabpanel" aria-labelledby="reach-tab" style="height:100%;">
				 <div id="reachEv" class="evDiv" style="height:inherit;">
                    <h1 id="thickness" style="font-family: Arial, Helvetica, sans-serif"></h1>
                    <h2 id="posThickness"></h2>
                    <h2 id="negThickness"></h2>
                    <h2 id="incThickness"></h2>
                    <div id="posEv"></div>
                    <div id="negEv"></div>
                    <div id="incEv"></div>
                </div>
			</div>
			<div class="tab-pane fade" id="nav-biogrid" role="tabpanel" aria-labelledby="nav-biogrid" style="height:100%;">
				<div id="bgEv" class="evDiv" style="height:inherit;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th scope="col">Author (year)</th>
                          <th scope="col">Experiment type</th>
                          <th scope="col">Evidence type</th>
                          <th scope="col">PMC ID</th>
                        </tr>
                      </thead>
                      <tbody id="bgContents">
                          <div id="bgDiv">
                          </div>
                      </tbody>
                    </table>
                </div>
			</div>
		</div>
            </div>
        </div>


        <div id="synModal" class="modal">
            
            <div class="modal-content" style="height:85%;width:75%;">
                <span class="close">&times;</span>
                 <div class="modal-header">
                    <h2 id="synLabel" style="font-family: Arial, Helvetica, sans-serif;margin-right:5%;">Synonyms:</h2>
                    <button id="markovButton" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;margin-right:5%">Get Markov neighbors</button>
                </div>
                
                <nav>
                    <div class="nav nav-tabs mb-3" id="syn-nav-tab" role="tablist">
                        <button class="nav-link active" id="syn-tab" data-bs-toggle="tab" data-bs-target="#nav-syn" type="button" role="tab" aria-controls="nav-syn" aria-selected="true">Synonyms</button>
                        <button class="nav-link" id="src-tab" data-bs-toggle="tab" data-bs-target="#nav-src" type="button" role="tab" aria-controls="nav-src" aria-selected="false">Sources</button>
                        <button class="nav-link" id="tar-tab" data-bs-toggle="tab" data-bs-target="#nav-tar" type="button" role="tab" aria-controls="nav-tar" aria-selected="false">Targets</button>
                    </div>
                </nav>
                
                <div id="tablist" class="tab-content p-3 border bg-light" id="nav-tabContent" style="height:55%;">
                    <div class="tab-pane fade show active" id="nav-syn" role="tabpanel" aria-labelledby="syn-tab" style="height:100%;">
                         <h3 id="synList" class="evDiv" style="margin-left:5%;margin-right:5%;height:inherit"></h3>
                    </div>
                    <div class="tab-pane fade" id="nav-src" role="tabpanel" aria-labelledby="src-tab" style="height:100%;">
                        <h3 id="srcList" class="evDiv" style="margin-left:5%;margin-right:5%;height:inherit"></h3>
                    </div>
                    <div class="tab-pane fade" id="nav-tar" role="tabpanel" aria-labelledby="tar-tab" style="height:100%;">
                        <h3 id="tarList" class="evDiv" style="margin-left:5%;margin-right:5%;height:inherit"></h3>
                    </div>
              </div>  
            </div>
        </div>
            
        <div id="warnModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="modalBody" class="modal-body">
                    <h2>Your query generated a large graph, so only edges with thickness > 20 are included</h2>
                </div>
            </div>
        </div>
            
        <div id="searchModal" class="modal" style="width:30%;">
            <div class="modal-content" style="height:57%;">
                <span class="close">&times;</span>
                <div class="modal-header" style="padding-top:0;padding-bottom:1;display:block;">
                    <h5 id="synLabel" style="font-family: Arial, Helvetica, sans-serif">Select match</h5>
                    <p style="color:gray;">Click text to show synonyms</p> 
                </div>
                
                <div id="modalBody" class="modal-body">
                    <form id="matchForm" action="#" >
                        <div class="itemconfiguration">
                            <div style="margin-left:3%;" id="matchOptions"></div>
                        </div>
                        
                         <button type="submit" id="submitMatch" class="btn btn-primary" style="background-color:#4CAF50;float:right"><span class=reload>&#x21bb;</span></button>
                    </form>
                </div>
                
            </div>
        </div>
            
       
            


       <div id="pathModal" class="modal" style="width:30%;">
            <div class="modal-content" style="height:95%;">
                <span class="close">&times;</span>
                
                <div class="modal-header" style="padding-top:0;padding-bottom:0;display:block;">
                    <h4 id="synLabel" style="font-family: Arial, Helvetica, sans-serif">Select matches</h4>
                    <p style="color:gray;">Click text to show synonyms</p> 
                </div>
                
                <div id="modalBody" class="modal-body">
                    <form id="pathForm" action="#" >
                        <h6>Node 1:</h6>
                        
                        <div class="itemconfiguration">
                            <div style="margin-left:3%;"  id="options1"></div>
                        </div>
                        
                        <h6>Node 2:</h6>
                        
                        <div class="itemconfiguration">
                            <div style="margin-left:3%;"  id="options2"></div>
                        </div>
                        
                         <button type="submit" id="submitPath" class="btn btn-primary" style="background-color:#4CAF50;float:right"><span class=reload>&#x21bb;</span></button>
                        
                    </form>
                </div>
                
            </div>
        </div>


        <script src="{{url_for('static', filename='bfs_vis_functions.js')}}"></script>

        <script>
            const data = {{ elements | tojson }};
            var cy = cytoscape({
                wheelSensitivity: 0.1,
                container: document.getElementById('cy'),
                elements: data,
                boxSelectionEnabled:true,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            "text-valign": "center",
                            "text-halign": "center",
                            "background-color": "data(color)",
                            "text-outline-color": "#555",
                            "text-outline-width": "2px",
                            "color": "#080707",
                            width: function (ele) { return Math.min((Math.max(80, ele.degree() + 2) * 2), 500); },
                            height: function (ele) { return Math.min((Math.max(80, ele.degree() + 2) * 2), 500); },
                            "font-size": function (ele) { return Math.min((Math.log2(ele.degree() + 2) * 25), 350); },
                            'background-fit': 'contain',
                            'background-clip': 'none',
                            "display": "data(display)",
                            "display_id":"data(display_id)",
                            "lcX": "data(lcX)",
                            "lcY": "data(lcY)",
                            "clcX": "data(clcX)",
                            "clcY": "data(clcY)",
                            "layer": "data(layer)",
                            "type": "data(type)",
                            "border-width": "5px" // function (ele) { return ele.data("border_width"); }
                        },
                        position: {
                            x: "data(position)",
                            y: "data(position)"
                        }
                    }, {
                        selector: 'edge',
                        style: {
            
                            'text-background-color': 'yellow',
                            'text-background-opacity': 0.4,
                            'target-arrow-shape': 'triangle',
                            'control-point-step-size': '30px',
                            'curve-style': 'bezier',
                            "display": "data(display)",
                            'width': 'data(weight)',
                            'line-color': "data(color)",
                            'target-arrow-color': "data(color)"
                        }
                    },
                    
                     {
                        selector: 'node.semitransp',
                        style: { 'opacity': '.1' }
                    },
                    {
                        selector: 'edge.semitransp',
                        style: { 'opacity': '.1' }
                    },
                    {
                        selector: 'node.transp',
                        style: {
                            'opacity': '0',
                            'events': 'no'
                        }
                    },
                    {
                        selector: 'edge.transp',
                        style: { 'opacity': '0',
                               'events': 'no'}
                    },
                    {
                        selector: 'node.markov',
                        style: { 'background-color': "#26ff12" }
                    },
                    {
                        selector: 'node.large',
                        style: {
                            'font-size': 200
                        }
                    },
                    {
                        selector: 'node.searched',
                        style: {
                            'background-color': "#26ff12"
                        }
                    },
                    {
                        selector: 'edge.searched',
                        style: {
                            'line-color': "#26ff12",
                            'target-arrow-color':"#26ff12"
                        }
                    },
                    {
                        selector: 'edge.mouseover',
                        style: {
                            'line-color': "#26ff12",
                            'target-arrow-color':"#26ff12"
                        }
                    },
                    {
                        selector: 'edge.colors',
                        style: {
                            'line-color': "data(color)",
                            'target-arrow-color': "data(color)"
                        }
                    },
                    {
                    selector: 'node.mouseup',
                    style: { 'border-width': 10,
                      'border-color': 'yellow' }
                }
            
                ]
            })
                
             var reachCise = {}
             var BGCise = {}
             var unionCise = {}
             var reachCiseDN = {}
             var BGCiseDN = {}
             var unionCiseDN = {}
             var zoom
             var zoomDN
             
             // Track if toggles have been chan
             let show = true;
             let showl = true;
             let hide = true;
             let hideo = true;
             let hideul = true;
             
            run_lc()
        
            
            findNode = function(arr, node) {
                for (var i=0; i<arr.length; i++) {
                    var eles = arr[i] 
                    console.log("eles length: "+eles.length)
                    if (eles.contains(node)) {
                        return i
                    }
                }
            };
            
            var in_clust=false
            var non_neighbors = []
            markov_clust = function(node) {
                var clusters = cy.elements().filter(function(ele) {
                    return ((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0")) }).markovClustering({
                    inflateFactor:5,
                  attributes: [
                    function( edge ){ return edge.data('thickness'); }
                  ]
                });
                var ind = findNode(clusters, node)
                var neighbors = clusters[ind]
                console.log("neighbors len"+neighbors.length)
                neighbors.addClass("markov")
            }
            
            var icp_slider = document.getElementById("icp_slider")
            icp_slider.oninput = function() {
                document.getElementById("quantityIcp").value = this.value
            }
            var quantityIcp = document.getElementById("quantityIcp")
            quantityIcp.oninput = function() {
                document.getElementById("icp_slider").value = this.value
            }
            rerunCLC = function() {
                var cur_layout = document.getElementById("layout-button").value
                var retval
                
                var edges = cy.edges().filter(function(ele) {
                    return(
                        (ele.source().style("display")=="element") & 
                        (ele.target().style("display")=="element") &
                        (!ele.hasClass("transp")) & 
                        (!ele.source().hasClass("transp")) & 
                        (!ele.target().hasClass("transp")))
                })
                
                var nodes = cy.nodes().filter(function(ele) {
                    return(
                        (ele.style("display")=="element") & 
                        (!ele.hasClass("transp")))
                })
                
                var nodes_str = JSON.stringify(nodes.jsons())
                var edges_str = JSON.stringify(edges.jsons())
                
                console.log("Nodes: "+nodes_str)
                console.log("Edges: "+edges_str)
                
                $.ajaxSetup({
                    async: false
                });

                if (cur_layout=="clc") {
                    var cur_icp = document.getElementById("icp_slider").value
                    
                    $.post('/rerunCLC', {
                        subset_nodes: nodes_str,
                        subset_edges: edges_str,
                        layout: cur_layout,
                        icp: cur_icp
                    }, function(data) {
                        retval = data.coords
                    });
                    
                    for (var i=0; i<nodes.length; i++) {
                        var node = nodes[i]
                        node.data('clcX', retval[node.id()].clc_X)
                        node.data("clcY", retval[node.id()].clc_Y) 
                    }
                     run_clc()    
                } else if (cur_layout=="lc") {
                    $.post('/rerunCLC', { subset_nodes:nodes_str, subset_edges:edges_str, layout:cur_layout}, function(data){
                        retval = data.coords
                    });
                    for (var i=0; i<nodes.length; i++) {
                        var node = nodes[i]
                        node.data('lcX', retval[node.id()].lc_X)
                        node.data("lcY", retval[node.id()].lc_Y) 
                    }
                    run_lc()
                }
            }

            //Disable switching layers for non-gene queries
            {% if string_type != "gene" %}
                document.getElementById("layer-div").style.display = "none"
                 resetSliderMin("reach")
            {% else %}
                document.getElementById("layer-div").style.display = "block"
            {% endif %}
            
//             //Alert if network was filtered
//             {% if filtered %}
//                 const filtered = true
//             {% else %}
//                 const filtered = false
//             {% endif %}
//             if (filtered) {
//                 var modal = document.getElementById("warnModal");
//                 var span = document.getElementsByClassName("close")[2];
//                 modal.style.display = "block";
            
//                 window.onclick = function (event) {
//                     if (event.target == modal) {
//                         var modalBody = document.getElementById("modalBody");
//                         modalBody.scrollTop = 0;
//                         modal.style.display = "none";
//                     }
//                 }
            
//                 span.onclick = function () {
//                     var modalBody = document.getElementById("modalBody");
//                     modalBody.scrollTop = 0;
//                     modal.style.display = "none";
//                 }
//             } 
            
            var currently_querying = false
            
            cy.on('mouseover', 'node', function (evt) {
                if (!currently_querying) {
                   var sel = evt.target;
                    console.log(sel.degree());
                    console.log(sel.data("KB"));
                    sel.addClass('large');
                    var neighbors = sel.outgoers().union(sel.incomers());
                    cy.nodes().difference(neighbors).not(sel).addClass('semitransp');
                    cy.edges().difference(sel.edgesWith(neighbors)).addClass("semitransp"); 
                }
                console.log("Position: "+JSON.stringify(sel.position()))
                console.log(sel.indegree())
            });
            
            cy.on('mouseover', 'edge', function (evt) {
                   var sel = evt.target;
                    if (sel.style()["opacity"] != "0") {
                        sel.addClass('mouseover');
                    }
                console.log("source lab: "+sel.data("source_lab"))
                console.log("target lab: "+sel.data("target_lab"))
            });
            
            cy.on('mouseout', 'node', function (evt) {
                if (!currently_querying) {
                    var sel = evt.target;
                    sel.removeClass('large');
                    var neighbors = sel.outgoers().union(sel.incomers());
                    cy.nodes().difference(neighbors).not(sel).removeClass('semitransp');
                    cy.edges().difference(sel.edgesWith(neighbors)).removeClass("semitransp");
                }
            
            });
            
            cy.on('mouseout', 'edge', function (evt) {
                   var sel = evt.target;
                    sel.removeClass('mouseover');
            });

             //Format REACH evidence modal (pos, neg inc)
             function formatEvREACH(ev_split) {
                var ul_pos = document.createElement("ul");
                var ul_neg = document.createElement("ul");
                var ul_inc = document.createElement("ul");
                var negCount = 0;
                var posCount = 0;
                var incCount = 0;
                for (var i = 0; i < ev_split.length; i++) {
                    // Create the list item:
                    var item = document.createElement('li');
                    var cont = document.createElement("div");
            
                    var parts = ev_split[i].split("|");
                    var text = parts[0];
                    var act = parts[1];
            
            
                    // Set its contents:
                    item.appendChild(document.createTextNode(text));
                    cont.appendChild(item)
                    if (act === "Activation (Negative)") {
                        cont.style.color = "red";
                        negCount = negCount += 1;
                    } else if (act === "Activation (Positive)") {
                        cont.style.color = "blue";
                        posCount = posCount += 1;
                    }
                    else {
                        cont.style.color = "black";
                        incCount = incCount += 1;
                    }
            
                    cont.style.padding = "0px 0px 20px 0px";

                    // Add it to the list:
                    if (act === "Activation (Positive)") {
                        ul_pos.appendChild(cont);
                    } else if (act === "Activation (Negative)") {
                        ul_neg.appendChild(cont);
                    } else {
                        ul_inc.appendChild(cont);
                    }
            
                }

                function createFiller() {
            
                    var fillerText = document.createElement("li");
                    var fillerCont = document.createElement("div");
            
                    fillerText.appendChild(document.createTextNode("This is filler text"));
                    fillerCont.appendChild(fillerText);
                    fillerCont.style.padding = "0px 20px 0px 0px";
                    fillerCont.style.color = "white";
                    return fillerCont;
                }
            
                var fillerPos = createFiller();
                var fillerNeg = createFiller();
                var fillerInc = createFiller();
                ul_pos.appendChild(fillerPos);
                ul_neg.appendChild(fillerNeg);
                ul_inc.appendChild(fillerInc);
                 var out = {
                  "ul_pos": ul_pos,
                  "ul_neg": ul_neg,
                  "ul_inc": ul_inc,
                  "posCount": posCount,
                  "negCount": negCount,
                  "incCount": incCount   
                } 
                return(out) 
             }
             
             //Format biogrid ev (table with author, experiment info, etc)
             function formatEvBG(bg_ev) {
              // creates a <table> element and a <tbody> element
              var tbl = document.createElement("div");
              // creating all cells
              for (let i = 0; i < bg_ev.length; i++) {
                // creates a table row
                const row = document.createElement("tr");
                var split_ev = bg_ev[i].split("%%%")
                for (let j = 0; j < split_ev.length; j++) {
                  // Create a <td> element and a text node, make the text
                  // node the contents of the <td>, and put the <td> at
                  // the end of the table row
                  const cell = document.createElement("td");
                  const cellText = document.createTextNode(split_ev[j]);
                  cell.appendChild(cellText);
                  row.appendChild(cell);
                }

                // add the row to the end of the table body
                tbl.appendChild(row); 
              }
              return(tbl)
            }
             
             //Create node visualization at top of evidence modal
             formatHeader = function(sel) {
                var triangle = document.getElementById("triangle");
                var src_node = document.getElementById("source");
                var source_lab = document.getElementById("source_lab");
                var tar_node = document.getElementById("target");
                var target_lab = document.getElementById("target_lab");
                var source_id_lab = document.getElementById("source_id")
                var target_id_lab = document.getElementById("target_id")                
                var line = document.getElementById("line");
                var line_lab = document.getElementById("line_lab");
                 
                var src_nodeBG = document.getElementById("sourceBG");
                var source_labBG = document.getElementById("source_labBG");
                var tar_nodeBG = document.getElementById("targetBG");
                var target_labBG = document.getElementById("target_labBG");
                var source_id_labBG = document.getElementById("source_idBG")
                var target_id_labBG = document.getElementById("target_idBG")                
                var lineBG = document.getElementById("lineBG");
                var line_labBG = document.getElementById("line_labBG");
               
           
                var sel_source = sel.source();
                var sel_target = sel.target();
                       
                var source = sel_source.data().label;
                var source_id = sel_source.data().display_id;
                var target = sel_target.data().label;
                var target_id = sel_target.data().display_id;

                var src_lab = "("+source_id+")"
                var tar_lab = "("+target_id+")"

                source_lab.innerHTML = source
                target_lab.innerHTML = target
                source_id_lab.innerHTML = src_lab
                target_id_lab.innerHTML = tar_lab
                source_labBG.innerHTML = source
                target_labBG.innerHTML = target
                source_id_labBG.innerHTML = src_lab
                target_id_labBG.innerHTML = tar_lab
                       
                src_node.parentNode.appendChild(source_id_lab);

                <!-- Visualize clicked edge/nodes -->                
                src_node.style.fill = sel.source().data().color;
                src_nodeBG.style.fill = sel.source().data().color;
                tar_node.style.fill = sel.target().data().color;
                tar_nodeBG.style.fill = sel.target().data().color;
                 
                triangle.style.fill = sel.data().color;
                line.style.stroke = sel.data().color;
                lineBG.style.stroke = sel.data().color;
                 
                line_lab.innerHTML = "Total mentions: " + sel.data("thickness");
                line_labBG.innerHTML = "Total mentions: " + sel.data("thickness");
                 
                //hide arrowhead if BG
                 if (document.getElementById("layer-button").value=="biogrid") {
                     document.getElementById("reachHeader").classList.add("hiddenHeader");
                     document.getElementById("BGHeader").classList.remove("hiddenHeader");
                 } else {
                     document.getElementById("reachHeader").classList.remove("hiddenHeader");
                     document.getElementById("BGHeader").classList.add("hiddenHeader");
                 }
             }
             
             format_edge = function(sel) {
                 console.log("sel id: "+sel.id())
                 function getEvidence() {
                    var retval;
                    $.ajaxSetup({
                        async: false
                    });
                    $(function() {
                      $.getJSON($SCRIPT_ROOT + '/_get_evidence', {
                        files:sel.data().files
                      }, function(data) {
                          console.log(data.result);
                          retval = data.result;
                          return false;
                      });
                    });
                    console.log(retval);
                    return retval;
                }
            
                var ev = getEvidence();
                
                var modal = document.getElementById("newModal") 
                var span = document.getElementsByClassName("close")[0];
                var thickness = document.getElementById("thickness");
                var parts = ev.split("&&&")
                {% if string_type=="gene" %}
                    var bg_ev = parts.slice(1)   //BG ev is everything after the &&&    
                    var bg_ev = [...new Set(bg_ev)].filter(part => part.length > 0);
                    var ev_split = parts[0].split("%%").filter(part => part.length > 0);
                    bg_ev_length = bg_ev.length
                    reach_ev_length = ev_split.length
                    bg_tbl = formatEvBG(bg_ev)
                    document.getElementById("bgContents").innerHTML = bg_tbl.innerHTML
                 {% else %}
                    var ev_split = parts.join("").split("%%").filter(part => part.length > 0); //Handle case with more than 1 file per edge
                {% endif %}

                formatHeader(sel)
                 
                var reach_formatted = formatEvREACH(ev_split)
                document.getElementById("posThickness").innerHTML = "Positive: " + reach_formatted["posCount"];
                document.getElementById("negThickness").innerHTML = "Negative: " + reach_formatted["negCount"];
                document.getElementById("incThickness").innerHTML = "Inconclusive: " + reach_formatted["incCount"];
                document.getElementById("posEv").innerHTML = reach_formatted["ul_pos"].innerHTML;
                document.getElementById("negEv").innerHTML = reach_formatted["ul_neg"].innerHTML;
                document.getElementById("incEv").innerHTML = reach_formatted["ul_inc"].innerHTML;
                               
                var cur_layer = document.getElementById("layer-button").value 
                var rt = document.getElementById("reach-tab")
                var bt = document.getElementById("biogrid-tab")
                var navr = document.getElementById("nav-reach")
                var navb = document.getElementById("nav-biogrid")
                if  (cur_layer=="reach") {
                    rt.style.visibility = 'hidden'
                    bt.style.visibility = 'hidden'
                    navr.classList.add('active', 'show')
                    navb.classList.remove('active', 'show')
                } else if (cur_layer=="biogrid") {
                    rt.style.visibility = 'hidden'
                    bt.style.visibility = 'hidden'
                    navr.classList.remove('active', 'show')
                    navb.classList.add('active', 'show')
                } else {
                    rt.style.visibility = 'visible'
                    bt.style.visibility = 'visible'
                    rt.classList.add('active')
                    bt.classList.remove('active')
                    navr.classList.add('active', 'show')
                    navb.classList.remove('active', 'show')
                    rt.innerHTML = "Reach ("+reach_ev_length+")"
                    bt.innerHTML = "BIOGRID ("+bg_ev_length+")"
                }
                var reache = document.getElementById("reachEv")
                var bge = document.getElementById("bgEv")

                modal.style.display = "block";
            
                span.onclick = function () {
                    reache.scrollTop = 0;
                    bge.scrollTop = 0;
                    modal.style.display = "none";
                }
            }


             cy.on('click', 'edge', function (evt) {     
                var sel = evt.target;
                format_edge(sel) }
                ); 
                  
            format_item = function(text) {
                var item = document.createElement('li');
                var cont = document.createElement("div");

                // Set its contents:
                item.appendChild(document.createTextNode(text));
                cont.appendChild(item);
                cont.style.padding = "0px 0px 20px 0px";
                
                return(cont)
            } 
                  
            get_edgeData_from_id = function(edge_id) {
                var edge = cy.$id(edge_id);
                format_edge(edge)
            }  
   
            format_button = function(text, edge) {
                var element = document.createElement("li");
                var cont = document.createElement('a'); 
                var edge_id = edge.id()
                cont.setAttribute("value", edge_id)
                cont.setAttribute("href", "#")
                cont.setAttribute("onclick", "get_edgeData_from_id('"+edge_id+"')");
                cont.innerHTML = text
                element.appendChild(cont);
                return(element)  
            }      
             
            cy.on('click', 'node', function (evt) {
                var sel = evt.target;
                console.log("type:"+sel.data("type"))
                console.log("layer:"+sel.data("layer"))
                console.log("id: "+sel.id())
                console.log("width: "+sel.data('border_width'))
                var modal = document.getElementById("synModal");
                var synLabel = document.getElementById("synLabel");
                synLabel.innerHTML = sel.data("label") + " (" + sel.data("display_id") + ")"
                var span = document.getElementsByClassName("close")[1];
                var syn = sel.data().syn;
                var syn_split = syn.split("%%");
                syn_split = [...new Set(syn_split)];
                var syn_list = document.createElement("ul")
                for (var i = 0; i < syn_split.length; i++) {
                    var text = syn_split[i];                   
                    var cont = format_item(text)
                    syn_list.appendChild(cont);
                }
                document.getElementById("synList").innerHTML = syn_list.innerHTML;
                
                var edges = sel.connectedEdges()
                var src_list = document.createElement("ul")
                var tar_list = document.createElement("ul")
                for (var i=0; i<edges.length; i++) {
                    var edge = edges[i]
                    if (edge.source().id()==sel.id()) {
                        var lab = edge.target().data("label")
                        var id = edge.target().data("display_id")
                        var text = lab + " (" + id + ")"
                        var cont = format_button(text, edge)
                        if (edge.target().data("type")=="Query" | !show) {
                            tar_list.appendChild(cont)
                        }
                    } else if (edge.target().id()==sel.id()) {
                        var lab = edge.source().data("label")
                        var id = edge.source().data("display_id")
                        var text = lab + " (" + id + ")"
                        var cont = format_button(text, edge)
                        if (edge.source().data("type")=="Query" | !show) {
                            src_list.appendChild(cont)
                        }
                    }
                }
                document.getElementById("srcList").innerHTML = src_list.innerHTML
                document.getElementById("tarList").innerHTML = tar_list.innerHTML;
                
                modal.style.display = "block";
                
                var synList = document.getElementById("synList")
                var srcList = document.getElementById("srcList")
                var tarList = document.getElementById("tarList")
                
                var synTab = document.getElementById("syn-tab")
                var srcTab = document.getElementById("src-tab")
                var tarTab = document.getElementById("tar-tab")
                
                var navSyn = document.getElementById("nav-syn")
                var navSrc = document.getElementById("nav-src")
                var navTar = document.getElementById("nav-tar")
                
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    synList.scrollTop = 0;
                    srcList.scrollTop = 0;
                    tarList.scrollTop = 0
                    modal.style.display = "none";
                    synTab.classList.add('active')
                    srcTab.classList.remove('active')
                    tarTab.classList.remove('active')
                    navSyn.classList.add('active', 'show')
                    navSrc.classList.remove('active', 'show')
                    navTar.classList.remove('active', 'show')
                }
                
                var markovButton = document.getElementById("markovButton");
                markovButton.onclick = function() {
                    in_clust = true;
                    markov_clust(sel);
                    modalBody.scrollTop = 0;
                    modal.style.display="none";
                }
            });


            cy.on('box', function (evt) {
                 var sel = evt.target
                 console.log(sel.length)
                 sel.filter(function(ele) {return((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"))}).addClass("mouseup")
            });


             cy.on('tap', function(event){
              // target holds a reference to the originator
              // of the event (core or element)
              var evtTarget = event.target;

              if( evtTarget === cy ){
                cy.nodes().removeClass("mouseup")
              } 
                 cy.nodes().removeClass("markov")

            }); 


         function getSelectValues(select) {
              var result = [];
              for (var i=0, iLen=select.length; i<iLen; i++) {
                var opt = select[i];
                if (opt.checked) {
                  result.push(opt.value);
                }
              }
              return result;
        }

        var kb_form =  document.getElementById("kb_form");
        var selected_kbs = []
        kb_form.onsubmit = function() {
            console.log("submitted")
            var slider = document.getElementById("myRange");
            var threshold=slider.value
            var kb_select = document.getElementsByClassName('messageCheckbox');
            
            selected_kbs = getSelectValues(kb_select);
            
            console.log("selected kbs: "+selected_kbs)
            filterKBs(selected_kbs)
            
            console.log("KB filter threshold: "+threshold)
            
            filterEdges(threshold)
            
            var cur_layout = document.getElementById("layout-button").value
            if(cur_layout=="clc"){rerunCLC()}
            
            return false
        }

        //
        filterEdgesUnion = function(threshold_r, threshold_bg, threshold_total) {
            filteredNodes.removeClass("transp");
            filteredEdges.restore();

            filteredEdges = cy.edges().filter(function(ele) {
                return((((ele.data("thickness_r") < threshold_r) && (ele.data("thickness_bg") < threshold_bg)) |
                      (ele.data("thickness") < threshold_total)) && (ele.data("layer")=="union"))
            });
            filteredEdges = cy.remove(filteredEdges);
            filteredNodes = cy.nodes().filter(function (ele) {
                return ((ele.degree() == 0) && (ele.data("type") != "Query")&& (ele.data("layer")=="union"));
            });
            filteredNodes.addClass("transp");
        }
                  
                  
        const download = function (data, filename) {

            // Creating a Blob for having a csv file format 
            // and passing the data with type
            const blob = new Blob([data], { type: 'text/csv' });

            // Creating an object for downloading url
            const url = window.URL.createObjectURL(blob)

            // Creating an anchor(a) tag of HTML
            const a = document.createElement('a')

            // Passing the blob downloading url 
            a.setAttribute('href', url)

            // Setting the anchor tag attribute for downloading
            // and passing the download file name
            a.setAttribute('download', filename);

            // Performing a download with click
            a.click()
        }


        function getNodes()  {
            var eles = cy.nodes().filter(function(ele) {return((ele.style("display")=="element") & (!ele.hasClass("transp")))}).jsons()
            var nodes_str = JSON.stringify(eles)
            var retval;
            $.ajaxSetup({
                async: false
            });
            $.post('/getNodes', {subset_nodes: nodes_str}, function(data){
                retval = data.nodes_df
            });  
            download(retval, "nodes.tsv")
          }
                  
         function getEdges()  {
            var eles = cy.edges().filter(function(ele) {
                return((ele.source().style("display")=="element") & (ele.target().style("display")=="element") &
                       (!ele.hasClass("transp")) & (!ele.source().hasClass("transp")) & (!ele.target().hasClass("transp")))}).jsons()
            var edges_str = JSON.stringify(eles)
            var retval;
            $.ajaxSetup({
                async: false
            });
            $.post('/getEdges', {subset_edges: edges_str}, function(data){
                retval = data.edges_df
            });
            download(retval, "edges.tsv")
          }


        function getMaxWeight(allEdges) {
            var weight_arr = []
            for (var i = 0; i < allEdges.length; i++) {
                var edgeData = (allEdges[i]).data()
                var weight = edgeData.thickness
                weight_arr.push(weight)
            }
            Array.prototype.max = function() {
              return Math.max.apply(null, this);
            };
            var maxWeight = weight_arr.max()
            return(maxWeight)
        }
                  
        function getMaxWeightUnion(allEdges) {
             var weight_arrR = []
             var weight_arrBG = []
             for (var i = 0; i < allEdges.length; i++) {
                 var edgeData = (allEdges[i]).data()
                 var weightR = edgeData.thickness_r
                 var weightBG = edgeData.thickness_bg
                 weight_arrR.push(weightR)
                 weight_arrBG.push(weightBG)
             }
             Array.prototype.max = function() {
               return Math.max.apply(null, this);
             };
             var maxWeightR = weight_arrR.max()
             var maxWeightBG = weight_arrBG.max()
             return([maxWeightR, maxWeightBG])
         }  

            var filteredEdges = cy.edges().filter('[thickness < 0]');
            var filteredNodes = cy.nodes().filter(function (ele) {
                return ele.degree() == -2;
            });
            filteredEdges = cy.remove(filteredEdges);
            filteredNodes = cy.remove(filteredNodes);
            
            var slider = document.getElementById("myRange");
            var queryEdges = cy.edges().filter(function (ele) {
                return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0") && (ele.data("layer")=="reach"));
            });
            var queryEdgesBG = cy.edges().filter(function (ele) {
                return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0") && (ele.data("layer")=="biogrid"));
            });
            var queryEdgesUnion = cy.edges().filter(function (ele) {
                return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0") && (ele.data("layer")=="union"));
            });
            var allEdges = cy.edges().filter(function(ele) {return((ele.data("layer")=="reach"))})    
            var queryMax = Math.ceil(getMaxWeight(queryEdges))
            var allMax = Math.ceil(getMaxWeight(allEdges))
            var allEdgesBG = cy.edges().filter(function(ele) {return((ele.data("layer")=="biogrid"))})    
            var queryMaxBG = Math.ceil(getMaxWeight(queryEdgesBG))
            var allMaxBG = Math.ceil(getMaxWeight(allEdgesBG))
            var allEdgesUnion = cy.edges().filter(function(ele) {return((ele.data("layer")=="union"))})    
            var queryMaxUnion = Math.ceil(getMaxWeight(queryEdgesUnion))
            var allMaxUnion = Math.ceil(getMaxWeight(allEdgesUnion))
            var [maxR, maxBG] = getMaxWeightUnion(allEdgesUnion)
            var [maxR_q, maxBG_q] = getMaxWeightUnion(queryEdgesUnion)
            slider.max = queryMax
            var input_qty = document.getElementById("quantity");
            input_qty.max = queryMax
            input_qty.innerHTML = slider.value;
            var input_thickness = document.getElementById("input_thickness") 
            
            slider.oninput = function () {
                var cur_layer = document.getElementById("layer-button").value
                threshold = this.value;
                input_qty.innerHTML = threshold;
                input_qty.value = threshold
            }
                  
            input_thickness.onsubmit = function () {  
                var thickness_val = document.getElementById("quantity");
                var threshold = thickness_val.value;
                var cur_layer = document.getElementById("layer-button").value
                
                if (cur_layer != "union") {
                    run_filter_edges(threshold)
                } else {
                    var thresholdR = document.getElementById("quantityR").value;
                    var thresholdBG = document.getElementById("quantityBG").value;
                    run_filter_edges_union(thresholdR, thresholdBG, threshold)
                }                
                filterKBs(selected_kbs)
                input_qty.innerHTML = threshold
                slider.value=threshold
                
                return false
            }
                  
            var sliderR = document.getElementById("myRangeR");
            var sliderBG = document.getElementById("myRangeBG")       
            sliderR.max = maxR_q
            sliderBG.max = maxBG_q    
            var input_qtyR = document.getElementById("quantityR");
            input_qtyR.max = maxR_q
            input_qtyR.innerHTML = sliderR.value;
            var input_qtyBG = document.getElementById("quantityBG");
            input_qtyBG.max = maxBG_q
            input_qtyBG.innerHTML = sliderBG.value;
            var input_thicknessR = document.getElementById("input_thicknessR") 
            var input_thicknessBG = document.getElementById("input_thicknessBG") 
            var thresholdR = sliderR.value
            var thresholdBG = sliderBG.value
            
            sliderR.oninput = function () {
                var thresholdR = this.value;
                input_qtyR.innerHTML = thresholdR;
                input_qtyR.value = thresholdR
            }
            
            input_thicknessR.onsubmit = function () {          
                var thickness_valR = document.getElementById("quantityR");
                var thresholdBG = document.getElementById("quantityBG").value
                var thresholdTotal = document.getElementById("quantity").value
                var thresholdR = thickness_valR.value;
                run_filter_edges_union(thresholdR, thresholdBG, thresholdTotal)
                filterKBs(selected_kbs)
                input_qtyR.innerHTML = thresholdR
                sliderR.value=thresholdR
                
                return false
            }
            
            sliderBG.oninput = function () {
                var thresholdBG = this.value;
                input_qtyBG.innerHTML = thresholdBG;
                input_qtyBG.value = thresholdBG
            }
            
            input_thicknessBG.onsubmit = function () {          
                var thickness_valBG = document.getElementById("quantityBG");
                var thresholdTotal = document.getElementById("quantity").value
                var thresholdR = document.getElementById("quantityR").value
                var thresholdBG = thickness_valBG.value;
                run_filter_edges_union(thresholdR, thresholdBG, thresholdTotal)
                filterKBs(selected_kbs)
                input_qtyBG.innerHTML = thresholdBG
                sliderBG.value=thresholdBG
                
                return false
            }

            function updatePM(tu_id) {
                // Get the item you want to update
                var toupdate = document.ElementById(tu_id)
                
                // Loop through all nodes
                for (var i=0; i<nodes.length; i++) {
                    var sel = nodes[i];
                    var syn = sel.data().syn;
                    
                    // String-match onto the search from all nodes
                    if (syn.includes(search)) {
                        var cont = document.createElement("div")
                        
                    }
                }
            }

// Start inserting here -- follows the below generalized form:
// <input type="radio" style="display:inline" name="nodeSel">
// <button class="collapsible"></button>
// <div class="content">
//     <ul>
//         <li> ... </li>
//         ...
//     <ul>
// </div>

            function updateCollapsible(el_id, search, nodes, name="nodeSel"){
                var options = document.getElementById(el_id);
                options.innerHTML = "";
                for(var i=0; i<nodes.length; i++) {
                    var sel = nodes[i];
                    var syn = sel.data().syn.toLowerCase();
                    console.log("search: "+search)
                    console.log("syn: "+syn)
                    // String-matching part
                    if (syn.includes(search)) {
                        // Content: append other stuff to this for the scrolling menu
                        // Making the input radio
                        var input_el = document.createElement("input");
                        input_el.type = "radio";
                        input_el.style.display = "inline";
                        input_el.name = name;
                        input_el.value = sel.id();
                        input_el.id = sel.id();

                        options.appendChild(input_el);
                        
                        // Making the button
                        var btn_el = document.createElement("button");
                        btn_el.className = "collapsible";
                        btn_el.id = "btn_el";
                        btn_el.type = "button";
                        btn_el.innerHTML = sel.data().label + " ("+sel.data().display_id+")";

                        options.appendChild(btn_el);

                        // Making the div to contain the synonyms (parent of ul_el)
                        var div_el = document.createElement("div");
                        div_el.className = "content"; 

                        // Making the ul to contain the synonyms (parent of li_el)
                        var ul_el = document.createElement("ul");

                        // Turn the synonyms into usable text
                        var syn_split = syn.split("%%");
                        syn_split = [...new Set(syn_split)];    // Turn split into array
                        for (var j = 0; j < syn_split.length; j++) {
                            // Making the li to contain the synonym (child of ul_el)
                            var li_el = document.createElement("li");
                            li_el.innerHTML = syn_split[j];

                            ul_el.appendChild(li_el);
                        }

                        div_el.appendChild(ul_el);

                        options.appendChild(div_el);
                    }
                }
            }
            
            
            var node_search = document.getElementById("node_search");
            var current_query = document.getElementById("current_query");
            var reset_button = document.getElementById("reset");
            node_search.onsubmit = function () {
                cy.nodes().removeClass("searched");
                cy.edges().removeClass("searched")
                cy.nodes().filter(function(ele) {return((ele.degree()>0) | (ele.data("type")=="Query"))}).removeClass("transp");
                cy.edges().removeClass("transp");
                var modal = document.getElementById("searchModal")
                var span = document.getElementsByClassName("close")[3];
                reset_button.style="background-color:#4CAF50;"
                var node_name = document.getElementById("node_name");
                var search = node_name.value.toLowerCase();
                var nodes = cy.nodes().filter(function(ele) {return((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0"))})

                updateCollapsible("matchOptions", search, nodes)

                modal.style.display = "block";
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }

                return false
            }
             
            
            var matchForm = document.getElementById("matchForm")
            matchForm.onsubmit = function() {
                var choice = document.querySelector('input[name="nodeSel"]:checked').value;
                var results_nodes = cy.nodes().filter(function(ele) {
                    return ((ele.id() === choice));})
                var cq =  results_nodes.data().label + " ("+results_nodes.data().display_id+")"
                
                current_query.innerHTML = cq; 
                results_nodes.addClass('searched')
                
                var neighbors = results_nodes.outgoers().union(results_nodes.incomers());
                var results_edges = results_nodes.connectedEdges()
                var results_nodes = results_nodes.union(neighbors)
                
                cy.nodes().difference(results_nodes).addClass('transp');
                cy.edges().difference(results_edges).addClass('transp');
                
                var modal = document.getElementById("searchModal")
                var modalBody = document.getElementById("modalBody");
                
                modalBody.scrollTop = 0;
                modal.style.display = "none";
                
                return false
            }
             
            var path_finding =  document.getElementById("path_finding");
            path_finding.onsubmit = function() {
                cy.nodes().removeClass("searched");
                cy.edges().removeClass("searched")
                cy.nodes().filter(function(ele) {return((ele.degree()>0) | (ele.data("type")=="Query"))}).removeClass("transp");
                cy.edges().removeClass("transp");
                var modal = document.getElementById("pathModal")
                var span = document.getElementsByClassName("close")[4];
                
                var node1 = document.getElementById("node1").value.toLowerCase();
                var node2 = document.getElementById("node2").value.toLowerCase();
                
                var nodes = cy.nodes().filter(function(ele) {return((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0"))})
                
                updateCollapsible("options1", node1, nodes, name="options1")
                updateCollapsible("options2", node2, nodes, name="options2")
                
               modal.style.display = "block";
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }

                return false
            }
            
             function findPaths(src,dest) {
                let successors = src.successors();
                let predecessors = dest.predecessors();
                return successors.intersection(predecessors);
            }
             
            var pathForm = document.getElementById("pathForm")
            var current_path = document.getElementById("current_path")
            var reset_path = document.getElementById("reset_path")
            pathForm.onsubmit = function() {
                reset_path.style="background-color:#4CAF50;"
                var choice1 = document.querySelector('input[name="options1"]:checked').value;
                var choice2 = document.querySelector('input[name="options2"]:checked').value;
                
                var node1 = cy.nodes().filter(function(ele) {
                    return ((ele.id() === choice1));})
                var node2 = cy.nodes().filter(function(ele) {
                    return ((ele.id() === choice2));})
                
                var path =  node1.data().label + " ("+node1.data().display_id+") to "+node2.data().label + " ("+node2.data().display_id+")"
                current_path.innerHTML = path; 
                
                var rootNode = cy.$id(choice1)
                var targetNode = cy.$id(choice2)
                
                //var dijkstra = cy.elements().dijkstra(rootNode);
                //var pathToJ = dijkstra.pathTo(targetNode);
                var pathToJ = findPaths(rootNode, targetNode)
                
                var pathNodes = pathToJ.nodes().filter(function(ele) {return((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0"))})
                pathNodes.addClass("searched")
                if (pathNodes.length>0) {
                    rootNode.addClass("searched")
                    targetNode.addClass("searched")
                }
                var pathEdges = pathToJ.edges().filter(function(ele) {return((ele.source().style()["display"] != "none") && 
                            (ele.source().style()["opacity"] != "0") && (ele.target().style()["display"] != "none") &&
                                                                            (ele.target().style()["opacity"] != "0") &&
                                                                            (ele.source().id() != ele.target().id()))})
                pathEdges.addClass("searched")
                
                var modal = document.getElementById("pathModal")
                var modalBody = document.getElementById("modalBody");
                modalBody.scrollTop = 0;
                modal.style.display = "none";
                return false
            }
             
            function reset_query() {
                document.getElementById("node_name").value=""
                document.getElementById("node1").value = ""
                document.getElementById("node2").value = ""
                cy.nodes().removeClass("transp");
                cy.edges().removeClass("transp");
                cy.nodes().removeClass("searched");
                cy.edges().removeClass("searched")
                current_query.innerHTML = "None"; 
                current_path.innerHTML = "None"
                reset_button.style.display = "None"
                reset_path.style.display="None"
                var slider = document.getElementById("myRange");
                var threshold=slider.value
                var cur_layer = document.getElementById("layer-button").value
                if (cur_layer!="union") {
                     filterEdges(threshold)
                 } else {
                    var thresholdR = document.getElementById("quantityR").value;
                    var thresholdBG = document.getElementById("quantityBG").value;
                     console.log("R: "+thresholdR+" BG: "+thresholdBG+" total: "+threshold)
                    filterEdgesUnion(thresholdR, thresholdBG, threshold)                       
                 }
                filterKBs(selected_kbs)
            }
            
            display_loading = async function(elem_id) {
                var elem = document.getElementById(elem_id)
                elem.style.display = "block"
                elem.innerHTML = "Loading"
                return("Promise 1")
            }
            
            hide_loading = async function(elem_id) {
                var elem = document.getElementById(elem_id)
                elem.style.display = "none"
                return("Promise 2")
            }
            
            filterEdges = function(threshold) {
                filteredNodes.removeClass("transp");
                filteredEdges.restore();
                var cur_layer = document.getElementById("layer-button").value
                
                filteredEdges = cy.edges().filter(function(ele) {
                    return((ele.data("thickness") < threshold) && (ele.data("layer")==cur_layer))
                });
                filteredEdges = cy.remove(filteredEdges);
                filteredNodes = cy.nodes().filter(function (ele) {
                    return ((ele.degree() == 0) && (ele.data("type") != "Query")&& (ele.data("layer")==cur_layer));
                });
                filteredNodes.addClass("transp");
            }
            
            var excludedEdges = cy.edges().filter('[thickness < 0]');
            var excludedNodes = cy.nodes().filter(function (ele) {
                return ele.degree() == -2;
            });
            excludedEdges = cy.remove(excludedEdges);
            excludedNodes = cy.remove(excludedNodes);
            filterKBs = function(kb_list) {
                resetKBs()
                if (kb_list.length!=0) {
                    excludedNodes = cy.nodes().filter(function(ele) {
                        return (!((kb_list.includes(ele.data("KB")) && ele.degree()!=0) | ele.data("type")=="Query") &&(ele.data("layer")=="reach"))
                    });
                    excludedNodes.addClass("transp");
                    excludedEdges = cy.edges().filter(function(ele) {
                        return ((excludedNodes.includes(ele.source()) | excludedNodes.includes(ele.target())))
                    })
                    excludedEdges = cy.remove(excludedEdges)
                }
            } 
            
            resetKBs = function() {
                excludedEdges.restore()
                excludedEdges.style("display", "element")
                excludedNodes.removeClass("transp")
            } 
             
            function run_filter_edges(threshold) {
                const status = document.querySelector('#filter_loading');
                const loader = document.querySelector('#filter_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        filterEdges(threshold)
                        resolve();
                    },ms)
                  })
                }
                status.innerHTML = "Filtering edges...&nbsp;";
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
                  
            function run_filter_edges_union(threshold_r, threshold_bg, threshold) {
                const status = document.querySelector('#filter_loading');
                const loader = document.querySelector('#filter_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        filterEdgesUnion(threshold_r, threshold_bg, threshold)
                        resolve();
                    },ms)
                  })
                }
                status.innerHTML = "Filtering edges...&nbsp;";
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
            
            function switch_layout() {
                var layout = document.getElementById("layout-button");
                if (layout.value === "fCose") {
                    run_fCose(idealEL=iel, nodeRep=nr);
                    document.getElementById("fCose_settings").style.display = "block";
                    document.getElementById("cise_settings").style.display = "none";
                    document.getElementById("clc_settings").style.display = "none"
                } else if (layout.value == "lc") {
                    rerunCLC();
                    document.getElementById("fCose_settings").style.display = "none";
                    document.getElementById("cise_settings").style.display = "none";
                    document.getElementById("clc_settings").style.display = "none"
                } else if (layout.value == "clc") {
                    rerunCLC();
                    document.getElementById("fCose_settings").style.display = "none";
                    document.getElementById("cise_settings").style.display = "none";
                    document.getElementById("clc_settings").style.display = "block"
                } else {
                    reset_cise_pos()
                    run_cise(nodeRep=cise_nr)
                    document.getElementById("fCose_settings").style.display = "none";
                    document.getElementById("cise_settings").style.display = "block";
                    document.getElementById("clc_settings").style.display = "none"
                }
            }
            
            
            // reset stored cise positions
            function reset_cise_pos() {
                var layer = document.getElementById("layer-button").value
                if (layer=="reach") {
                    reachCise = {}
                    reachCiseDN = {}
                } else if (layer=="biogrid") {
                    BGCise = {}
                    BGCiseDN = {}
                } else if (layer=="union") {
                    unionCise = {}
                    unionCiseDN = {}
                }
            }
            var nr_slider = document.getElementById("nr_slider")
            var cur_nr = document.getElementById("cur_nr")
            var nr = 1e9
            if (cy.nodes().filter('[type="Linker"]').length==0) {
                var iel = (cy.nodes().filter('[type="Query"]').length)*10+100
            } else {
                var iel = (cy.nodes().filter('[type="Linker"]').length)/2+100
            }
            nr_slider.oninput = function () {
                document.getElementById("cur_nr").value = this.value;
                nr = 10**(this.value);
            }
            cur_nr.oninput = function() {
                document.getElementById("nr_slider").value = this.value
                nr = 10**(this.value);
            }  
             
            var cise_nr_slider = document.getElementById("cise_nr_slider")
            var cise_cur_nr = document.getElementById("cise_cur_nr")
            cise_cur_nr.value=9
            cise_nr_slider.value=9
             var cise_nr = 1e9
            cise_nr_slider.oninput = function () {
                document.getElementById("cise_cur_nr").value = this.value;
                cise_nr = 10**(this.value);
            }
            cise_cur_nr.oninput = function() {
                document.getElementById("cise_nr_slider").value = this.value
                cise_nr = 10**(this.value);
            }  
            
            
            function reset_slider() {
                var cur_layout = document.getElementById("layout-button").value
                if (cur_layout=="fCose") {
                    nr_slider.value=9
                    cur_nr.innerHTML="1e9"
                } else {
                    cise_nr_slider.value=9
                    cise_cur_nr.innerHTML="1e9"
                }
            
            }


            function rerun_layout() {
                var layout = document.getElementById("layout-button");
                if (layout.value === "Grid") {
                    run_grid();
                } else if (layout.value === "Circle") {
                    run_circle();
                } else if (layout.value=="fCose") {
                    run_fCose(idealEL=iel, nodeRep=nr);
                } else if (layout.value == "lc" | layout.value == "clc"){
                    rerunCLC()
                }  else {
                    reset_cise_pos()
                    run_cise(nodeRep=cise_nr);
                }
            }
            
            //Add loader to layout switching      
            function run_switch_layout() {
                const status = document.querySelector('#layout_loading');
                const loader = document.querySelector('#layout_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        switch_layout();
                        resolve();
                    },ms)
                  })
                }
                status.innerHTML = "Rerunning layout...";
                loader.classList.toggle('show', true);
                loader.style.display = "block"
                wait()
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                    loader.style.display = "none"
                })
            }
             
            function getRndInteger(min, max) {
              return Math.floor(Math.random() * (max - min) ) + min;
            } 
             
            //Make clusters for cise 
            function make_clust(eles) {
                nodes = eles.nodes().filter("[type='Query']")
                clusters = []
                for (var i=0; i<nodes.length; i++) {
                    node = nodes[i]
                    targets = node.neighborhood('node')
                    clust = [node.id()]
                    for (var j=0; j<targets.length; j++) {
                        t = targets[j]
                        if (t.neighborhood("node").length==1) {
                           clust.push(t.id()) 
                        } else {
                            var max = t.connectedEdges().max(function(ele){
                              return(ele.data("thickness"));
                            });
                            if (node.neighborhood("edge").includes(max.ele)) {
                                clust.push(t.id()) 
                            }
                        }
                        
                    }
                    clusters.push(clust)
                }
                return(clusters)
            } 
             
             function get_weights(edge) {
                 return(edge.data("thickness"))
             }
             
            function restorePositions(nodes, nodePositions) {
              for (var i=0; i < nodes.length; i++) {
                  var node = nodes[i]
                  var pos = JSON.parse(nodePositions[node.id()])
                node.position(pos);
              }
            }
                
                  
             function storePositions(nodes) {
              var nodePositions = {};
              for (let i = 0; i < nodes.length; i++) {
                  var key = nodes[i].id()
                  var pos = JSON.stringify(nodes[i].position())
                nodePositions[key] = pos
              }
              return nodePositions;
            }
                  

             function run_cise(nodeRep=1e9) {
                 var cur_layer = document.getElementById("layer-button").value 
                 var subset = cy.elements().filter(function(ele) {return(ele.data("layer")==cur_layer)})
                 var subset_nodes = subset.nodes()
                var newclusters = make_clust(subset)
                var layout = subset.layout({
                    name: 'cise',               
                    animate:true,
                            animationEasing: 1,
                            animationDuration: 1,
                            clusters:newclusters,
                            allowNodesInsideCircle: true,
                            nodeRepulsion: nodeRep
                });
                 if (show) {
                     if ((Object.keys(reachCise).length != 0) & (cur_layer=="reach")) {
                        restorePositions(subset_nodes, reachCise)
                     } else if ((Object.keys(BGCise).length != 0) & (cur_layer=="biogrid")) {
                         restorePositions(subset_nodes, BGCise)
                     } else if ((Object.keys(unionCise).length != 0) & (cur_layer=="union")) {
                         restorePositions(subset_nodes, unionCise)
                     } else {
                        layout.run();
                        setTimeout(() => {  layout.stop(); }, 500);
                        var subset = cy.elements().filter(function(ele) {return(ele.data("layer")==cur_layer)})
                        var subset_nodes = subset.nodes()
                        if (cur_layer=="reach") {
                            Object.assign(reachCise, storePositions(subset_nodes))
                        } else if (cur_layer=="biogrid") {
                            Object.assign(BGCise, storePositions(subset_nodes))
                        } else if (cur_layer=="union") {
                            Object.assign(unionCise, storePositions(subset_nodes))
                        }
                        zoom = Object.freeze(cy.zoom())
                     }
                     cy.zoom(zoom)
                 } else {
                     if ((Object.keys(reachCiseDN).length != 0) & (cur_layer=="reach")) {
                        restorePositions(subset_nodes, reachCiseDN)
                     } else if ((Object.keys(BGCiseDN).length != 0) & (cur_layer=="biogrid")) {
                         restorePositions(subset_nodes, BGCiseDN)
                     } else if ((Object.keys(unionCiseDN).length != 0) & (cur_layer=="union")) {
                         restorePositions(subset_nodes, unionCiseDN)
                     } else {
                        layout.run();
                        setTimeout(() => {  layout.stop(); }, 500);
                        var subset = cy.elements().filter(function(ele) {return(ele.data("layer")==cur_layer)})
                        var subset_nodes = subset.nodes()
                        if (cur_layer=="reach") {
                            Object.assign(reachCiseDN, storePositions(subset_nodes))
                        } else if (cur_layer=="biogrid") {
                            Object.assign(BGCiseDN, storePositions(subset_nodes))
                        } else if (cur_layer=="union") {
                            Object.assign(unionCiseDN, storePositions(subset_nodes))
                        }
                         zoomDN = Object.freeze(cy.zoom())
                     }
                     cy.zoom(zoomDN)
                 }

            }
             
            
            function show_direct(show=true) {
                var cur_layer = document.getElementById("layer-button").value 
                if (show) {
                    cy.edges().filter(function(ele) {
                        return((ele.data("type")=="Direct") && (ele.data("layer")==cur_layer))
                    }).style("display", "element")
                    cy.nodes().filter(function(ele) {
                        return((ele.data("type")=="Direct") && (ele.data("layer")==cur_layer))
                    }).style("display", "element")  
                } else {
                    cy.edges().filter("[type = 'Direct']").style("display", "none")
                    cy.nodes().filter("[type = 'Direct']").style("display", "none")
                }
                resetSliderMax(show)
                
                cur_layout = document.getElementById("layout-button").value
                if (cur_layout=="clc"){rerunCLC()}
            }


            //Add loader to showing direct linkers
            function run_show_direct() {
                const status = document.querySelector('#direct_loading');
                const loader = document.querySelector('#direct_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        show_direct(show);
                        if (show) {
                            show = false
                        } else {
                            show=true
                        }
                        resolve();
                    },ms)
                  })
                }
                if (show) {
                    status.innerHTML = "Loading direct neighbors...";
                } else {
                    status.innerHTML = "Hiding direct neighbors...";
                }
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
                  
                  
            function show_linker(showl=true) {
                var cur_layer = document.getElementById("layer-button").value 
                if (showl) {
                    cy.edges().filter(function(ele) {
                        return((ele.data("type")=="Linker") && (ele.data("layer")==cur_layer))
                    }).style("display", "element")
                    cy.nodes().filter(function(ele) {
                        return((ele.data("type")=="Linker") && (ele.data("layer")==cur_layer))
                    }).style("display", "element")  
                }  else {
                    cy.edges().filter("[type = 'Linker']").style("display", "none")
                    cy.nodes().filter("[type = 'Linker']").style("display", "none")
                }
                resetSliderMax(show)
                
                cur_layout = document.getElementById("layout-button").value
                if (cur_layout=="clc"){rerunCLC()}
            }


            //Add loader to showing direct linkers
            function run_show_linker() {
                const status = document.querySelector('#direct_loading');
                const loader = document.querySelector('#direct_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        show_linker(showl);
                        if (showl) {
                            showl = false
                            hideul = true
                            document.getElementById("unlinked-button").checked = false
                        } else {
                            showl=true
                        }
                        resolve();
                    },ms)
                  })
                }
                if (showl) {
                    status.innerHTML = "Showing linker nodes...";
                } else {
                    status.innerHTML = "Hiding linker nodes...";
                }
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }


            function hide_edges(hide=false, show, showl) {
                var cur_layer = document.getElementById("layer-button").value 
                if (hide) {
                    cy.edges().style("display", "none")
                }  else {
                    // Bring back query edges
                    cy.edges().filter(function(ele) {
                        return((ele.data("type")=="Query") && (ele.data("layer")==cur_layer))
                    }).style("display", "element")
                    if (!show){
                        // Bring back direct edges
                        cy.edges().filter(function(ele) {
                            return((ele.data("type")=="Direct") && (ele.data("layer")==cur_layer))
                        }).style("display", "element")
                    } 
                    if (!showl){
                        // Bring back linker edges
                        cy.edges().filter(function(ele) {
                            return((ele.data("type")=="Linker") && (ele.data("layer")==cur_layer))
                        }).style("display", "element")
                    }
                }
                resetSliderMax(show)
                
                cur_layout = document.getElementById("layout-button").value
                // if (cur_layout=="clc"){rerunCLC()}
            }


            //Add loader to showing direct linkers
            function run_hide_edges() {
                const status = document.querySelector('#direct_loading');
                const loader = document.querySelector('#direct_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        hide_edges(hide, show, showl);
                        if (hide) {
                            hide = false
                        } else {
                            hide = true
                        }
                        resolve();
                    },ms)
                  })
                }
                if (hide) {
                    status.innerHTML = "Hiding edges...";
                } else {
                    status.innerHTML = "Showing edges...";
                }
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
                  
                  
            function hide_orphans(hideo=false) {
                var cur_layer = document.getElementById("layer-button").value 
                if (hideo) {
                    cy.nodes().filter(function(ele){
                        return((ele.connectedEdges(":visible").size() === 0) && 
                               (ele.data("layer")==cur_layer) && 
                               (ele.data("type") == "Query")
                              )
                    }).style("display", "none")
                }  else {
                    cy.nodes().filter(function(ele){
                        return((ele.connectedEdges(":visible").size() === 0) && 
                               (ele.data("layer")==cur_layer) && 
                               (ele.data("type") == "Query")
                              )
                    }).style("display", "element")
                }
                resetSliderMax(show)
                
                cur_layout = document.getElementById("layout-button").value
                // if (cur_layout=="clc"){rerunCLC()}
            }


            //Add loader to showing direct linkers
            function run_hide_orphans() {
                const status = document.querySelector('#direct_loading');
                const loader = document.querySelector('#direct_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        hide_orphans(hideo);
                        if (hideo) {
                            hideo = false
                        } else {
                            hideo = true
                        }
                        resolve();
                    },ms)
                  })
                }
                if (hideo) {
                    status.innerHTML = "Hiding query orphans...";
                } else {
                    status.innerHTML = "Showing query orphans...";
                }
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
                  
                  
            function hide_unlinked(hideul=false) {
                var cur_layer = document.getElementById("layer-button").value 
                if (hideul) {
                    cy.nodes("[type = 'Linker']").filter(function(ele){
                        return (ele.neighborhood("node[type = 'Query']")).length < 2
                    }).style("display", "none")
                    
                }  else {
                    cy.nodes("[type = 'Linker']").filter(function(ele){
                        return (ele.neighborhood("node[type = 'Query']")).length < 2
                    }).style("display", "element")
                }
                resetSliderMax(show)
                
                cur_layout = document.getElementById("layout-button").value
                // if (cur_layout=="clc"){rerunCLC()}
            }


            //Add loader to showing direct linkers
            function run_hide_unlinked() {
                const status = document.querySelector('#direct_loading');
                const loader = document.querySelector('#direct_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        hide_unlinked(hideul);
                        if (hideul) {
                            hideul = false
                        } else {
                            hideul = true
                        }
                        resolve();
                    },ms)
                  })
                }
                if (hideul) {
                    status.innerHTML = "Hiding unlinked nodes...";
                } else {
                    status.innerHTML = "Showing unlinked nodes...";
                }
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
                  

            //Set the min value of the thickness filter when switching layers
            function resetSliderMin(layer) {
                var slider = document.getElementById("myRange");
                var input_qty = document.getElementById("quantity");
                if (layer=="reach") {
                    slider.value=2
                    input_qty.value=2
                     slider.min=2
                    input_qty.min=2
                } else {
                    slider.min=1
                    input_qty.min=1
                    slider.value=1
                    input_qty.value=1
                }
            } 
              
            //Set the max value of the thickness filter when switching layers      
            resetSliderMax = function(show) {
                var slider = document.getElementById("myRange");
                var input_qty = document.getElementById("quantity");
                var cur_layer = document.getElementById("layer-button").value
                var sliderR = document.getElementById("myRangeR")
                var input_qtyR = document.getElementById("quantityR")
                var sliderBG = document.getElementById("myRangeBG")
                var input_qtyBG = document.getElementById("quantityBG")
                if (show) {
                    if (cur_layer=="reach") {
                        slider.max = allMax
                        input_qty.max = allMax
                    } else if (cur_layer=="biogrid") {
                        slider.max = allMaxBG
                        input_qty.max = allMaxBG
                    } else if (cur_layer=="union") {
                        slider.max = allMaxUnion
                        input_qty.max = allMaxUnion
                        sliderR.max = maxR
                        input_qtyR.max = maxR
                        sliderBG.max = maxBG
                        input_qtyBG.max = maxBG
                    }
                } else {
                    if (cur_layer=="reach") {
                        slider.max = queryMax
                        input_qty.max = queryMax
                    } else if (cur_layer=="biogrid") {
                        slider.max = queryMaxBG
                        input_qty.max = queryMaxBG
                    } else if (cur_layer=="union") {
                        slider.max = queryMaxUnion
                        input_qty.max = queryMaxUnion
                        sliderR.max = maxR_q
                        input_qtyR.max = maxR_q
                        sliderBG.max = maxBG_q
                        input_qtyBG.max = maxBG_q
                    }
                }
            } 
             
            //Switch between REACH, BG, and union
            function switch_layer() {
                var cur_layer = document.getElementById("layer-button").value;
                var biogrid_eles = cy.elements().filter(function (ele) {
                        return((ele.data("layer")=="biogrid"))
                    })
                var reach_eles =  cy.elements().filter(function (ele) {
                        return((ele.data("layer")=="reach"))
                    })
                var union_eles =  cy.elements().filter(function (ele) {
                        return((ele.data("layer")=="union"))
                    })
                var totalLabel = document.getElementById("totalLabel")
                var indFilter = document.getElementById("IndFilter")
                if (cur_layer=="biogrid") {
                    reach_eles.style("display", "none")
                    union_eles.style("display", "none")
                    biogrid_eles.style("display", "element")
                    totalLabel.style.display = "none"
                    indFilter.style.display="none"
                    if (show) {
                        biogrid_eles.nodes().filter(function(ele) {
                            return(ele.data("type")=="Direct") }).style("display", "none")
                    }
                    document.getElementById("kb_div").style.display = "none"
                    document.getElementById("legend").style.display = "none"
                    document.getElementById("color-scheme").style.display = "none"
                    cy.edges().style('target-arrow-shape', 'none')
                } else if (cur_layer=="reach") {
                    reach_eles.style("display", "element")
                    union_eles.style("display", "none")
                    biogrid_eles.style("display", "none")
                    totalLabel.style.display = "none"
                    indFilter.style.display="none"
                    if (show) {
                        reach_eles.filter(function(ele) {
                            return(ele.data("type")=="Direct") }).style("display", "none")
                    }
                    document.getElementById("kb_div").style.display = "block"
                    document.getElementById("legend").style.display = "none"
                    document.getElementById("color-scheme").style.display = "none"
                    cy.edges().style('target-arrow-shape', 'triangle')
                } else {
                    reach_eles.style("display", "none")
                    union_eles.style("display", "element")
                    biogrid_eles.style("display", "none")
                    totalLabel.style.display = "block"
                    indFilter.style.display="block"
                    if (show) {
                        union_eles.filter(function(ele) {
                            return(ele.data("type")=="Direct") }).style("display", "none")
                    }
                    document.getElementById("kb_div").style.display = "none"
                    document.getElementById("legend").style.display = "block"
                    document.getElementById("color-scheme").style.display = "block"
                    cy.edges().style('target-arrow-shape', 'triangle')
                }
                resetSliderMax(show)
                resetSliderMin(cur_layer)
                var slider = document.getElementById("myRange");
                var threshold=slider.value
                if (cur_layer != "union") {
                    filterEdges(threshold)
                } else {
                    var thresholdR = document.getElementById("quantityR").value;
                    var thresholdBG = document.getElementById("quantityBG").value;
                    console.log("BG: "+thresholdBG+", R: "+thresholdR+", total: "+threshold)
                    filterEdgesUnion(thresholdR, thresholdBG, threshold)                    
                }
                reset_query()
                return true
            }

            
           //Add loader to layer switching       
           function run_switch_layer() {
                const status = document.querySelector('#layer_loading');
                const loader = document.querySelector('#layer_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        switch_layer()
                        rerun_layout()
                        resolve();
                    },ms)
                  })
                }
                status.innerHTML = "Loading network...";
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
             
             function run_fCose(idealEL, nodeRep=1e9) {
               var eles = cy.elements().filter(function (ele) {
                    return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
                }); 
                var layout = eles.layout({
                    name: 'fcose',
                    
                    nodeRepulsion: node => nodeRep,
                    idealEdgeLength: edge => idealEL,
                    gravity: 1e-5,
                      gravityRangeCompound: 1e-5,
                      gravityCompound: 1e-5,
                      gravityRange: 1e-5
                }) 
                layout.run();
            }
            
            
             // pass parameter to signify BIOGRID or reach layer?
             function run_lc(){
                 var all_nodes = cy.nodes();    // Filter by {layer}?
                 var eles = cy.elements();    // Filter by {layer}?
                 
                 for (var i=0; i<all_nodes.length; i++) {
                     var curr_node = all_nodes[i]
                     curr_node.positions({
                         x: curr_node.data("lcX"),
                         y: curr_node.data("lcY")
                     });
                 }
             
                 var layout = eles.layout({name: "preset"});
                 layout.run();
             }


             // pass parameter to signify BIOGRID or reach layer?
             function run_clc(){
                 all_nodes = cy.nodes();
                 eles = cy.elements();
                 
                 for (var i=0; i<all_nodes.length; i++) {
                     var curr_node = all_nodes[i]
                     curr_node.positions({
                         x: curr_node.data("clcX"),
                         y: curr_node.data("clcY")
                     });
                 }
             
                 var layout = eles.layout({name: "preset"});
                 layout.run();
             }

        let tc_scheme = true
        function run_change_scheme() {
            const status = document.querySelector('#layer_loading');
            const loader = document.querySelector('#layer_loader');
            
            const wait = (ms = 5000) => {
                return new Promise((resolve) => {
                setTimeout(() => {
                    change_scheme(tc_scheme);
                    if (tc_scheme) {
                        tc_scheme = false
                    } else {
                        tc_scheme = true
                    }
                    resolve();
                },ms)
              })
            }
            
            if (tc_scheme) {
                status.innerHTML = "Coloring by dataset...";
            } else {
                status.innerHTML = "Coloring by evidence...";
            }
            
            loader.classList.toggle('tc_scheme', true);
            wait(500)
            .then(() => {
                status.innerHTML = "";
                loader.classList.toggle('tc_scheme', false);
            })
        }

        function change_scheme(tc_scheme=true){
            var cur_layer = document.getElementById("layer-button").value 
            if (tc_scheme) {
                cy.edges().style("line-color", function (ele) { return ele.data("dataset_color"); })
                cy.edges().style("target-arrow-color", function (ele) { return ele.data("dataset_color"); })
            
            } else {
                cy.edges().style("line-color", function (ele) { return ele.data("color"); })
                cy.edges().style("target-arrow-color", function (ele) { return ele.data("color"); })
            }
        }
                  
        // Add listener to dynamically created buttons
        document.addEventListener("click", function(e){
        const target = e.target.closest("#btn_el"); // Or any other selector.

        if(target){
          target.classList.toggle("active");
          var content = target.nextElementSibling;
          if (content.style.maxHeight){
            content.style.maxHeight = null;
          } else {
            content.style.maxHeight = content.scrollHeight + "px";
          }
        }
        });


        </script>

    </body>
</html>
