<!doctype html>
<html lang="en">

    
    <head>
        <meta charset="utf-8">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.18.2/cytoscape.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type=text/javascript>
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.3.2/cytoscape-dagre.min.js"></script>
        <script src="https://unpkg.com/layout-base@1.0.2/layout-base.js"></script>
        <script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
        <script src="https://unpkg.com/cose-base@1.0.3/cose-base.js"></script>
        <script src="https://unpkg.com/cytoscape-graphml/cytoscape-graphml.js"></script>
        <script src="https://raw.githack.com/iVis-at-Bilkent/cytoscape.js-layvo/unstable/cytoscape-layvo.js"></script>
        <script src="{{url_for('static', filename='cytoscape.js-cise/cytoscape-cise.js')}}"></script>
        <script src="{{url_for('static', filename='cytoscape-no-overlap/cytoscape-no-overlap.js')}}"></script>
        <script src="https://unpkg.com/layout-base/layout-base.js"></script>
        <script src="https://unpkg.com/cose-base/cose-base.js"></script>
        <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
        <script src="https://unpkg.com/layout-base/layout-base.js"></script>
        <script src="https://unpkg.com/cose-base/cose-base.js"></script>
        <title>Result</title>
    </head>
    <style>
        #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
        background: #a6a6a6;
        z-index: -1;
        }
        .modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        /* Stay in place */
        z-index: 1;
        /* Sit on top */
        padding-top: 100px;
        /* Location of the box */
        left: 0;
        top: 0;
        width: 100%;
        /* Full width */
        height: 100%;
        /* Full height */
        overflow: auto;
        /* Enable scroll if needed */
        background-color: rgb(0, 0, 0);
        /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4);
        /* Black w/ opacity */
        }
        /* Modal Content */
        .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        font-family: Arial, Helvetica, sans-serif;
        }
        .modal-body {
        max-height: calc(100vh - 210px);
        overflow-y: auto;
        }
        .circle {
        width: 300px;
        height: 200px;
        line-height: 200px;
        border-radius: 50%;
        font-size: 12px;
        color: #000;
        text-align: top;
        background: #000
        }
        .loader {
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #4CAF50;
        width: 25px;
        height: 25px;
        animation: spin 2s linear infinite;
        opacity: 0;
        }
        .loading {
        color:#4CAF50
        }
        .loader.show {
        opacity: 1;
        }
        @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }
        /* The Close Button */
        .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        }
        .close:hover,
        .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
        }
        #menuDiv {
        padding: 0px 20px 20px 0px
        }
        #posEv {
        float: left;
        padding-right: 20px;
        width: 33%;
        font-size: large;
        }
        #negEv {
        float: left;
        width: 33%;
        padding-right: 20px;
        font-size: large;
        }
        #incEv {
        float: right;
        width: 33%;
        font-size: large;
        }
        #posThickness {
        float: left;
        width: 33%;
        padding-bottom: 10px;
        }
        #negThickness {
        float: left;
        width: 33%;
        padding-bottom: 10px;
        }
        #incThickness {
        float: right;
        width: 33%;
        padding-bottom: 10px;
        }
        dl{height:200px;}
        dl{overflow:hidden; overflow-y:scroll;}
        ul {
        list-style: none;
        }
        .itemconfiguration
        {
            height:300px;
            /* background-color:#CCC; */	
            overflow:hidden;
            overflow-y:scroll;
            border:1px solid lightgrey;
            margin-bottom:5px;
        }
        .matchDiv
        {
            padding-left:10px
        }
        label {
          margin-left: 5px;
        }

</style>



    <body>

        <div id="floatParent">
        <div id="cy"></div>
        <div class="w3-sidebar w3-bar-block w3-border-right" style="display:block;width:30%" id="mySidebar">
            <button onclick="w3_close()" class="w3-bar-item w3-large">Close &times;</button>
            <form id="queryForm" method="POST" action="{{ url_for('go_home') }}">
                <p><input class="w3-bar-item w3-button w3-border-bottom" style="color:#4CAF50;" type="submit" value="Return to Homepage" /></p>
            </form>
            <div style="padding:20px;padding-top:0px">
                <h2 style="padding-bottom:10px;">Details</h2>
                <h6>
                    Click on connections between nodes to see the evidence for that connection. <br> <br>
                    Mouseover nodes to see only the nodes that the node directly targets. <br> <br>
                    Red, blue, and white edges indicate down, up, and inconclusive relationships, respectively.
                    Details found in README. <br> <br>
                    Click the <span class=".reload;">&#x21bb;</span> icon to reload the visualization after making
                    adjustments.
                </h6>
            </div>
            
            <hr>
            
            <div style="padding-left:20px;padding-bottom:20px" class="slidecontainer">
                <h2 style="padding-bottom:10px;">Parameters</h2>
                <h6>Filter by thickness:</h6>
                <input type="range" min="1" value="1" class="slider" id="myRange" style="width:50%;margin-left:20px">
                <form action="#" id="input_thickness" style="display:inline;">
                    <input type="number" id="quantity" min="1" style="width:15%" value="1">
                    <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
                </form>

                <ul class="nav">
                    <li style="display:inline">
                        <div class="loading" id="filter_loading"></div>
                    </li>
                    <li style="display:inline">
                        <div id="filter_loader" class="loader"></div>
                    </li>
                </ul>
            </div>
            
            
            <div style="padding-left:20px;">
                <h6>Search for a node:</h6>
                <form action="#" id="node_search" style="display:inline;">
                    <input type="text" id="node_name" style="width:66%;margin-left:20px;">
                    <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
                </form>
                <button id="reset" onclick="reset_query()" class="btn btn-primary" style="display:none;background-color:#4CAF50;"><span class=reload>&#171;</span></button>
                <p style="color:grey;margin-left:20px;">Current search: <span id="current_query">None</span></p>
            </div>
            
             <div style="padding-left:20px;padding-bottom:20px">
                <h6>Find all paths between two nodes:</h6>
                <form action="#" id="path_finding" style="display:inline;">
                    <div style="float:left;padding-left:20px">
                        <input id="node1" name="path" type="text" placeholder="Node 1" style="width:95%">
                    </div>
                    <div style="float:left;padding-right:5px">
                        <p>to</p>
                    </div>
                    <div style="float:left">
                        <input id="node2" name="path" type="text" placeholder="Node 2" style="width:95%">
                    </div>
                    <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;display:inline"><span class="reload">&#x21bb;</span></button>
                </form>
                <button id="reset_path" onclick="reset_query()" class="btn btn-primary" style="display:none;background-color:#4CAF50;"><span class=reload>&#171;</span></button> 
                 <div style="width:100%; clear:both;">
                    <p style="color:grey;margin-left:20px;">Current path: <span id="current_path">None</span></p>
                </div>
            </div>
        
            
          <div style="padding-left:20px;" class="slidecontainer">
              <h6>Filter by knowledge base:</h6>
              
                <form id="kb_form" action="#" style="width:82%;">
                  <dl style="border:1px solid lightgrey;margin-left:20px;margin-bottom:5px;">

                     <dt style="margin-left:10px;padding-top:10px">
                          <input class="allCheckbox" id="all_prot" value="all_prot" type="checkbox" />
                          <label class="allLabel" for="all_prot" style="margin-left:5px">Genes/proteins</label>
                      </dt>

                     <dd>
                        <ul>
                           <li>
                              <input class="messageCheckbox" id="uniprot" value="uniprot" type="checkbox"/>
                              <label for="uniprot" style="margin-left:5px">Uniprot</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="fplx" value="fplx" type="checkbox" />
                              <label for="fplx" style="margin-left:5px">FamPlex</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="PR" value="PR" type="checkbox" />
                              <label for="PR" style="margin-left:5px">PR</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="interpro" value="interpro" type="checkbox" />
                              <label for="interpro" style="margin-left:5px">Interpro</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="pfam" value="pfam" type="checkbox" />
                              <label for="pfam" style="margin-left:5px">Pfam</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px">
                          <input class="allCheckbox" id="all_chem" value="all_chem" type="checkbox" />
                          <label class="allLabel" for="all_prot" style="margin-left:5px">Chemicals</label>
                     </dt>

                     <dd>
                        <ul>
                           <li>
                              <input class="messageCheckbox" id="CHEBI" value="CHEBI" type="checkbox" />
                              <label for="CHEBI" style="margin-left:5px">CHEBI</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="pubchem" value="pubchem" type="checkbox" />
                              <label for="pubchem" style="margin-left:5px">PubChem</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px">Cellular events</dt>

                     <dd>
                        <ul>
                           <li>
                              <input class="messageCheckbox" id="GO" value="GO" type="checkbox" />
                              <label for="GO" style="margin-left:5px">GO</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px" style="margin-left:5px">Diseases</dt>

                     <dd>
                        <ul>
                           <li>
                              <input class="messageCheckbox" id="mesh" value="mesh" type="checkbox" />
                              <label for="mesh" style="margin-left:5px">Mesh</label>
                           </li>
                        </ul>
                     </dd>
                  </dl>

                <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;float:right;margin-bottom:20px;"><span class=reload>&#x21bb;</span></button>
            </form>
          <br><br>
          </div>
            
            
            <div style="padding-left:20px">
                <h6>Change Layout:</h6>
                <select id="layout-button" onchange="run_switch_layout()" class="form-select"
                    style="margin-left:20px;width:20%;">
                    <option value="CiSE">CiSE</option>
                    <option value="fCose">fCose</option>
                    <option value="Circle">Circle</option>
                    <option value="Grid">Grid</option>
                </select>
                <ul class="nav">
                    <li style="display:inline">
                        <div class="loading" id="layout_loading"></div>
                    </li>
                    <li style="display:inline">
                        <div id="layout_loader" class="loader"></div>
                    </li>
                </ul>
                
                <div style="padding-left:20px;display:none" class="slidecontainer" id="fCose_settings">
                    Adjust node repulsion: <input type="range" min="3" max="18" value="9" class="slider" id="nr_slider">
                    <p>Current node repulsion: <span id="cur_nr"></span></p>
                    <ul class="nav">
                        <li style="display:inline">
                            <div class="loading" id="nr_loading"></div>
                        </li>
                        <li style="display:inline">
                            <div id="nr_loader" class="loader"></div>
                        </li>
                    </ul>
                </div>
                                
                <div style="padding-left:20px" class="slidecontainer" id="cise_settings">
                    Node repulsion: <input type="range" min="3" max="18" value="3" class="slider" id="cise_nr_slider" style="display:inline;">
                    <p style="display:inline;"><span id="cise_cur_nr"></span></p>
                    <p style="color:grey;margin-right:20px">Description: parameter for adjusting internodal distance.</p>
                    <ul class="nav">
                        <li style="display:inline">
                            <div class="loading" id="nr_loading"></div>
                        </li>
                        <li style="display:inline">
                            <div id="nr_loader" class="loader"></div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div style="padding-left:20px">
                
                <h6 style="margin-right:5px;display:inline;">Direct neighbors:</h6>

                <div class="form-check form-switch" style="display:inline;">
                    <input class="form-check-input" type="checkbox" role="switch" id="direct-button" onchange="run_show_direct()" style="display:inline">
                    <label class="form-check-label" for="direct-button" style="display:inline"></label>
                </div>
                <p style="color:grey;margin-right:20px;">Description: Toggle showing direct neighbors to the query nodes. Only edges with >20 thickness are retrieved to limit network size.</p>

                <ul class="nav">
                    <li style="display:inline">
                        <div class="loading" id="direct_loading"></div>
                    </li>
                    <li style="display:inline">
                        <div id="direct_loader" class="loader"></div>
                    </li>
                </ul>
            </div>
            
            <hr>
            
            <div style="padding:20px;padding-top:0px;text-align:center">
                <h6>
                    Note: Inaccuracies should be expected due to errors in the NLP.
                </h6> <br>

                <a href="/getNodes" style="padding-right:20px;">Export nodes (.tsv)</a>
                <a href="/getEdges">Export edges (.tsv)</a>
            </div>
            
        </div>
        <script>
            function w3_open() {
                document.getElementById("mySidebar").style.display = "block";
            }
            
            function w3_close() {
                document.getElementById("mySidebar").style.display = "none";
            }
            
                    $('.allCheckbox').change(function(event) {  
            var proteins = ["uniprot", "fplx", "PR", "interpro", "pfam"]
            var chemicals = ["pubchem", "CHEBI"]
            console.log("checked box")
            if(this.checked) {
                if (this.value=="all_prot") {
                    $(':checkbox').each(function() {
                        console.log(this.value)
                        if (proteins.includes(this.value)) {
                            this.checked = true;
                        }            
                    });
                } else {
                     $(':checkbox').each(function() {
                        if (chemicals.includes(this.value)) {
                            this.checked = true;
                        }            
                    });
                }
                // Iterate each checkbox
            } else {
                if (this.value=="all_prot") {
                    $(':checkbox').each(function() {
                        if (proteins.includes(this.value)) {
                            this.checked = false;
                        }            
                    });
                } else {
                     $(':checkbox').each(function() {
                        if (chemicals.includes(this.value)) {
                            this.checked = false;
                        }            
                    });
                }
            }
        }); 
        </script>
        <button class="w3-button w3-teal w3-xlarge" onclick="w3_open()" style="z-index:2">☰</button>

        <div id="myModal" class="modal">
            <div class="modal-content" style="height:90%;">
                <span class="close">&times;</span>
                
                <div class="modal-header text-center" style="background-color:#a6a6a6;height:120px">
                 <svg  xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
                        <g>
                            <circle id="source" cx="230" cy="75" r="30" />
                            <text id="source_lab" x="230" y="70" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="source_id" x="230" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>
                                        
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 100">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="0" refY="3.5" orient="auto">
                                <polygon id="triangle" points="0 2, 8 3.5, 0 5" />
                            </marker>
                        </defs>
                        
                        <text id="line_lab" dominant-baseline="central" text-anchor="middle" x="138" y="38" font-family="Verdana" font-size="12" fill="black"></text>
                        
                        <line id="line" x1="10" y1="50" x2="270" y2="50" stroke="#000" 
                            stroke-width="8" marker-end="url(#arrowhead)" />
                    </svg>
                    
                    
                    <svg  xmlns="http://www.w3.org/2000/svg" style="overflow: visible">
                        <g>
                            <circle id="target" cx="70" cy="75" r="30" />
                            <text id="target_lab" x="70" y="70" dominant-baseline="central" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="target_id" x="70" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>
            </div>
                
                <div id="modalBody" class="modal-body">
                    <h1 id="thickness" style="font-family: Arial, Helvetica, sans-serif"></h1>
                    <h2 id="posThickness"></h2>
                    <h2 id="negThickness"></h2>
                    <h2 id="incThickness"></h2>
                    <div id="posEv"></div>
                    <div id="negEv"></div>
                    <div id="incEv"></div>
                </div>
                
            </div>
        </div>

        <div id="synModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="modal-header">
                    <h1 id="synLabel" style="font-family: Arial, Helvetica, sans-serif">Synonyms:</h1>
                    <button id="markovButton" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px">Get Markov neighbors</button>
                </div>
                <div id="modalBody" class="modal-body">
                    <h2 id="synList"></h2>
                </div>
            </div>
        </div>
        <div id="warnModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="modalBody" class="modal-body">
                    <h2>Your query generated a large graph, so only edges with thickness > 20 are included</h2>
                </div>
            </div>
        </div>
            
        <div id="searchModal" class="modal" style="width:30%;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="modal-header">
                    <h1 id="synLabel" style="font-family: Arial, Helvetica, sans-serif">Select match:</h1>
                </div>
                <div id="modalBody" class="modal-body">
                    <form id="matchForm" action="#" >
                        <div class="itemconfiguration" id="matchOptions"></div>
                         <button type="submit" id="submitMatch" class="btn btn-primary" style="background-color:#4CAF50;float:right"><span class=reload>&#x21bb;</span></button>
                    </form>
                </div>
            </div>
        </div>
            
       <div id="pathModal" class="modal" style="width:30%;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="modal-header">
                    <h1 id="synLabel" style="font-family: Arial, Helvetica, sans-serif">Select matches:</h1>
                </div>
                <div id="modalBody" class="modal-body">
                    <form id="pathForm" action="#" >
                        <h6>Node 1:</h6>
                        <div class="itemconfiguration" id="options1"></div>
                        <h6>Node 2:</h6>
                        <div class="itemconfiguration" id="options2"></div>
                         <button type="submit" id="submitPath" class="btn btn-primary" style="background-color:#4CAF50;float:right"><span class=reload>&#x21bb;</span></button>
                    </form>
                </div>
            </div>
        </div>


        <script src="{{url_for('static', filename='bfs_vis_functions.js')}}"></script>
        <script>
            const data = {{ elements | tojson }};
            var cy = cytoscape({
                wheelSensitivity: 0.1,
                container: document.getElementById('cy'),
                elements: data,
                boxSelectionEnabled:true,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            "text-valign": "center",
                            "text-halign": "center",
                            "background-color": "data(color)",
                            "text-outline-color": "#555",
                            "text-outline-width": "2px",
                            "color": "#080707",
                            width: function (ele) { return Math.min((Math.max(80, ele.degree() + 2) * 2), 500); },
                            height: function (ele) { return Math.min((Math.max(80, ele.degree() + 2) * 2), 500); },
                            "font-size": function (ele) { return Math.min((Math.log2(ele.degree() + 2) * 25), 350); },
                            'background-fit': 'contain',
                            'background-clip': 'none',
                            "display": "data(display)",
                            "display_id":"data(display_id)"
            
                        },
                        position: {
                            x: "data(position)",
                            y: "data(position)"
                        }
                    }, {
                        selector: 'edge',
                        style: {
            
                            'text-background-color': 'yellow',
                            'text-background-opacity': 0.4,
                            'target-arrow-shape': 'triangle',
                            'control-point-step-size': '140px',
                            'curve-style': 'bezier',
                            'control-point-step-size': 300,
                            'line-color': "#fcfafa",
                            'target-arrow-color': '#fcfafa',
                            "overlay-opacity": "0.1",
                            "display": "data(display)",
                            'width': 'data(weight)',
                            'line-color': "data(color)",
                            'target-arrow-color': "data(color)"
                        }
                    },
                    
                     {
                        selector: 'node.semitransp',
                        style: { 'opacity': '.1' }
                    },
                    {
                        selector: 'edge.semitransp',
                        style: { 'opacity': '.1' }
                    },
                    {
                        selector: 'node.transp',
                        style: {
                            'opacity': '0',
                            'events': 'no'
                        }
                    },
                    {
                        selector: 'edge.transp',
                        style: { 'opacity': '0',
                               'events': 'no'}
                    },
                    {
                        selector: 'node.markov',
                        style: { 'background-color': "#26ff12" }
                    },
                    {
                        selector: 'node.large',
                        style: {
                            'font-size': 200
                        }
                    },
                    {
                        selector: 'node.searched',
                        style: {
                            'background-color': "#26ff12"
                        }
                    },
                    {
                        selector: 'edge.searched',
                        style: {
                            'line-color': "#26ff12",
                            'target-arrow-color':"#26ff12"
                        }
                    },
                    {
                        selector: 'edge.mouseover',
                        style: {
                            'line-color': "#26ff12",
                            'target-arrow-color':"#26ff12"
                        }
                    },
                    {
                        selector: 'edge.colors',
                        style: {
                            'line-color': "data(color)",
                            'target-arrow-color': "data(color)"
                        }
                    },
                    {
                    selector: 'node.mouseup',
                    style: { 'border-width': 10,
                      'border-color': 'yellow' }
                }
            
                ]
            })
                

            run_cise()
            
            findNode = function(arr, node) {
                for (var i=0; i<arr.length; i++) {
                    var eles = arr[i] 
                    console.log("eles length: "+eles.length)
                    if (eles.contains(node)) {
                        return i
                    }
                }
            };
            
            var in_clust=false
            var non_neighbors = []
            markov_clust = function(node) {
                var clusters = cy.elements().filter(function(ele) {
                    return ((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0")) }).markovClustering({
                    inflateFactor:5,
                  attributes: [
                    function( edge ){ return edge.data('thickness'); }
                  ]
                });
                var ind = findNode(clusters, node)
                var neighbors = clusters[ind]
                console.log("neighbors len"+neighbors.length)
                neighbors.addClass("markov")
            }
            
            {% if filtered %}
                const filtered = true
            {% else %}
                const filtered = false
            {% endif %}
            console.log("filtered: "+filtered)
            if (filtered) {
                var modal = document.getElementById("warnModal");
                var span = document.getElementsByClassName("close")[2];
                modal.style.display = "block";
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        var modalBody = document.getElementById("modalBody");
                        modalBody.scrollTop = 0;
                        modal.style.display = "none";
                    }
                }
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }
            } 
            
            var currently_querying = false
            
            cy.on('mouseover', 'node', function (evt) {
                if (!currently_querying) {
                   var sel = evt.target;
                    console.log(sel.degree());
                    console.log(sel.data("KB"));
                    sel.addClass('large');
                    var neighbors = sel.outgoers().union(sel.incomers());
                    cy.nodes().difference(neighbors).not(sel).addClass('semitransp');
                    cy.edges().difference(sel.edgesWith(neighbors)).addClass("semitransp"); 
                }
                console.log(sel.indegree())
            });
            
            cy.on('mouseover', 'edge', function (evt) {
                   var sel = evt.target;
                    if (sel.style()["opacity"] != "0") {
                        sel.addClass('mouseover');
                    }
            });
            
            cy.on('mouseout', 'node', function (evt) {
                if (!currently_querying) {
                    var sel = evt.target;
                    sel.removeClass('large');
                    var neighbors = sel.outgoers().union(sel.incomers());
                    cy.nodes().difference(neighbors).not(sel).removeClass('semitransp');
                    cy.edges().difference(sel.edgesWith(neighbors)).removeClass("semitransp");
                }
            
            });
            
            cy.on('mouseout', 'edge', function (evt) {
                   var sel = evt.target;
                    sel.removeClass('mouseover');
            });


                   cy.on('click', 'edge', function (evt) {
                var sel = evt.target;
                console.log(sel.data().files);
            
                function getEvidence() {
                    var retval;
                    $.ajaxSetup({
                        async: false
                    });
                    $(function() {
                      $.getJSON($SCRIPT_ROOT + '/_get_evidence', {
                        files:sel.data().files
                      }, function(data) {
                          console.log(data.result);
                          retval = data.result;
                          return false;
                      });
                    });
                    console.log(retval);
                    return retval;
                }
            
                var ev = getEvidence();
                console.log(ev);
            
                var modal = document.getElementById("myModal");
                var triangle = document.getElementById("triangle");
                var line = document.getElementById("line");
                var src_node = document.getElementById("source");
                var source_lab = document.getElementById("source_lab");
                var tar_node = document.getElementById("target");
                var target_lab = document.getElementById("target_lab");
                var line_lab = document.getElementById("line_lab");
                var source_id_lab = document.getElementById("source_id")
                var target_id_lab = document.getElementById("target_id")
                
                var sel_source = sel.source();
                var sel_target = sel.target();
                       
                var source = sel_source.data().label;
                var source_id = sel_source.data().display_id;
                var target = sel_target.data().label;
                var target_id = sel_target.data().display_id;

                var src_lab = "("+source_id+")"
                var tar_lab = "("+target_id+")"

                source_lab.innerHTML = source
                target_lab.innerHTML = target
                source_id_lab.innerHTML = src_lab
                target_id_lab.innerHTML = tar_lab
                       
                src_node.parentNode.appendChild(source_id_lab);

                <!-- Visualize clicked edge/nodes -->                


                src_node.style.fill = sel.source().data().color;

                tar_node.style.fill = sel.target().data().color;
                
                triangle.style.fill = sel.data().color;
                line.style.stroke = sel.data().color;

                var span = document.getElementsByClassName("close")[0];
                var thickness = document.getElementById("thickness");
                var ev_split = ev.split("%%");
                var ev_length = ev_split.length;
                line_lab.innerHTML = "Total mentions: " + ev_length;

                var ul_pos = document.createElement("ul");
                var ul_neg = document.createElement("ul");
                var ul_inc = document.createElement("ul");
                var negCount = 0;
                var posCount = 0;
                var incCount = 0;
                for (var i = 0; i < ev_split.length; i++) {
                    // Create the list item:
                    var item = document.createElement('li');
                    var cont = document.createElement("div");
            
                    var parts = ev_split[i].split("|");
                    var text = parts[0];
                    var act = parts[1];
            
            
                    // Set its contents:
                    item.appendChild(document.createTextNode(text));
                    cont.appendChild(item)
                    if (act === "Activation (Negative)") {
                        cont.style.color = "red";
                        negCount = negCount += 1;
                    } else if (act === "Activation (Positive)") {
                        cont.style.color = "blue";
                        posCount = posCount += 1;
                    }
                    else {
                        cont.style.color = "black";
                        incCount = incCount += 1;
                    }
            
                    cont.style.padding = "0px 0px 20px 0px";

                    // Add it to the list:
                    if (act === "Activation (Positive)") {
                        ul_pos.appendChild(cont);
                    } else if (act === "Activation (Negative)") {
                        ul_neg.appendChild(cont);
                    } else {
                        ul_inc.appendChild(cont);
                    }
            
                }

                function createFiller() {
            
                    var fillerText = document.createElement("li");
                    var fillerCont = document.createElement("div");
            
                    fillerText.appendChild(document.createTextNode("This is filler text"));
                    fillerCont.appendChild(fillerText);
                    fillerCont.style.padding = "0px 20px 0px 0px";
                    fillerCont.style.color = "white";
                    return fillerCont;
                }
            
                var fillerPos = createFiller();
                var fillerNeg = createFiller();
                var fillerInc = createFiller();
                ul_pos.appendChild(fillerPos);
                ul_neg.appendChild(fillerNeg);
                ul_inc.appendChild(fillerInc);
            
                document.getElementById("posThickness").innerHTML = "Positive: " + posCount;
                document.getElementById("negThickness").innerHTML = "Negative: " + negCount;
                document.getElementById("incThickness").innerHTML = "Inconclusive: " + incCount;
                document.getElementById("posEv").innerHTML = ul_pos.innerHTML;
                document.getElementById("negEv").innerHTML = ul_neg.innerHTML;
                document.getElementById("incEv").innerHTML = ul_inc.innerHTML;
                modal.style.display = "block";
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        var modalBody = document.getElementById("modalBody");
                        modalBody.scrollTop = 0;
                        modal.style.display = "none";
                    }
                }
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }
            });
            
             
            cy.on('click', 'node', function (evt) {
                var sel = evt.target;
                console.log("selectable: "+sel.selectable())
                var modal = document.getElementById("synModal");
                var synLabel = document.getElementById("synLabel");
                synLabel.innerHTML = "Synonyms for "+sel.data("label")+":"
                var span = document.getElementsByClassName("close")[1];
                var syn = sel.data().syn;
                var syn_split = syn.split("%%");
                syn_split = [...new Set(syn_split)];
                var syn_list = document.createElement("ul")
                for (var i = 0; i < syn_split.length; i++) {
                    // Create the list item:
                    var item = document.createElement('li');
                    var cont = document.createElement("div");
            
                    var text = syn_split[i];
            
                    // Set its contents:
                    item.appendChild(document.createTextNode(text));
                    cont.appendChild(item)
                    cont.style.padding = "0px 0px 20px 0px";
            
                    // Add it to the list:
                    syn_list.appendChild(cont);
                }
            
                document.getElementById("synList").innerHTML = syn_list.innerHTML;
                modal.style.display = "block";
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        var modalBody = document.getElementById("modalBody");
                        modalBody.scrollTop = 0;
                        modal.style.display = "none";
                    }
                }
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }
                
                var markovButton = document.getElementById("markovButton");
                markovButton.onclick = function() {
                    in_clust = true
                    markov_clust(sel)
                    modalBody.scrollTop = 0;
                    modal.style.display="none"
                }
            });
             
            
            cy.on('box', function (evt) {
                 var sel = evt.target
                 console.log(sel.length)
                 sel.filter(function(ele) {return((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"))}).addClass("mouseup")
            }); 
             
            
             cy.on('tap', function(event){
              // target holds a reference to the originator
              // of the event (core or element)
              var evtTarget = event.target;
            
              if( evtTarget === cy ){
                cy.nodes().removeClass("mouseup")
              } 
                 cy.nodes().removeClass("markov")
                 
            }); 

         
         function getSelectValues(select) {
              var result = [];
              for (var i=0, iLen=select.length; i<iLen; i++) {
                var opt = select[i];
                if (opt.checked) {
                  result.push(opt.value);
                }
              }
              return result;
        }
        
        var kb_form =  document.getElementById("kb_form");
        var selected_kbs = []
        kb_form.onsubmit = function() {
            console.log("submitted")
            var slider = document.getElementById("myRange");
            var threshold=slider.value
            var kb_select = document.getElementsByClassName('messageCheckbox');
            selected_kbs = getSelectValues(kb_select);
            console.log("selected kbs: "+selected_kbs)
            filterKBs(selected_kbs)
            console.log("KB filter threshold: "+threshold)
            filterEdges(threshold)
            return false
        } 
         
             
             
            function getMaxWeight(allEdges) {
                var weight_arr = []
                for (var i = 0; i < allEdges.length; i++) {
                    var edgeData = (allEdges[i]).data()
                    var weight = edgeData.thickness
                    weight_arr.push(weight)
                }
                Array.prototype.max = function() {
                  return Math.max.apply(null, this);
                };
                var maxWeight = weight_arr.max()
                return(maxWeight)
            }
            
            
            
            var filteredEdges = cy.edges().filter('[thickness < 0]');
            var filteredNodes = cy.nodes().filter(function (ele) {
                return ele.degree() == -2;
            });
            filteredEdges = cy.remove(filteredEdges);
            filteredNodes = cy.remove(filteredNodes);
            
            var slider = document.getElementById("myRange");
            var queryEdges = cy.edges().filter(function (ele) {
                return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
            });
            var allEdges = cy.edges()    
            var queryMax = Math.ceil(getMaxWeight(queryEdges))
            var allMax = Math.ceil(getMaxWeight(allEdges))
            slider.max = queryMax
            var input_qty = document.getElementById("quantity");
            input_qty.max = queryMax
            var output = document.getElementById("quantity");
            output.innerHTML = slider.value;
            var input_thickness = document.getElementById("input_thickness") 
            slider.oninput = function () {
                threshold = this.value;
                run_filter_edges(threshold)
                console.log("slider selected kbs: "+selected_kbs)
                filterKBs(selected_kbs)
                output.innerHTML = this.value;
                input_qty.value = this.value
            }
            input_thickness.onsubmit = async function () {          
                var thickness_val = document.getElementById("quantity");
                var threshold = thickness_val.value;
                run_filter_edges(threshold)
                filterKBs(selected_kbs)
                output.innerHTML = threshold
                slider.value=threshold
            }
             
            function updateOptions(ele_id, search, nodes, name="match") {
                var options = document.getElementById(ele_id)
                options.innerHTML=""
                for (var i=0; i<nodes.length; i++) {
                    var sel = nodes[i]
                    var syn = sel.data().syn;
                    if (syn.includes(search)) {
                        var cont = document.createElement("div");
                        cont.setAttribute("class", "matchDiv")
                        var header = document.createElement("input");
                        header.setAttribute('value', sel.id());
                        header.setAttribute('type', 'radio');
                        header.setAttribute('name', name);
                        header.setAttribute("id", sel.id());
                        cont.appendChild(header)
                        var newlabel = document.createElement("Label");
                        newlabel.setAttribute("for",sel.id());
                        var labelText = sel.data().label + " ("+sel.data().display_id+")"
                        newlabel.innerHTML = labelText
                        cont.appendChild(newlabel)
                        var syn_split = syn.split("%%");
                        syn_split = [...new Set(syn_split)];
                        var syn_list = document.createElement("ul")
                        for (var j = 0; j < syn_split.length; j++) {
                            var item = document.createElement('li');
                            var subcont = document.createElement("div");
                            var text = syn_split[j];
                            if (text.includes(search)) {
                                item.appendChild(document.createTextNode(text));
                                subcont.appendChild(item)
                                subcont.style.padding = "0px 0px 20px 0px";
                                syn_list.appendChild(subcont);
                            }   
                        }
                        cont.appendChild(syn_list)
                        options.appendChild(cont)
                    }
                }
            }
            
            var node_search = document.getElementById("node_search");
            var current_query = document.getElementById("current_query");
            var reset_button = document.getElementById("reset");
            node_search.onsubmit = function () {
                var modal = document.getElementById("searchModal")
                var span = document.getElementsByClassName("close")[3];
                reset_button.style="background-color:#4CAF50;"
                //cy.nodes().removeClass("transp");
                cy.edges().removeClass("transp");
                cy.nodes().removeClass("searched");
                var node_name = document.getElementById("node_name");
                var search = node_name.value
                var nodes = cy.nodes().filter(function(ele) {return((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0"))})
                
                updateOptions("matchOptions", search, nodes)
        
                modal.style.display = "block";
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        var modalBody = document.getElementById("modalBody");
                        modalBody.scrollTop = 0;
                        modal.style.display = "none";
                    }
                }
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }

                return false
            }
             
            
            var matchForm = document.getElementById("matchForm")
            matchForm.onsubmit = function() {
                var choice = document.querySelector('input[name="match"]:checked').value;
                var results_nodes = cy.nodes().filter(function(ele) {
                    return ((ele.id() === choice));})
                var cq =  results_nodes.data().label + " ("+results_nodes.data().display_id+")"
                current_query.innerHTML = cq; 
                results_nodes.addClass('searched')
                var neighbors = results_nodes.outgoers().union(results_nodes.incomers());
                var results_edges = results_nodes.connectedEdges()
                var results_nodes = results_nodes.union(neighbors)
                cy.nodes().difference(results_nodes).addClass('transp');
                cy.edges().difference(results_edges).addClass('transp');
                var modal = document.getElementById("searchModal")
                var modalBody = document.getElementById("modalBody");
                modalBody.scrollTop = 0;
                modal.style.display = "none";
                return false
            }
             
            var path_finding =  document.getElementById("path_finding");
            path_finding.onsubmit = function() {
                var modal = document.getElementById("pathModal")
                var span = document.getElementsByClassName("close")[4];
                
                //cy.nodes().removeClass("transp");
                cy.edges().removeClass("transp");
                cy.edges().removeClass("searched");
                cy.nodes().removeClass("searched");
                
                var node1 = document.getElementById("node1").value
                var node2 = document.getElementById("node2").value
                
                var nodes = cy.nodes().filter(function(ele) {return((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0"))})
                
                updateOptions("options1", node1, nodes, "options1")
                updateOptions("options2", node2, nodes, "options2")
                
               modal.style.display = "block";
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        var modalBody = document.getElementById("modalBody");
                        modalBody.scrollTop = 0;
                        modal.style.display = "none";
                    }
                }
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }

                return false
            }
            
             function findPaths(src,dest) {
                let successors = src.successors();
                let predecessors = dest.predecessors();
                return successors.intersection(predecessors);
            }
             
            var pathForm = document.getElementById("pathForm")
            var current_path = document.getElementById("current_path")
            var reset_path = document.getElementById("reset_path")
            pathForm.onsubmit = function() {
                reset_path.style="background-color:#4CAF50;"
                var choice1 = document.querySelector('input[name="options1"]:checked').value;
                var choice2 = document.querySelector('input[name="options2"]:checked').value;
                
                var node1 = cy.nodes().filter(function(ele) {
                    return ((ele.id() === choice1));})
                var node2 = cy.nodes().filter(function(ele) {
                    return ((ele.id() === choice2));})
                
                var path =  node1.data().label + " ("+node1.data().display_id+") to "+node2.data().label + " ("+node2.data().display_id+")"
                current_path.innerHTML = path; 
                
                var rootNode = cy.$id(choice1)
                var targetNode = cy.$id(choice2)
                
                //var dijkstra = cy.elements().dijkstra(rootNode);
                //var pathToJ = dijkstra.pathTo(targetNode);
                var pathToJ = findPaths(rootNode, targetNode)
                
                var pathNodes = pathToJ.nodes().filter(function(ele) {return((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0"))})
                console.log("pathNodes length: "+pathNodes.length)
                pathNodes.addClass("searched")
                var pathEdges = pathToJ.edges().filter(function(ele) {return((ele.source().style()["display"] != "none") && 
                            (ele.source().style()["opacity"] != "0") && (ele.target().style()["display"] != "none") &&
                                                                            (ele.target().style()["opacity"] != "0"))})
                pathEdges.addClass("searched")
                
                var modal = document.getElementById("pathModal")
                var modalBody = document.getElementById("modalBody");
                modalBody.scrollTop = 0;
                modal.style.display = "none";
                return false
            }
             
            function reset_query() {
                var node_name = document.getElementById("node_name");
                currently_querying = false;
                cy.nodes().removeClass("transp");
                cy.edges().removeClass("transp");
                cy.nodes().removeClass("searched");
                cy.edges().removeClass("searched")
                var slider = document.getElementById("myRange");
                var threshold=slider.value
                filterEdges(threshold)
                filterKBs(selected_kbs)
                current_query.innerHTML = "None"; 
                current_path.innerHTML = "None"
                node_name.value=""
                document.getElementById("node1").value = ""
                document.getElementById("node2").value = ""
                reset_button.style.display = "None"
                reset_path.style.display="None"
            }
            
            display_loading = async function(elem_id) {
                var elem = document.getElementById(elem_id)
                elem.style.display = "block"
                elem.innerHTML = "Loading"
                return("Promise 1")
            }
            
            hide_loading = async function(elem_id) {
                var elem = document.getElementById(elem_id)
                elem.style.display = "none"
                return("Promise 2")
            }
            
            filterEdges = function(threshold) {
                filteredNodes.removeClass("transp");
                filteredEdges.restore();
            
                filteredEdges = cy.edges().filter('[thickness < ' + threshold + ']');
                filteredEdges = cy.remove(filteredEdges);
                filteredNodes = cy.nodes().filter(function (ele) {
                    return ((ele.degree() == 0) && (ele.data("type") != "Query"));
                });
                filteredNodes.addClass("transp");
                rerun_layout();
            }
            
            var excludedEdges = cy.edges().filter('[thickness < 0]');
            var excludedNodes = cy.nodes().filter(function (ele) {
                return ele.degree() == -2;
            });
            excludedEdges = cy.remove(excludedEdges);
            excludedNodes = cy.remove(excludedNodes);
            filterKBs = function(kb_list) {
                resetKBs()
                if (kb_list.length!=0) {
                    excludedNodes = cy.nodes().filter(function(ele) {
                        return (!((kb_list.includes(ele.data("KB")) && ele.degree()!=0) | ele.data("type")=="Query"))
                    });
                    excludedNodes.addClass("transp");
                    excludedEdges = cy.edges().filter(function(ele) {
                        return ((excludedNodes.includes(ele.source()) | excludedNodes.includes(ele.target())))
                    })
                    excludedEdges = cy.remove(excludedEdges)
                    rerun_layout();                
                }
            } 
            
            resetKBs = function() {
                excludedEdges.restore()
                excludedEdges.style("display", "element")
                excludedNodes.removeClass("transp")
                rerun_layout();
            } 
             
            function run_filter_edges(threshold) {
                const status = document.querySelector('#filter_loading');
                const loader = document.querySelector('#filter_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        filterEdges(threshold)
                        resolve();
                    },ms)
                  })
                }
                status.innerHTML = "Filtering edges...&nbsp;";
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
            
            function switch_layout() {
                var layout = document.getElementById("layout-button");
                if (layout.value === "Circle") {
                    run_circle();
                    document.getElementById("fCose_settings").style.display = "none";
                    document.getElementById("cise_settings").style.display = "none";
                } else if (layout.value === "fCose") {
                    run_fCose(idealEL=iel, nodeRep=nr);
                    document.getElementById("fCose_settings").style.display = "block";
                    document.getElementById("cise_settings").style.display = "none";
                } else if (layout.value=="Grid") {
                    run_grid();
                    document.getElementById("fCose_settings").style.display = "none";
                    document.getElementById("cise_settings").style.display = "none";
                } else {
                    run_cise(nodeRep=cise_nr)
                    document.getElementById("fCose_settings").style.display = "none";
                    document.getElementById("cise_settings").style.display = "block";
                }
            }
            
            function run_run_fcose(idealEL, nodeRep, layout) {
                const status = document.querySelector('#nr_loading');
                const loader = document.querySelector('#nr_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        if (layout=="fCose") {
                            run_fCose(idealEL, nodeRep)
                        } else {
                            run_cise(nodeRep)
                        }
                        resolve();
                    },ms)
                  })
                }
                loader.classList.toggle('show', true);
                status.innerHTML = "Adjusting node repulsion...";
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            } 
            
            var nr_slider = document.getElementById("nr_slider")
            var cur_nr = document.getElementById("cur_nr")
            var nr = 1e9
            if (cy.nodes().filter('[type="Linker"]').length==0) {
                var iel = (cy.nodes().filter('[type="Query"]').length)*10+100
            } else {
                var iel = (cy.nodes().filter('[type="Linker"]').length)/2+100
            }
            cur_nr.innerHTML="1e9"
            nr_slider.value=9
            nr_slider.oninput = function () {
                cur_nr.innerHTML = "1e"+this.value;
                var nr = 10**(this.value);
                var cur_layout = document.getElementById("layout-button").value
                run_run_fcose(idealEL=iel, nodeRep=nr, layout=cur_layout)
            }
             
            var cise_nr_slider = document.getElementById("cise_nr_slider")
            var cise_cur_nr = document.getElementById("cise_cur_nr")
            cise_cur_nr.innerHTML="1e9"
            cise_nr_slider.value=9
             var cise_nr = 1e9
            cise_nr_slider.oninput = function () {
                cise_cur_nr.innerHTML = "1e"+this.value;
                cise_nr = 10**(this.value);
                var cur_layout = document.getElementById("layout-button").value
                run_run_fcose(idealEL=iel, nodeRep=cise_nr, layout=cur_layout)
            }
            
            
            function reset_slider() {
                var cur_layout = document.getElementById("layout-button").value
                if (cur_layout=="fCose") {
                    nr_slider.value=9
                    cur_nr.innerHTML="1e9"
                } else {
                    cise_nr_slider.value=9
                    cise_cur_nr.innerHTML="1e9"
                }
            
            }
            
            function rerun_layout() {
                var layout = document.getElementById("layout-button");
                if (layout.value === "Grid") {
                    run_grid();
                } else if (layout.value === "Circle") {
                    run_circle();
                } else if (layout.value=="fCose") {
                    run_fCose(idealEL=iel, nodeRep=nr);
                } else {
                    run_cise(nodeRep=cise_nr)
                }
            }
            
            function run_switch_layout() {
                const status = document.querySelector('#layout_loading');
                const loader = document.querySelector('#layout_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        switch_layout();
                        resolve();
                    },ms)
                  })
                }
                status.innerHTML = "Rerunning layout...";
                loader.classList.toggle('show', true);
                wait()
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
             
            function getRndInteger(min, max) {
              return Math.floor(Math.random() * (max - min) ) + min;
            } 
             
             
            function make_clust(eles) {
                nodes = eles.nodes().filter("[type='Query']")
                clusters = []
                for (var i=0; i<nodes.length; i++) {
                    node = nodes[i]
                    targets = node.neighborhood('node')
                    clust = [node.id()]
                    for (var j=0; j<targets.length; j++) {
                        t = targets[j]
                        if (t.neighborhood("node").length==1) {
                           clust.push(t.id()) 
                        } else {
                            var max = t.connectedEdges().max(function(ele){
                              return(ele.data("thickness"));
                            });
                            if (node.neighborhood("edge").includes(max.ele)) {
                                clust.push(t.id()) 
                            }
                        }
                        
                    }
                    clusters.push(clust)
                }
                return(clusters)
            } 
             
             function get_weights(edge) {
                 return(edge.data("thickness"))
             }
             
             function run_cise(nodeRep=1e9) {
               /*
                 var eles = cy.elements().filter(function (ele) {
                    return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
                });*/ 
                 var newclusters = make_clust(cy.elements())
                 var layout = cy.layout({
                    name: 'cise',               
                    animate:true,
                            animationEasing: 1,
                            animationDuration: 1,
                            clusters:newclusters,
                            allowNodesInsideCircle: true,
                            nodeRepulsion: nodeRep 
             
                    });
                layout.run();
                setTimeout(() => {  layout.stop(); }, 500);         
            }

            function show_direct(show=true) {
                var slider = document.getElementById("myRange");
                var input_qty = document.getElementById("quantity");
                
                if (show) {
                    cy.edges().filter("[display = 'none']").style("display", "element")
                    cy.nodes().filter("[display = 'none']").style("display", "element")  
                    slider.max = allMax
                    input_qty.max = allMax
                } else {
                    cy.edges().filter("[display = 'none']").style("display", "none")
                    cy.nodes().filter("[display = 'none']").style("display", "none")
                    slider.max = queryMax
                    input_qty.max = queryMax
                }
                threshold = output.innerHTML
                console.log("Edge filter threshold: " + threshold)

                rerun_layout();
                            
                //rerun_layout();
            } 
            
            let show = true
            function run_show_direct() {
                const status = document.querySelector('#direct_loading');
                const loader = document.querySelector('#direct_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        show_direct(show);
                        if (show) {
                            show = false
                        } else {
                            show=true
                        }
                        resolve();
                    },ms)
                  })
                }
                if (show) {
                    status.innerHTML = "Loading direct neighbors...";
                } else {
                    status.innerHTML = "Hiding direct neighbors...";
                }
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
            
            function add_colors() {
                var x = document.getElementById("color-button");
                if (x.innerHTML === "Show Color") {
                    x.innerHTML = "Hide Color";
                    cy.edges().addClass("colors");
                } else {
                    x.innerHTML = "Show Color";
                    cy.edges().removeClass("colors");
                }
            }
            
            function switch_color() {
                var x = document.getElementById("current-color");
                if (x.innerHTML === "Current: Positive interactions") {
                    x.innerHTML = "Current: Negative interactions";
                    cy.edges().removeClass("pos_colors");
                    cy.edges().addClass("neg_colors");
                } else if (x.innerHTML == "Current: Negative interactions") {
                    x.innerHTML = "Current: Inconclusive interactions";
                    cy.edges().removeClass("neg_colors");
                    cy.edges().addClass("inc_colors");
                } else if (x.innerHTML == "Current: Inconclusive interactions") {
                    x.innerHTML = "Current: None";
                    cy.edges().removeClass("inc_colors");
                } else {
                    x.innerHTML = "Current: Positive interactions";
                    cy.edges().addClass("pos_colors");
                }
            }
            
            
            function run_fCose(idealEL, nodeRep=1e9) {
               var eles = cy.elements().filter(function (ele) {
                    return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
                }); 
                var layout = eles.layout({
                    name: 'fcose',
                    
                    nodeRepulsion: node => nodeRep,
                    idealEdgeLength: edge => idealEL,
                    gravity: 1e-5,
                      gravityRangeCompound: 1e-5,
                      gravityCompound: 1e-5,
                      gravityRange: 1e-5
                }) 
                layout.run();
            }
             
             
             function run_fCose(idealEL, nodeRep=1e9) {
               var eles = cy.elements().filter(function (ele) {
                    return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
                }); 
                var layout = eles.layout({
                    name: 'fcose',
                    
                    nodeRepulsion: node => nodeRep,
                    idealEdgeLength: edge => idealEL,
                    gravity: 1e-5,
                      gravityRangeCompound: 1e-5,
                      gravityCompound: 1e-5,
                      gravityRange: 1e-5
                }) 
                layout.run();
            }
            
            //run_fCose(idealEL=iel)
            
             
            
            
            const orig_zoom = cy.zoom()
            function run_circle() {
                var query_orphs = cy.nodes().filter(function (ele) {
                    var neighbors = ele.outgoers().union(ele.incomers());
                    var query_neighbors = neighbors.filter('[type="Query"]')
                    console.log(ele.id()+"query_neighbors")
                    console.log(query_neighbors.length)
                    return ((query_neighbors.length==0) && (ele.data("classes")=="level3"));
                });
                var eles = cy.elements().difference(query_orphs).filter(function (ele) {
                    return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
                });
                var layout = eles.layout({
                         name: 'breadthfirst',
                         grid:true,
                         roots:'node[classes @*="level3"]',
                         maximal:true,
                         circle:true,               spacingFactor:10+eles.nodes().filter('[type="Query"]').length/10+eles.nodes().filter('[type="Linker"]').length/100,
                    });
                layout.run();
                var box = eles.boundingBox();
                query_orphs.positions(function( node, i ){
                  return {
                    x: box.x2+100+500*(i%4),
                    y: box.y1+500*(Math.floor(i/4))
                  };
                });
               
            }
            
            
            function run_grid() {
                var is_query = cy.nodes().filter('[type="Query"]');
                var is_connected = is_query.filter(function(ele) {return((ele.degree()!=0));});  //Connected query nodes
                var query_orphans = is_query.filter(function(ele) {return((ele.degree()==0));}); // Non-connected query nodes
                var linkers = cy.nodes().filter('[type="Linker"]').not(':transparent');
                var direct = cy.nodes().filter('[type="Direct"]').not(':transparent');
                var edgeLen = Math.floor(Math.sqrt(linkers.length));
                var orphLen = Math.floor(Math.sqrt(query_orphans.length));
            
                if (linkers.length == 0) {
                    is_connected.positions(function( node, i ){
                      return {
                        x: 1000*(i%2),
                        y: 1000*Math.floor(i/2)
                      };
                    });
                    for (var i=0; i<is_connected.length; i++) {
                        ele = is_connected[i];
                        var box = ele.position();
                        var direct_conn = ele.outgoers().union(ele.incomers()).filter('[type="Direct"]').not(':transparent');
                        direct_conn.positions(function( node, i ){
                            if (box.x==1000) {
                              return {
                                x: box.x+3000+500*(i%4),
                                y: box.y+500*(Math.floor(i/10))
                              };
                            } else {
                               return {
                                x: box.x-3000-500*(i%4),
                                y: box.y-500*(Math.floor(i/10))
                              };
                            }
            
                        });
                    }
            
                } else {
                    is_connected.positions(function( node, i ){
                      return {
                        x: (edgeLen*500+5000)*(i%2),
                        y: 1000*Math.floor(i/2)
                      };
                    });
                    linkers.positions(function( node, i ){
                      return {
                        x: 2500+(i%edgeLen)*500,
                        y: 500*Math.floor(i/edgeLen)
                      };
                    });
                    for (var i=0; i<is_connected.length; i++) {
                        ele = is_connected[i];
                        var box = ele.position();
                        var direct_conn = ele.outgoers().union(ele.incomers()).filter('[type="Direct"]').not(':transparent');
                        direct_conn.positions(function( node, i ){
                            if (box.x==edgeLen*500+5000) {
                              return {
                                x: box.x+edgeLen*100+1000+500*(i%4),
                                y: box.y+500*(Math.floor(i/10))
                              };
                            } else {
                               return {
                                x: box.x-edgeLen*100-1000-500*(i%4),
                                y: box.y-500*(Math.floor(i/10))
                              };
                            }
            
                        });
                    }
            
                }
            
                query_orphans.positions(function( node, i ){
                    return {
                        x: -500-500*(i%orphLen),
                        y: -500-500*(Math.floor(i/orphLen))
                      };
                    });
                
                cy.zoom(orig_zoom/2)               
                cy.center();
            
            }
            
            
        </script>
    </body>
</html>