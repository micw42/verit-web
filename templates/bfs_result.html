<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.18.2/cytoscape.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type=text/javascript>
      $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.3.2/cytoscape-dagre.min.js"></script>
    <script src="https://unpkg.com/layout-base@1.0.2/layout-base.js"></script>
    <script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
    <script src="https://unpkg.com/cose-base@1.0.3/cose-base.js"></script>
    <script src="https://unpkg.com/cytoscape-graphml/cytoscape-graphml.js"></script>
    <script src="https://raw.githack.com/iVis-at-Bilkent/cytoscape.js-layvo/unstable/cytoscape-layvo.js"></script>
    <script src="{{url_for('static', filename='cytoscape.js-cise/cytoscape-cise.js')}}"></script>
    <script src="https://unpkg.com/layout-base/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base/cose-base.js"></script>
    <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
     <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <title>Result</title>
</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
        background: #4a4a4a;
        z-index: -1;
    }

    .modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        /* Stay in place */
        z-index: 1;
        /* Sit on top */
        padding-top: 100px;
        /* Location of the box */
        left: 0;
        top: 0;
        width: 100%;
        /* Full width */
        height: 100%;
        /* Full height */
        overflow: auto;
        /* Enable scroll if needed */
        background-color: rgb(0, 0, 0);
        /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4);
        /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        font-family: Arial, Helvetica, sans-serif;
    }

    .modal-body {
        max-height: calc(100vh - 210px);
        overflow-y: auto;
    }
    
        .loader {
  border: 5px solid #f3f3f3;
  border-radius: 50%;
  border-top: 5px solid #4CAF50;
  width: 25px;
  height: 25px;
  animation: spin 2s linear infinite;
  opacity: 0;
    }
    
    .loading {
        color:#4CAF50
    }

    .loader.show {
      opacity: 1;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* The Close Button */
    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }

    #menuDiv {
        padding: 0px 20px 20px 0px
    }

    #posEv {
        float: left;
        padding-right: 20px;
        width: 33%;
        font-size: large;
    }

    #negEv {
        float: left;
        width: 33%;
        padding-right: 20px;
        font-size: large;
    }

    #incEv {
        float: right;
        width: 33%;
        font-size: large;
    }

    #posThickness {
        float: left;
        width: 33%;
    }

    #negThickness {
        float: left;
        width: 33%;
    }

    #incThickness {
        float: right;
        width: 33%;
    }
</style>


<body>
    <div id="floatParent">
    <div id="cy"></div>

    <div class="w3-sidebar w3-bar-block w3-border-right" style="width:15%;float:left;" id="mySidebar">
    <button onclick="w3_close()" class="w3-bar-item w3-large">Close &times;</button>
        <form id="queryForm" method="POST" action="{{ url_for('go_home') }}">
            <h6><input class="w3-bar-item w3-button" style="color:#4CAF50" type="submit" value="Return to Homepage" />
            </h6>
        </form>
        
                <div>
        <h6 style="padding-left:10px">Click on connections between nodes to see the evidence for that connection.</h6><br>
        <h6 style="padding-left:10px">Mouseover nodes to see only the nodes that the node directly targets.</h6><br>
        <h6 style="padding-left:10px"> Red represents down regulation, blue represents up regulation, and white represents inconclusive
            interactions. For more information on the color-coding, see the README. </h6><br>
        <h6 style="padding-left:10px">
        Note: The NLP algorithm does not detect interaction type with perfect accuracy.
                    </h6>
                    
        </div><br>


        <h6 style="padding-left:10px">Filter by thickness:</h6>

        <div style="padding-left:10px" class="slidecontainer">
            <input type="range" min="1" value="1" class="slider" id="myRange">
            <form action="#" id="input_thickness">
                Enter thickness threshold: <input type="number" id="quantity" min="1">
                <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px">Submit</button>
            </form>
            <p>Minimum edge thickness: <span id="demo"></span></p>
            <ul class="nav">
                <li style="display:inline">
                    <div class="loading" id="filter_loading"></div>
                </li>
                <li style="display:inline">
                    <div id="filter_loader" class="loader"></div>
                </li>
            </ul>
                                
            

            
        </div>

        <br>
        <div style="padding-left:10px">
            <h6>Change Layout.</h6>
            <select id="layout-button" onchange="run_switch_layout()" class="btn btn-primary"
                style="background-color:#4CAF50;padding-left:10px">
                <option value="fCose">fCose</option>
                <option value="Circle">Circle</option>
                <option value="Grid">Grid</option>
            </select>
                                    <ul class="nav">
                <li style="display:inline">
                    <div class="loading" id="layout_loading"></div>
                </li>
                <li style="display:inline">
                    <div id="layout_loader" class="loader"></div>
                </li>
            </ul>
            
            <div style="padding-left:10px" class="slidecontainer" id="fCose_settings">
                Adjust node repulsion: <input type="range" min="3" max="18" value="9" class="slider" id="nr_slider">
                 <p>Current node repulsion: <span id="cur_nr"></span></p>
            <ul class="nav">
                <li style="display:inline">
                    <div class="loading" id="nr_loading"></div>
                </li>
                <li style="display:inline">
                    <div id="nr_loader" class="loader"></div>
                </li>
            </ul>
                
        </div> <br>
            <h6>Toggle between showing and hiding direct neighbors.</h6>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="direct-button" onchange="run_show_direct()">
              <label class="form-check-label" for="direct-button">Show direct neighbors with thickness > 20</label>&nbsp;<i class="fa fa-question-circle" aria-hidden="true" title="Direct neighbors are nodes directly connected to a node by 1 edge." style="cursor:pointer"></i>
            </div>
             <ul class="nav">
                <li style="display:inline">
                    <div class="loading" id="direct_loading"></div>
                </li>
                <li style="display:inline">
                    <div id="direct_loader" class="loader"></div>
                </li>
            </ul>
            <br><br>

        </div>
        
       <div style="padding-left:10px">
            <h6>Search for a node.</h6>
            <form action="#" id="node_search">
                Enter name: <input type="text" id="node_name">
                <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px">Submit</button>
            </form>
           <p>Current query: <span id="current_query">None</span></p>
           <button id="reset" onclick="reset_query()" class="btn btn-primary" style="display:none;background-color:#4CAF50;padding-left:10px">Reset graph</button>
        </div>
    </div>
    </div>

    <script>
        function w3_open() {
            document.getElementById("mySidebar").style.display = "block";
        }

        function w3_close() {
            document.getElementById("mySidebar").style.display = "none";
        }
    </script>
    

    <button class="w3-button w3-teal w3-xlarge" onclick="w3_open()" style="z-index:2">☰</button>
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h1 id="thickness" style="font-family: Arial, Helvetica, sans-serif"></h1>
                <h1 style="font-family: Arial, Helvetica, sans-serif">Evidence for this connection:</h1>
            </div>
            <div id="modalBody" class="modal-body">
                <h2 id="posThickness"></h2>
                <h2 id="negThickness"></h2>
                <h2 id="incThickness"></h2>
                <div id="posEv"></div>
                <div id="negEv"></div>
                <div id="incEv"></div>
            </div>
        </div>
    </div>

    <div id="synModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h1 style="font-family: Arial, Helvetica, sans-serif">Synonyms:</h1>
            </div>
            <div id="modalBody" class="modal-body">
                <h2 id="synList"></h2>
            </div>
        </div>
    </div>
    
   <div id="warnModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalBody" class="modal-body">
                <h2>Your query generated a large graph, so only edges with thickness > 20 are included</h2>
            </div>
        </div>
    </div>


    <script src="{{url_for('static', filename='bfs_vis_functions.js')}}"></script>

    <script>

        const data = {{ elements | tojson }};
        var cy = cytoscape({
            wheelSensitivity: 0.1,
            container: document.getElementById('cy'),
            elements: data,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        "text-valign": "center",
                        "text-halign": "center",
                        "background-color": "data(color)",
                        "text-outline-color": "#555",
                        "text-outline-width": "2px",
                        "color": "#080707",
                        width: function (ele) { return Math.min((Math.max(80, ele.degree() + 2) * 2), 500); },
                        height: function (ele) { return Math.min((Math.max(80, ele.degree() + 2) * 2), 500); },
                        "font-size": function (ele) { return Math.min((Math.log2(ele.degree() + 2) * 25), 350); },
                        'background-fit': 'contain',
                        'background-clip': 'none',
                        "display": "data(display)"
                    },
                    position: {
                        x: "data(position)",
                        y: "data(position)"
                    }
                }, {
                    selector: 'edge',
                    style: {

                        'text-background-color': 'yellow',
                        'text-background-opacity': 0.4,
                        'target-arrow-shape': 'triangle',
                        'control-point-step-size': '140px',
                        'curve-style': 'bezier',
                        'control-point-step-size': 300,
                        'line-color': "#fcfafa",
                        'target-arrow-color': '#fcfafa',
                        "overlay-opacity": "0.1",
                        "display": "data(display)",
                        'width': 'data(weight)',
                        'line-color': "data(color)",
                        'target-arrow-color': "data(color)"
                    }
                },
                
                 {
                    selector: 'node.semitransp',
                    style: { 'opacity': '.1' }
                },
                {
                    selector: 'edge.semitransp',
                    style: { 'opacity': '.1' }
                },
                {
                    selector: 'node.transp',
                    style: {
                        'opacity': '0',
                        'events': 'no'
                    }
                },
                {
                    selector: 'edge.transp',
                    style: { 'opacity': '0' }
                },
                {
                    selector: 'node.large',
                    style: {
                        'font-size': 200
                    }
                },
                {
                    selector: 'node.searched',
                    style: {
                        'background-color': "#26ff12"
                    }
                },
                {
                    selector: 'edge.mouseover',
                    style: {
                        'line-color': "#26ff12",
                        'target-arrow-color':"#26ff12"
                    }
                },
                {
                    selector: 'edge.colors',
                    style: {
                        'line-color': "data(color)",
                        'target-arrow-color': "data(color)"
                    }
                }

            ]
        });
        
        
        {% if filtered %}
            const filtered = true
        {% else %}
            const filtered = false
        {% endif %}
        console.log("filtered: "+filtered)
        if (filtered) {
            var modal = document.getElementById("warnModal");
            var span = document.getElementsByClassName("close")[2];
            modal.style.display = "block";

            window.onclick = function (event) {
                if (event.target == modal) {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }
            }

            span.onclick = function () {
                var modalBody = document.getElementById("modalBody");
                modalBody.scrollTop = 0;
                modal.style.display = "none";
            }
        } 
        
        var currently_querying = false
        
        cy.on('mouseover', 'node', function (evt) {
            if (!currently_querying) {
               var sel = evt.target;
                console.log(sel.degree());
                sel.addClass('large');
                var neighbors = sel.outgoers().union(sel.incomers());
                cy.nodes().difference(neighbors).not(sel).addClass('semitransp');
                cy.edges().difference(sel.edgesWith(neighbors)).addClass("semitransp"); 
            }

        });
        
        cy.on('mouseover', 'edge', function (evt) {
               var sel = evt.target;
                if (sel.style()["opacity"] != "0") {
                    sel.addClass('mouseover');
                }
        });

        cy.on('mouseout', 'node', function (evt) {
            if (!currently_querying) {
                var sel = evt.target;
                sel.removeClass('large');
                var neighbors = sel.outgoers().union(sel.incomers());
                cy.nodes().difference(neighbors).not(sel).removeClass('semitransp');
                cy.edges().difference(sel.edgesWith(neighbors)).removeClass("semitransp");
            }

        });
        
       cy.on('mouseout', 'edge', function (evt) {
               var sel = evt.target;
                sel.removeClass('mouseover');
        });


        cy.on('click', 'edge', function (evt) {
            var sel = evt.target;
            console.log(sel.data().files);

            function getEvidence() {
                var retval;
                $.ajaxSetup({
                    async: false
                });
                $(function() {
                  $.getJSON($SCRIPT_ROOT + '/_get_evidence', {
                    files:sel.data().files
                  }, function(data) {
                      console.log(data.result);
                      retval = data.result;
                      return false;
                  });
                });
                console.log(retval);
                return retval;
            }

            var ev = getEvidence();
            console.log(ev);

            var modal = document.getElementById("myModal");
            var span = document.getElementsByClassName("close")[0];
            var thickness = document.getElementById("thickness");
            var ev_split = ev.split("%%");
            var ev_length = ev_split.length;
            thickness.innerHTML = "Total mentions: " + ev_length;
            var ul_pos = document.createElement("ul");
            var ul_neg = document.createElement("ul");
            var ul_inc = document.createElement("ul");
            var negCount = 0;
            var posCount = 0;
            var incCount = 0;
            for (var i = 0; i < ev_split.length; i++) {
                // Create the list item:
                var item = document.createElement('li');
                var cont = document.createElement("div");

                var parts = ev_split[i].split("|");
                var text = parts[0];
                var act = parts[1];


                // Set its contents:
                item.appendChild(document.createTextNode(text));
                cont.appendChild(item)
                if (act === "Activation (Negative)") {
                    cont.style.color = "red";
                    negCount = negCount += 1;
                } else if (act === "Activation (Positive)") {
                    cont.style.color = "blue";
                    posCount = posCount += 1;
                }
                else {
                    cont.style.color = "black";
                    incCount = incCount += 1;
                }

                cont.style.padding = "0px 0px 20px 0px";


                // Add it to the list:
                if (act === "Activation (Positive)") {
                    ul_pos.appendChild(cont);
                } else if (act === "Activation (Negative)") {
                    ul_neg.appendChild(cont);
                } else {
                    ul_inc.appendChild(cont);
                }

            }
            

            
            function createFiller() {
                var fillerText = document.createElement("li");
                var fillerCont = document.createElement("div");

                fillerText.appendChild(document.createTextNode("This is filler text"));
                fillerCont.appendChild(fillerText);
                fillerCont.style.padding = "0px 0px 20px 0px";
                fillerCont.style.color = "blue";

                var fillerText = document.createElement("li");
                var fillerCont = document.createElement("div");

                fillerText.appendChild(document.createTextNode("This is filler text"));
                fillerCont.appendChild(fillerText);
                fillerCont.style.padding = "0px 0px 20px 0px";
                fillerCont.style.color = "white";
                return fillerCont;
            }

            var fillerPos = createFiller();
            var fillerNeg = createFiller();
            var fillerInc = createFiller();
            ul_pos.appendChild(fillerPos);
            ul_neg.appendChild(fillerNeg);
            ul_inc.appendChild(fillerInc);

            document.getElementById("posThickness").innerHTML = "Positive: " + posCount;
            document.getElementById("negThickness").innerHTML = "Negative: " + negCount;
            document.getElementById("incThickness").innerHTML = "Inconclusive: " + incCount;
            document.getElementById("posEv").innerHTML = ul_pos.innerHTML;
            document.getElementById("negEv").innerHTML = ul_neg.innerHTML;
            document.getElementById("incEv").innerHTML = ul_inc.innerHTML;
            modal.style.display = "block";

            window.onclick = function (event) {
                if (event.target == modal) {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }
            }

            span.onclick = function () {
                var modalBody = document.getElementById("modalBody");
                modalBody.scrollTop = 0;
                modal.style.display = "none";
            }
        });

        cy.on('click', 'node', function (evt) {
            var sel = evt.target;
            var modal = document.getElementById("synModal");
            var span = document.getElementsByClassName("close")[1];
            var syn = sel.data().syn;
            var syn_split = syn.split("%%");
            syn_split = [...new Set(syn_split)];
            var syn_list = document.createElement("ul")
            for (var i = 0; i < syn_split.length; i++) {
                // Create the list item:
                var item = document.createElement('li');
                var cont = document.createElement("div");

                var text = syn_split[i];

                // Set its contents:
                item.appendChild(document.createTextNode(text));
                cont.appendChild(item)
                cont.style.padding = "0px 0px 20px 0px";

                // Add it to the list:
                syn_list.appendChild(cont);
            }

            document.getElementById("synList").innerHTML = syn_list.innerHTML;
            modal.style.display = "block";

            window.onclick = function (event) {
                if (event.target == modal) {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }
            }

            span.onclick = function () {
                var modalBody = document.getElementById("modalBody");
                modalBody.scrollTop = 0;
                modal.style.display = "none";
            }
        });
        
        function getMaxWeight(allEdges) {
            var weight_arr = []
            for (var i = 0; i < allEdges.length; i++) {
                var edgeData = (allEdges[i]).data()
                var weight = edgeData.thickness
                weight_arr.push(weight)
            }
            Array.prototype.max = function() {
              return Math.max.apply(null, this);
            };
            var maxWeight = weight_arr.max()
            return(maxWeight)
        }


        
        var filteredEdges = cy.edges().filter('[thickness < 0]');
        var filteredNodes = cy.nodes().filter(function (ele) {
            return ele.degree() == -2;
        });
        filteredEdges = cy.remove(filteredEdges);
        filteredNodes = cy.remove(filteredNodes);

        var slider = document.getElementById("myRange");
        var queryEdges = cy.edges().filter(function (ele) {
            return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
        });
        var allEdges = cy.edges()    
        var queryMax = Math.ceil(getMaxWeight(queryEdges))
        var allMax = Math.ceil(getMaxWeight(allEdges))
        slider.max = queryMax
        var input_qty = document.getElementById("quantity");
        input_qty.max = queryMax
        var output = document.getElementById("demo");
        output.innerHTML = slider.value;
        slider.oninput = function () {
            threshold = this.value;
            run_filter_edges(threshold)
            output.innerHTML = this.value;
            input_qty.value = this.value
        }
        input_thickness.onsubmit = async function () {
            var thickness_val = document.getElementById("quantity");
            var threshold = thickness_val.value;
            run_filter_edges(threshold)
            output.innerHTML = threshold
            slider.value=threshold
        }
        
        var node_search = document.getElementById("node_search");
        var current_query = document.getElementById("current_query");
        var reset_button = document.getElementById("reset");
        node_search.onsubmit = function () {
            currently_querying = true;
            reset_button.style.display="block"
            cy.nodes().removeClass("transp");
            cy.edges().removeClass("transp");
            cy.nodes().removeClass("searched");
            var node_name = document.getElementById("node_name");
            current_query.innerHTML = node_name.value; 
            var results_nodes = cy.nodes().filter(function(ele) {
                return ((ele.style()["display"] != "none") && 
                        (ele.style()["opacity"] != "0") &&
                       (ele.data("label").toLowerCase() === node_name.value.toLowerCase()));})
            results_nodes.addClass('searched')
            console.log("Result nodes: "+results_nodes.length)
            var neighbors = results_nodes.outgoers().union(results_nodes.incomers());
            var results_edges = results_nodes.connectedEdges()
            var results_nodes = results_nodes.union(neighbors)           
            cy.nodes().difference(results_nodes).addClass('transp');
            cy.edges().difference(results_edges).addClass('transp');
        }
        
        /*
        cy.on('click', (event) => {
            currently_querying = false;
            cy.nodes().removeClass("transp");
            cy.edges().removeClass("transp");
            cy.nodes().removeClass("searched");
            current_query.innerHTML = "None"; 
        }); */
        
        function reset_query() {
            currently_querying = false;
            cy.nodes().removeClass("transp");
            cy.edges().removeClass("transp");
            cy.nodes().removeClass("searched");
            current_query.innerHTML = "None"; 
            reset_button.style.display = "None"
        }
        
        display_loading = async function(elem_id) {
            var elem = document.getElementById(elem_id)
            elem.style.display = "block"
            elem.innerHTML = "Loading"
            return("Promise 1")
        }
        
        hide_loading = async function(elem_id) {
            var elem = document.getElementById(elem_id)
            elem.style.display = "none"
            return("Promise 2")
        }
        
        filterEdges = function(threshold) {
            filteredNodes.removeClass("transp");
            filteredEdges.restore();

            filteredEdges = cy.edges().filter('[thickness < ' + threshold + ']');
            filteredEdges = cy.remove(filteredEdges);
            filteredNodes = cy.nodes().filter(function (ele) {
                return ((ele.degree() == 0) && (ele.data("type") != "Query"));
            });
            filteredNodes.addClass("transp");
            rerun_layout();
        }
        
        function run_filter_edges(threshold) {
            const status = document.querySelector('#filter_loading');
            const loader = document.querySelector('#filter_loader');
            const wait = (ms = 5000) => {
                return new Promise((resolve) => {
                setTimeout(() => {
                    filterEdges(threshold)
                    resolve();
                },ms)
              })
            }
            status.innerHTML = "Filtering edges...&nbsp;";
            loader.classList.toggle('show', true);
            wait(500)
            .then(() => {
                status.innerHTML = "";
                loader.classList.toggle('show', false);
            })
        }

        function switch_layout() {
            var layout = document.getElementById("layout-button");
            if (layout.value === "Circle") {
                run_circle();
                document.getElementById("fCose_settings").style.display = "none";
            } else if (layout.value === "fCose") {
                run_fCose(idealEL=iel, nodeRep=nr);
                document.getElementById("fCose_settings").style.display = "block";
            } else {
                run_grid();
                document.getElementById("fCose_settings").style.display = "none";

            }
        }
        
        function run_run_fcose(idealEL, nodeRep) {
            const status = document.querySelector('#nr_loading');
            const loader = document.querySelector('#nr_loader');
            const wait = (ms = 5000) => {
                return new Promise((resolve) => {
                setTimeout(() => {
                    run_fCose(idealEL, nodeRep)
                    resolve();
                },ms)
              })
            }
            loader.classList.toggle('show', true);
            status.innerHTML = "Adjusting node repulsion...";
            wait(500)
            .then(() => {
                status.innerHTML = "";
                loader.classList.toggle('show', false);
            })
        } 
        
        var nr_slider = document.getElementById("nr_slider")
        var cur_nr = document.getElementById("cur_nr")
        var nr = 1e9
        if (cy.nodes().filter('[type="Linker"]').length==0) {
            var iel = (cy.nodes().filter('[type="Query"]').length)*10+100
        } else {
            var iel = (cy.nodes().filter('[type="Linker"]').length)/2+100
        }
        cur_nr.innerHTML="1e9"
        nr_slider.value=9
        nr_slider.oninput = function () {
            cur_nr.innerHTML = "1e"+this.value;
            var nr = 10**(this.value);
            run_run_fcose(idealEL=iel, nodeRep=nr)
        }
 
        
        function reset_slider() {
            nr_slider.value=9
            cur_nr.innerHTML="1e9"
        }
        
        function rerun_layout() {
            var layout = document.getElementById("layout-button");
            if (layout.value === "Grid") {
                run_grid();
            } else if (layout.valueL === "Circle") {
                run_circle();
            } else {
                run_fCose(idealEL=iel, nodeRep=1e9);
                reset_slider()
            }
        }
        
        function run_switch_layout() {
            const status = document.querySelector('#layout_loading');
            const loader = document.querySelector('#layout_loader');
            const wait = (ms = 5000) => {
                return new Promise((resolve) => {
                setTimeout(() => {
                    switch_layout();
                    resolve();
                },ms)
              })
            }
            status.innerHTML = "Rerunning layout...";
            loader.classList.toggle('show', true);
            wait()
            .then(() => {
                status.innerHTML = "";
                loader.classList.toggle('show', false);
            })
        }
        function show_direct(show=true) {
            var slider = document.getElementById("myRange");
            var input_qty = document.getElementById("quantity");

            if (show) {
                cy.edges().filter("[display='none']").style("display", "element")
                cy.nodes().filter("[display = 'none']").style("display", "element")
                slider.max = allMax
                input_qty.max = allMax
            } else {
                cy.edges().filter("[display = 'none']").style("display", "none")
                cy.nodes().filter("[display = 'none']").style("display", "none")
                slider.max = queryMax
                input_qty.max = queryMax
            }                              
            threshold = slider.value
            filterEdges(threshold);
            output.innerHTML = threshold;
            rerun_layout();
        }
        
        let show = true
        function run_show_direct() {
            const status = document.querySelector('#direct_loading');
            const loader = document.querySelector('#direct_loader');
            const wait = (ms = 5000) => {
                return new Promise((resolve) => {
                setTimeout(() => {
                    show_direct(show);
                    if (show) {
                        show = false
                    } else {
                        show=true
                    }
                    resolve();
                },ms)
              })
            }
            if (show) {
                status.innerHTML = "Loading direct neighbors...";
            } else {
                status.innerHTML = "Hiding direct neighbors...";
            }
            loader.classList.toggle('show', true);
            wait(500)
            .then(() => {
                status.innerHTML = "";
                loader.classList.toggle('show', false);
            })
        }

        function add_colors() {
            var x = document.getElementById("color-button");
            if (x.innerHTML === "Show Color") {
                x.innerHTML = "Hide Color";
                cy.edges().addClass("colors");
            } else {
                x.innerHTML = "Show Color";
                cy.edges().removeClass("colors");
            }
        }

        function switch_color() {
            var x = document.getElementById("current-color");
            if (x.innerHTML === "Current: Positive interactions") {
                x.innerHTML = "Current: Negative interactions";
                cy.edges().removeClass("pos_colors");
                cy.edges().addClass("neg_colors");
            } else if (x.innerHTML == "Current: Negative interactions") {
                x.innerHTML = "Current: Inconclusive interactions";
                cy.edges().removeClass("neg_colors");
                cy.edges().addClass("inc_colors");
            } else if (x.innerHTML == "Current: Inconclusive interactions") {
                x.innerHTML = "Current: None";
                cy.edges().removeClass("inc_colors");
            } else {
                x.innerHTML = "Current: Positive interactions";
                cy.edges().addClass("pos_colors");
            }
        }
        
        
       function run_fCose(idealEL, nodeRep=1e9) {
           var eles = cy.elements().filter(function (ele) {
                return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
            }); 
            var layout = cy.layout({
                name: 'fcose',
                nodeRepulsion: node => nodeRep,
                idealEdgeLength: edge => idealEL,
                gravity: 1e-5,
                  gravityRangeCompound: 1e-5,
                  gravityCompound: 1e-5,
                  gravityRange: 1e-5
            }) 
            layout.run();
        }
        
        run_fCose(idealEL=iel)
       
        const orig_zoom = cy.zoom()
        function run_circle() {
            var query_orphs = cy.nodes().filter(function (ele) {
                var neighbors = ele.outgoers().union(ele.incomers());
                var query_neighbors = neighbors.filter('[type="Query"]')
                console.log(ele.id()+"query_neighbors")
                console.log(query_neighbors.length)
                return ((query_neighbors.length==0) && (ele.data("classes")=="level3"));
            });
            var eles = cy.elements().difference(query_orphs).filter(function (ele) {
                return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
            });
            var layout = eles.layout({
                     name: 'breadthfirst',
                     grid:true,
                     roots:'node[classes @*="level3"]',
                     maximal:true,
                     circle:true,               spacingFactor:10+eles.nodes().filter('[type="Query"]').length/10+eles.nodes().filter('[type="Linker"]').length/100,
                });
            layout.run();
            var box = eles.boundingBox();
            query_orphs.positions(function( node, i ){
              return {
                x: box.x2+100+500*(i%4),
                y: box.y1+500*(Math.floor(i/4))
              };
            });

            cy.zoom(orig_zoom/2)              
            cy.center();
        }
        

        function run_grid() {
            var is_query = cy.nodes().filter('[type="Query"]');
            var is_connected = is_query.filter(function(ele) {return((ele.degree()!=0));});  //Connected query nodes
            var query_orphans = is_query.filter(function(ele) {return((ele.degree()==0));}); // Non-connected query nodes
            var linkers = cy.nodes().filter('[type="Linker"]').not(':transparent');
            var direct = cy.nodes().filter('[type="Direct"]').not(':transparent');
            var edgeLen = Math.floor(Math.sqrt(linkers.length));
            var orphLen = Math.floor(Math.sqrt(query_orphans.length));

            if (linkers.length == 0) {
                is_connected.positions(function( node, i ){
                  return {
                    x: 1000*(i%2),
                    y: 1000*Math.floor(i/2)
                  };
                });
                for (var i=0; i<is_connected.length; i++) {
                    ele = is_connected[i];
                    var box = ele.position();
                    var direct_conn = ele.outgoers().union(ele.incomers()).filter('[type="Direct"]').not(':transparent');
                    direct_conn.positions(function( node, i ){
                        if (box.x==1000) {
                          return {
                            x: box.x+3000+500*(i%4),
                            y: box.y+500*(Math.floor(i/10))
                          };
                        } else {
                           return {
                            x: box.x-3000-500*(i%4),
                            y: box.y-500*(Math.floor(i/10))
                          };
                        }

                    });
                }

            } else {
                is_connected.positions(function( node, i ){
                  return {
                    x: (edgeLen*500+5000)*(i%2),
                    y: 1000*Math.floor(i/2)
                  };
                });
                linkers.positions(function( node, i ){
                  return {
                    x: 2500+(i%edgeLen)*500,
                    y: 500*Math.floor(i/edgeLen)
                  };
                });
                for (var i=0; i<is_connected.length; i++) {
                    ele = is_connected[i];
                    var box = ele.position();
                    var direct_conn = ele.outgoers().union(ele.incomers()).filter('[type="Direct"]').not(':transparent');
                    direct_conn.positions(function( node, i ){
                        if (box.x==edgeLen*500+5000) {
                          return {
                            x: box.x+edgeLen*100+1000+500*(i%4),
                            y: box.y+500*(Math.floor(i/10))
                          };
                        } else {
                           return {
                            x: box.x-edgeLen*100-1000-500*(i%4),
                            y: box.y-500*(Math.floor(i/10))
                          };
                        }

                    });
                }

            }

            query_orphans.positions(function( node, i ){
                return {
                    x: -500-500*(i%orphLen),
                    y: -500-500*(Math.floor(i/orphLen))
                  };
                });
            
            cy.zoom(orig_zoom/2)               
            cy.center();

        }


    </script>


</body>

</html>