<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.18.2/cytoscape.min.js"></script>
      <script type=text/javascript>
         $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
      </script>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.3.2/cytoscape-dagre.min.js"></script>
      <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
       <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
      <title>Result</title>
   </head>
   <style>
      .reload {
      font-family: Lucida Sans Unicode
      }
    .hiddenHeader {
    visibility: hidden;
    max-height: 0;
    }
      #cy {
      width: 100%;
      height: 100%;
      position: absolute;
      background: #FFFFFF;
      z-index: -1;
      }
      .modal {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /* Sit on top */
      padding-top: 100px;
      /* Location of the box */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.4);
      /* Black w/ opacity */
      }
      /* Modal Content */
      .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      font-family: Arial, Helvetica, sans-serif;
      }
      .modal-body {
      max-height: calc(100vh - 210px);
      overflow-y: auto;
      }
      /* The Close Button */
      .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      }
      .close:hover,
      .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
      }
      #menuDiv {
      padding: 0px 20px 20px 0px
      }
      #posEv {
      float: left;
      padding-right: 20px;
      width: 33%;
      font-size: large;
      }
      #negEv {
      float: left;
      width: 33%;
      padding-right: 20px;
      font-size: large;
      }
      #incEv {
      float: right;
      width: 33%;
      font-size: large;
      }
      #posThickness {
      float: left;
      width: 33%;
      }
      #negThickness {
      float: left;
      width: 33%;
      }
      #incThickness {
      float: right;
      width: 33%;
      }
      dl{height:200px;}
      dl{overflow:hidden; overflow-y:scroll;}
       .itemconfiguration
        {
          height:300px;
          /* background-color:#CCC; */	
          overflow:hidden;
          overflow-y:scroll;
          border:1px solid lightgrey;
          margin-bottom:5px;
        }
        .matchDiv
        {
          padding-left:10px
        }
        label {
          margin-left: 5px;
        }
       .collapsible {
          background-color: #FFFFFF;
          cursor: pointer;
          padding: 5px;
          width: 80%;
          height: 10%;
          border: none;
          text-align: left;
          outline: none;
          font-size: 15px;
          word-break: break-all;
        }
            .evDiv
        {
            height:500px;
            /* background-color:#CCC; */	
            overflow:hidden;
            overflow-y:scroll;

        }
        .collapsible:hover {
          background-color: #f1f1f1;
        }

        .collapsible:after {
          color: white;
          font-weight: bold;
          float: right;
          margin-left: 5px;
          border: none;
        }

        .content {
          padding: 0 4%;
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.2s ease-out;
        }

        li{
            word-break: break-all;
        }
       .loader {
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #4CAF50;
        width: 25px;
        height: 25px;
        animation: spin 2s linear infinite;
        opacity: 0;
        }
        .loading {
        color:#4CAF50
        }
        .loader.tc_scheme {
        opacity: 1;
        }
        @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }
   </style>
   <body>
      <div class="w3-sidebar w3-bar-block w3-border-right" style="display:block;width:30%" id="mySidebar">
         <button onclick="w3_close()" class="w3-bar-item w3-large">Close &times;</button>
         <form id="queryForm" method="POST" action="{{ url_for('go_home') }}">
            <p><input class="w3-bar-item w3-button w3-border-bottom" style="color:#4CAF50;" type="submit" value="Return to Homepage" /></p>
         </form>
         <div style="padding:20px;padding-top:0px">
            <h2 style="padding-bottom:10px;">Details</h2>
            <h6>
               Click on connections between nodes to see the evidence for that connection. <br> <br>
               Mouseover nodes to see only the nodes that the node directly targets. <br> <br>
               Red, blue, and white edges indicate down, up, and inconclusive relationships, respectively.
               Details found in README. <br> <br>
               Click the <span class=".reload;">&#x21bb;</span> icon to reload the visualization after making
               adjustments.
            </h6>
         </div>
          
         <hr>
          
         <div style="padding-left:20px;padding-bottom:20px" class="slidecontainer">
            <h2 style="padding-bottom:10px;">Parameters</h2>
            <h6>Filter by thickness:</h6>
             <p id="totalLabel" style="color:grey;margin-left:20px;margin-right:40px;display:none">Total thickness</p>
            <input type="range" min="2" value="2" class="slider" id="myRange" style="width:50%;margin-left:20px">
            <form action="#" id="input_thickness" style="display:inline;">
               <input type="number" id="quantity" min="2" value="2" style="width:15%">
               <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
            </form>
             <div id="IndFilter" style="display:none">
             <p style="color:grey;margin-left:20px;margin-right:40px;">REACH thickness</p>
           <input type="range" min="2" value="2" class="slider" id="myRangeR" style="width:50%;margin-left:20px">
            <form action="#" id="input_thicknessR" style="display:inline;">
               <input type="number" id="quantityR" min="2" value="2" style="width:15%">
               <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
            </form>
             <p style="color:grey;margin-left:20px;margin-right:40px;">BIOGRID thickness</p>
           <input type="range" min="1" value="1" class="slider" id="myRangeBG" style="width:50%;margin-left:20px">
            <form action="#" id="input_thicknessBG" style="display:inline;">
               <input type="number" id="quantityBG" min="1" value="1" style="width:15%">
               <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
            </form>
             </div>
            <br>
         </div>
          
          
         <div style="padding-left:20px;padding-bottom:20px">
            <h6>Search for a node:</h6>
             
            <form action="#" id="node_search" style="display:inline;">
               <input type="text" id="node_name" style="width:66%;margin-left:20px;">
               <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;padding-left:10px;"><span class="reload">&#x21bb;</span></button>
            </form>
             
            <button id="reset" onclick="reset_query()" class="btn btn-primary" style="display:none;background-color:#4CAF50;"><span class=reload>&#171;</span></button>
            <p style="color:grey;margin-left:20px;margin-right:40px;">(Current search: <span id="current_query">None</span>)</p>
         </div>
          

          <div id="kb_div" style="padding-left:20px;" class="slidecontainer">
              <h6>Filter by knowledge base:</h6>
              
                <form id="kb_form" action="#" style="width:82%;">
                  <dl style="border:1px solid lightgrey;margin-left:20px;margin-bottom:5px;">

                     <dt style="margin-left:10px;padding-top:10px">
                          <input class="allCheckbox" id="all_prot" value="all_prot" type="checkbox" />
                          <label class="allLabel" for="all_prot" style="margin-left:5px">Genes/proteins</label>
                      </dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="uniprot" value="uniprot" type="checkbox"/>
                              <label for="uniprot" style="margin-left:5px">Uniprot</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="fplx" value="fplx" type="checkbox" />
                              <label for="fplx" style="margin-left:5px">FamPlex</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="PR" value="PR" type="checkbox" />
                              <label for="PR" style="margin-left:5px">PR</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="interpro" value="interpro" type="checkbox" />
                              <label for="interpro" style="margin-left:5px">Interpro</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="pfam" value="pfam" type="checkbox" />
                              <label for="pfam" style="margin-left:5px">Pfam</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px">
                          <input class="allCheckbox" id="all_chem" value="all_chem" type="checkbox" />
                          <label class="allLabel" for="all_prot" style="margin-left:5px">Chemicals</label>
                     </dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="CHEBI" value="CHEBI" type="checkbox" />
                              <label for="CHEBI" style="margin-left:5px">CHEBI</label>
                           </li>
                           <li>
                              <input class="messageCheckbox" id="pubchem" value="pubchem" type="checkbox" />
                              <label for="pubchem" style="margin-left:5px">PubChem</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px">Cellular events</dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="GO" value="GO" type="checkbox" />
                              <label for="GO" style="margin-left:5px">GO</label>
                           </li>
                        </ul>
                     </dd>

                     <dt style="margin-left:10px" style="margin-left:5px">Diseases</dt>

                     <dd>
                        <ul style="list-style:none;">
                           <li>
                              <input class="messageCheckbox" id="mesh" value="mesh" type="checkbox" />
                              <label for="mesh" style="margin-left:5px">Mesh</label>
                           </li>
                        </ul>
                     </dd>
                  </dl>

                <button type="submit" class="btn btn-primary" style="background-color:#4CAF50;float:right;margin-bottom:20px;"><span class=reload>&#x21bb;</span></button>
            </form>
          <br><br>
          </div>
           <div id="layer-div" style="padding-left:20px;">
                <h6>Network Layer:</h6>
               
                <select id="layer-button" onchange="run_switch_layer()" class="form-select"
                    style="margin-left:20px;width:50%;" value="reach">
                    <option value="reach">Reach</option>
                    <option value="biogrid">BIOGRID</option>
                    <option value="union">Reach + BIOGRID</option>
                </select>
               
               
               <div style="padding-left:20px;padding-top:10px;display:none" id="color-scheme">

                    <h6 style="margin-right:5px;display:inline;">Dataset edge coloring:</h6>

                    <div class="form-check form-switch" style="display:inline;">
                        <input class="form-check-input" type="checkbox" role="switch" id="cs-button" onchange="run_change_scheme()" style="display:inline">
                        <label class="form-check-label" for="cs-button" style="display:inline"></label>
                    </div>

                    <p style="color:grey;margin-right:20px;">
                        Description: Toggle edge color to display dataset membership.
                    </p>
                </div>


                <p id="legend" style="color:gray;margin-left:20px;margin-top:0px;display:none">
                    Dataset membership legend: <br>
                    
                    <svg width="20" height="20">
                    <rect width="20" height="20" style="fill:#42a7f5;stroke-width:2;stroke:rgb(0,0,0)" />
                    </svg>
                    Reach + BIOGRID <br>
                
                    <svg width="20" height="20">
                    <rect width="20" height="20" style="fill:#9d49f2;stroke-width:2;stroke:rgb(0,0,0)" />
                    </svg>
                    Reach <br>
                    
                    <svg width="20" height="20">
                    <rect width="20" height="20" style="fill:#77ed40;stroke-width:2;stroke:rgb(0,0,0)" />
                    </svg>
                    BIOGRID <br>
                </p>

                 <ul class="nav">
                    <li style="display:inline">
                        <div class="loading" id="layer_loading"></div>
                    </li>
                    <li style="display:inline">
                        <div id="layer_loader" class="loader"></div>
                    </li>
                </ul>
            </div>


         <hr>
                    
         <div style="padding:20px;padding-top:0px;text-align:center">
            <h6>
               Note: Inaccuracies should be expected due to errors in the NLP.
            </h6>
            <br>
            <a href="#" onclick="getNodes()" style="padding-right:20px;">Export nodes (.tsv)</a>
            <a href="#" onclick="getEdges()" style="padding-right:20px;">Export edges (.tsv)</a>
         </div>
         <br>
      </div>
      <script>
         function w3_open() {
           document.getElementById("mySidebar").style.display = "block";
         }
         
         function w3_close() {
           document.getElementById("mySidebar").style.display = "none";
         }
         
          $('.allCheckbox').change(function(event) {  
         var proteins = ["uniprot", "fplx", "PR", "interpro", "pfam"]
         var chemicals = ["pubchem", "CHEBI"]
         console.log("checked box")
         if(this.checked) {
             if (this.value=="all_prot") {
                 $(':checkbox').each(function() {
                     console.log(this.value)
                     if (proteins.includes(this.value)) {
                         this.checked = true;
                     }            
                 });
             } else {
                  $(':checkbox').each(function() {
                     if (chemicals.includes(this.value)) {
                         this.checked = true;
                     }            
                 });
             }
             // Iterate each checkbox
         } else {
             if (this.value=="all_prot") {
                 $(':checkbox').each(function() {
                     if (proteins.includes(this.value)) {
                         this.checked = false;
                     }            
                 });
             } else {
                  $(':checkbox').each(function() {
                     if (chemicals.includes(this.value)) {
                         this.checked = false;
                     }            
                 });
             }
         }
         }); 
      </script>
            <div id="newModal" class="modal">
            <div class="modal-content" style="height:85%;">
                <span class="close">&times;</span>
                 <div id="reachHeader" class="modal-header text-center" style="background-color:#a6a6a6;height:120px">
                 <svg  xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
                        <g>
                            <circle id="source" cx="230" cy="75" r="30" />
                            <text id="source_lab" x="230" y="70" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="source_id" x="230" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>                                      
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 100">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="0" refY="3.5" orient="auto">
                                <polygon id="triangle" points="0 2, 8 3.5, 0 5" />
                            </marker>
                        </defs>
                        
                        <text id="line_lab" dominant-baseline="central" text-anchor="middle" x="138" y="38" font-family="Verdana" font-size="12" fill="black"></text>
                        
                        <line id="line" x1="10" y1="50" x2="270" y2="50" stroke="#000" 
                            stroke-width="8" marker-end="url(#arrowhead)" />
                    </svg>                  
                    <svg  xmlns="http://www.w3.org/2000/svg" style="overflow: visible">
                        <g>
                            <circle id="target" cx="70" cy="75" r="30" />
                            <text id="target_lab" x="70" y="70" dominant-baseline="central" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="target_id" x="70" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>
            </div>
                 <div id="BGHeader" class="modal-header text-center" style="background-color:#a6a6a6;height:120px">
                 <svg  xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
                        <g>
                            <circle id="sourceBG" cx="230" cy="75" r="30" />
                            <text id="source_labBG" x="230" y="70" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="source_idBG" x="230" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>                                      
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 100">
                        
                        <text id="line_labBG" dominant-baseline="central" text-anchor="middle" x="138" y="38" font-family="Verdana" font-size="12" fill="black"></text>
                        
                        <line id="lineBG" x1="0" y1="50" x2="800" y2="50" stroke="#000" 
                            stroke-width="8" />
                    </svg>                  
                    <svg  xmlns="http://www.w3.org/2000/svg" style="overflow: visible">
                        <g>
                            <circle id="targetBG" cx="70" cy="75" r="30" />
                            <text id="target_labBG" x="70" y="70" dominant-baseline="central" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                            <text id="target_idBG" x="70" y="85" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="15" fill="black"></text>
                        </g>
                    </svg>
            </div><nav>
			<div class="nav nav-tabs mb-3" id="nav-tab" role="tablist">
				<button class="nav-link active" id="reach-tab" data-bs-toggle="tab" data-bs-target="#nav-reach" type="button" role="tab" aria-controls="nav-reach" aria-selected="true" style="visibility:hidden">NLP</button>
				<button class="nav-link" id="biogrid-tab" data-bs-toggle="tab" data-bs-target="#nav-biogrid" type="button" role="tab" aria-controls="nav-biogrid" aria-selected="false" style="visibility:hidden">BIOGRID</button>
			</div>
		</nav>
		<div id="tablist" class="tab-content p-3 border bg-light" id="nav-tabContent" style="height:55%;">
			<div class="tab-pane fade" id="nav-reach" role="tabpanel" aria-labelledby="reach-tab" style="height:100%;">
				 <div id="reachEv" class="evDiv" style="height:inherit;">
                    <h1 id="thickness" style="font-family: Arial, Helvetica, sans-serif"></h1>
                    <h2 id="posThickness"></h2>
                    <h2 id="negThickness"></h2>
                    <h2 id="incThickness"></h2>
                    <div id="posEv"></div>
                    <div id="negEv"></div>
                    <div id="incEv"></div>
                </div>
			</div>
			<div class="tab-pane fade" id="nav-biogrid" role="tabpanel" aria-labelledby="nav-biogrid" style="height:100%;">
				<div id="bgEv" class="evDiv" style="height:inherit;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th scope="col">Author (year)</th>
                          <th scope="col">Experiment type</th>
                          <th scope="col">Evidence type</th>
                          <th scope="col">PMC ID</th>
                        </tr>
                      </thead>
                      <tbody id="bgContents">
                          <div id="bgDiv">
                          </div>
                      </tbody>
                    </table>
                </div>
			</div>
		</div>
            </div>
        </div>
       
      <div id="querier" class="modal">
         <div class="modal-content">
            <span class="close" id="closeQuery">&times;</span>
            <div class="modal-header">
               <h1 style="font-family: Arial, Helvetica, sans-serif" id="nodeID"></h1>
            </div>
            <div class="modal-body">
               <form id="queryForm" method="POST" action="{{ url_for('process_data') }}">
                  <p><input id="next_query" type="text" name="next_query" /></p>
                  <p><input type="submit" value="Single Query on this ID" /></p>
               </form>
            </div>
         </div>
      </div>
       
        <div id="searchModal" class="modal" style="width:30%;">
            <div class="modal-content" style="height:80%;">
                <span class="close">&times;</span>
                <div class="modal-header" style="padding-top:0;padding-bottom:0;display:block;">
                    <h5 id="synLabel" style="font-family: Arial, Helvetica, sans-serif">Select match</h5>
                    <p style="color:gray;">Click text to show synonyms</p> 
                </div>
                
                <div id="modalBody" class="modal-body">
                    <form id="matchForm" action="#" >
                        <div class="itemconfiguration">
                            <div style="margin-left:3%;" id="matchOptions"></div>
                        </div>
                        
                         <button type="submit" id="submitMatch" class="btn btn-primary" style="background-color:#4CAF50;float:right"><span class=reload>&#x21bb;</span></button>
                    </form>
                </div>
                
            </div>
        </div>

       
      <div id="cy"></div>
      <script>
          
         const data = {{ elements | tojson }};
          
         var cy = cytoscape({
           wheelSensitivity: 0.1,
           container: document.getElementById('cy'),
           elements: data,
           style: [
             {
               selector: 'node',
               style: {
                 "width": "2000px",
                 "height": "2000px",
                 "content": "data(label)",
                 "font-size": "250px",
                 "text-valign": "center",
                 "text-halign": "center",
                 "background-color": "data(color)",
                 "text-outline-color": "#555",
                 "text-outline-width": "2px",
                 "color": "#121111",
                 "overlay-padding": "6px",
                 "z-index": "10",
                 'background-fit': 'contain',
                 'display_id':'data(display_id)',
                 'x': 'data(x)',
                 'y': 'data(y)',
                 'display':'data(display)',
                 "border-width": function (ele) { return ele.data("border_width"); },
                 "border-color": function (ele) { return ele.data("border_color"); }
               }
             }, {
               selector: 'edge',
               style: {
         
                 'text-background-color': 'yellow',
                 'text-background-opacity': 0.4,
                 'width': 'data(weight)',
                 'target-arrow-shape': 'triangle',
                 'control-point-step-size': '140px',
                 'curve-style': 'bezier',
                 'line-color': "#fcfafa",
                 'target-arrow-color': '#fcfafa',
                 'arrow-scale': 3,
                  'line-color': "data(color)",
                 'target-arrow-color': "data(color)",
                 'display':'data(display)'
               }
             },
             {
               selector: 'node.semitransp',
               style: { 'opacity': '.1' }
             },
             {
               selector: 'edge.semitransp',
               style: { 'opacity': '.1' }
             },
                              {
                         selector: 'node.transp',
                         style: {
                             'opacity': '0',
                             'events': 'no'
                         }
                     },
                     {
                         selector: 'edge.transp',
                         style: { 'opacity': '0' }
                     },
                               {
                         selector: 'node.searched',
                         style: {
                             'background-color': "#26ff12"
                         }
                     },
             {
               selector: 'edge.colors',
               style: {
                 'line-color': "data(color)",
                 'target-arrow-color': "data(color)"
               }
             },
               {
                 selector: 'node.mouseup',
                 style: { 'background-color': "#26ff12" }
                     },
                {
                selector: 'edge.mouseover',
                style: {
                    'line-color': "#26ff12",
                    'target-arrow-color':"#26ff12"
                }
            }
         ],
             
        layout:{
            name:"preset"
         }
         });
          

          
           //Disable switching layers for non-gene queries
            {% if string_type != "gene" %}
                document.getElementById("layer-div").style.display = "none"
                 resetSliderMin("reach")
            {% else %}
                document.getElementById("layer-div").style.display = "block"
            {% endif %}
           
         var currently_querying = false
         
         cy.on('mouseover', 'node', function (evt) {
             if (!currently_querying) {
                 var sel = evt.target;
                 console.log(sel.degree());
                 console.log(sel.data("KB"))
                 console.log("layer: "+sel.data("layer"))
                 console.log(sel.id())
                 sel.addClass('large');
                 var neighbors = sel.outgoers().union(sel.incomers());
                 cy.nodes().difference(neighbors).not(sel).addClass('semitransp');
                 cy.edges().difference(sel.edgesWith(neighbors)).addClass("semitransp");
             }
         });
         
         cy.on('mouseout', 'node', function (evt) {
             if (!currently_querying) {
                 var sel = evt.target;
                 sel.removeClass('large');
                 var neighbors = sel.outgoers().union(sel.incomers());
                 cy.nodes().difference(neighbors).not(sel).removeClass('semitransp');
                 cy.edges().difference(sel.edgesWith(neighbors)).removeClass("semitransp");
             }
         });
             
         cy.on('click', 'node', function (evt) {
             
           var sel = evt.target;
             console.log("syn"+sel.data("syn"))
             console.log("border_width"+sel.data("border_width"))
             sel.shift({ x: 500, y: 500 });
           if (sel.data().rank != 1000000000) {
             var modal = document.getElementById("querier");
             var span = document.getElementById("closeQuery");
             var info = sel.data().label + " (" + sel.data("display_id") + ")";
             var id = document.getElementById("next_query");
             id.value = sel.data("display_id");
             id.style.display = "block";
             document.getElementById("nodeID").innerHTML = info;
             modal.style.display = "block";
             window.onclick = function (event) {
               if (event.target == modal) {
                 modal.style.display = "none";
               }
         
             }
             span.onclick = function () {
               modal.style.display = "none";
             }
           }
         
         });
         
            //Format REACH evidence modal (pos, neg inc)
             function formatEvREACH(ev_split) {
                var ul_pos = document.createElement("ul");
                var ul_neg = document.createElement("ul");
                var ul_inc = document.createElement("ul");
                var negCount = 0;
                var posCount = 0;
                var incCount = 0;
                for (var i = 0; i < ev_split.length; i++) {
                    // Create the list item:
                    var item = document.createElement('li');
                    var cont = document.createElement("div");
            
                    var parts = ev_split[i].split("|");
                    var text = parts[0];
                    var act = parts[1];
            
            
                    // Set its contents:
                    item.appendChild(document.createTextNode(text));
                    cont.appendChild(item)
                    if (act === "Activation (Negative)") {
                        cont.style.color = "red";
                        negCount = negCount += 1;
                    } else if (act === "Activation (Positive)") {
                        cont.style.color = "blue";
                        posCount = posCount += 1;
                    }
                    else {
                        cont.style.color = "black";
                        incCount = incCount += 1;
                    }
            
                    cont.style.padding = "0px 0px 20px 0px";

                    // Add it to the list:
                    if (act === "Activation (Positive)") {
                        ul_pos.appendChild(cont);
                    } else if (act === "Activation (Negative)") {
                        ul_neg.appendChild(cont);
                    } else {
                        ul_inc.appendChild(cont);
                    }
            
                }

                function createFiller() {
            
                    var fillerText = document.createElement("li");
                    var fillerCont = document.createElement("div");
            
                    fillerText.appendChild(document.createTextNode("This is filler text"));
                    fillerCont.appendChild(fillerText);
                    fillerCont.style.padding = "0px 20px 0px 0px";
                    fillerCont.style.color = "white";
                    return fillerCont;
                }
            
                var fillerPos = createFiller();
                var fillerNeg = createFiller();
                var fillerInc = createFiller();
                ul_pos.appendChild(fillerPos);
                ul_neg.appendChild(fillerNeg);
                ul_inc.appendChild(fillerInc);
                 var out = {
                  "ul_pos": ul_pos,
                  "ul_neg": ul_neg,
                  "ul_inc": ul_inc,
                  "posCount": posCount,
                  "negCount": negCount,
                  "incCount": incCount   
                } 
                return(out) 
             }
             
             //Format biogrid ev (table with author, experiment info, etc)
             function formatEvBG(bg_ev) {
              // creates a <table> element and a <tbody> element
              var tbl = document.createElement("div");
              // creating all cells
              for (let i = 0; i < bg_ev.length; i++) {
                // creates a table row
                const row = document.createElement("tr");
                var split_ev = bg_ev[i].split("%%%")
                for (let j = 0; j < split_ev.length; j++) {
                  // Create a <td> element and a text node, make the text
                  // node the contents of the <td>, and put the <td> at
                  // the end of the table row
                  const cell = document.createElement("td");
                  const cellText = document.createTextNode(split_ev[j]);
                  cell.appendChild(cellText);
                  row.appendChild(cell);
                }

                // add the row to the end of the table body
                tbl.appendChild(row); 
              }
              return(tbl)
            }
             
             //Create node visualization at top of evidence modal
             formatHeader = function(sel) {
                var triangle = document.getElementById("triangle");
                var src_node = document.getElementById("source");
                var source_lab = document.getElementById("source_lab");
                var tar_node = document.getElementById("target");
                var target_lab = document.getElementById("target_lab");
                var source_id_lab = document.getElementById("source_id")
                var target_id_lab = document.getElementById("target_id")                
                var line = document.getElementById("line");
                var line_lab = document.getElementById("line_lab");
                 
                var src_nodeBG = document.getElementById("sourceBG");
                var source_labBG = document.getElementById("source_labBG");
                var tar_nodeBG = document.getElementById("targetBG");
                var target_labBG = document.getElementById("target_labBG");
                var source_id_labBG = document.getElementById("source_idBG")
                var target_id_labBG = document.getElementById("target_idBG")                
                var lineBG = document.getElementById("lineBG");
                var line_labBG = document.getElementById("line_labBG");
               
           
                var sel_source = sel.source();
                var sel_target = sel.target();
                       
                var source = sel_source.data().label;
                var source_id = sel_source.data().display_id;
                var target = sel_target.data().label;
                var target_id = sel_target.data().display_id;

                var src_lab = "("+source_id+")"
                var tar_lab = "("+target_id+")"

                source_lab.innerHTML = source
                target_lab.innerHTML = target
                source_id_lab.innerHTML = src_lab
                target_id_lab.innerHTML = tar_lab
                source_labBG.innerHTML = source
                target_labBG.innerHTML = target
                source_id_labBG.innerHTML = src_lab
                target_id_labBG.innerHTML = tar_lab
                       
                src_node.parentNode.appendChild(source_id_lab);

                <!-- Visualize clicked edge/nodes -->                
                src_node.style.fill = sel.source().data().color;
                src_nodeBG.style.fill = sel.source().data().color;
                tar_node.style.fill = sel.target().data().color;
                tar_nodeBG.style.fill = sel.target().data().color;
                 
                triangle.style.fill = sel.data().color;
                line.style.stroke = sel.data().color;
                lineBG.style.stroke = sel.data().color;
                 
                line_lab.innerHTML = "Total mentions: " + sel.data("thickness");
                line_labBG.innerHTML = "Total mentions: " + sel.data("thickness");
                 
                //hide arrowhead if BG
                 if (document.getElementById("layer-button").value=="biogrid") {
                     document.getElementById("reachHeader").classList.add("hiddenHeader");
                     document.getElementById("BGHeader").classList.remove("hiddenHeader");
                 } else {
                     document.getElementById("reachHeader").classList.remove("hiddenHeader");
                     document.getElementById("BGHeader").classList.add("hiddenHeader");
                 }
             }

             cy.on('click', 'edge', function (evt) {     
                var sel = evt.target;
                console.log("layer: "+sel.data("layer"))
                function getEvidence() {
                    var retval;
                    $.ajaxSetup({
                        async: false
                    });
                    $(function() {
                      $.getJSON($SCRIPT_ROOT + '/_get_evidence', {
                        files:sel.data().files
                      }, function(data) {
                          console.log(data.result);
                          retval = data.result;
                          return false;
                      });
                    });
                    console.log(retval);
                    return retval;
                }
            
                var ev = getEvidence();
                
                var modal = document.getElementById("newModal") 
                var span = document.getElementsByClassName("close")[0];
                var thickness = document.getElementById("thickness");
                var parts = ev.split("&&&")
                {% if string_type=="gene" %}
                    var bg_ev = parts.slice(1)   //BG ev is everything after the &&&    
                    var bg_ev = [...new Set(bg_ev)].filter(part => part.length > 0);
                    var ev_split = parts[0].split("%%").filter(part => part.length > 0);
                    bg_ev_length = bg_ev.length
                    reach_ev_length = ev_split.length
                    bg_tbl = formatEvBG(bg_ev)
                    document.getElementById("bgContents").innerHTML = bg_tbl.innerHTML
                 {% else %}
                    var ev_split = parts.join("").split("%%").filter(part => part.length > 0); //Handle case with more than 1 file per edge
                {% endif %}

                formatHeader(sel)
                 
                var reach_formatted = formatEvREACH(ev_split)
                document.getElementById("posThickness").innerHTML = "Positive: " + reach_formatted["posCount"];
                document.getElementById("negThickness").innerHTML = "Negative: " + reach_formatted["negCount"];
                document.getElementById("incThickness").innerHTML = "Inconclusive: " + reach_formatted["incCount"];
                document.getElementById("posEv").innerHTML = reach_formatted["ul_pos"].innerHTML;
                document.getElementById("negEv").innerHTML = reach_formatted["ul_neg"].innerHTML;
                document.getElementById("incEv").innerHTML = reach_formatted["ul_inc"].innerHTML;
                               
                var cur_layer = document.getElementById("layer-button").value 
                var rt = document.getElementById("reach-tab")
                var bt = document.getElementById("biogrid-tab")
                var navr = document.getElementById("nav-reach")
                var navb = document.getElementById("nav-biogrid")
                if  (cur_layer=="reach") {
                    rt.style.visibility = 'hidden'
                    bt.style.visibility = 'hidden'
                    navr.classList.add('active', 'show')
                    navb.classList.remove('active', 'show')
                } else if (cur_layer=="biogrid") {
                    rt.style.visibility = 'hidden'
                    bt.style.visibility = 'hidden'
                    navr.classList.remove('active', 'show')
                    navb.classList.add('active', 'show')
                } else {
                    rt.style.visibility = 'visible'
                    bt.style.visibility = 'visible'
                    rt.classList.add('active')
                    bt.classList.remove('active')
                    navr.classList.add('active', 'show')
                    navb.classList.remove('active', 'show')
                    rt.innerHTML = "Reach ("+reach_ev_length+")"
                    bt.innerHTML = "BIOGRID ("+bg_ev_length+")"
                }
                var reache = document.getElementById("reachEv")
                var bge = document.getElementById("bgEv")

                modal.style.display = "block";
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        reache.scrollTop = 0;
                        bge.scrollTop = 0;
                        modal.style.display = "none";
                    }
                }
            
                span.onclick = function () {
                    reache.scrollTop = 0;
                    bge.scrollTop = 0;
                    modal.style.display = "none";
                }
            });
                  
            cy.on('mouseover', 'edge', function (evt) {
                   var sel = evt.target;
                    if (sel.style()["opacity"] != "0") {
                        sel.addClass('mouseover');
                    }
            });
                  
            cy.on('mouseout', 'edge', function (evt) {
                   var sel = evt.target;
                    sel.removeClass('mouseover');
            });
           
           cy.on('box', function (evt) {
                  var sel = evt.target
                  console.log(sel.length)
                  sel.filter(function(ele) {return((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"))}).addClass("mouseup")
             }); 
         
              cy.on('tap', function(event){
               // target holds a reference to the originator
               // of the event (core or element)
               var evtTarget = event.target;
         
               if( evtTarget === cy ){
                 cy.nodes().removeClass("mouseup")
               } 
             }); 
          
           <!-- Need to recalculate positions for new eles -->
           rerun_layout = function() {
             var eles = cy.elements().filter(function (ele) {
                 return ((ele.style()["display"] != "none") && (ele.style()["opacity"] != "0"));
             });
             var layout = eles.layout({name: 'preset'});
             layout.run();
           }
         
           function getSelectValues(select) {
               var result = [];
               for (var i=0, iLen=select.length; i<iLen; i++) {
                 var opt = select[i];
                 if (opt.checked) {
                   result.push(opt.value);
                 }
               }
               return result;
         }
           
         var kb_form =  document.getElementById("kb_form");
         var selected_kbs = []
         kb_form.onsubmit = function() {
             console.log("submitted")
             var slider = document.getElementById("myRange");
             var threshold=slider.value
             var kb_select = document.getElementsByClassName('messageCheckbox');
             selected_kbs = getSelectValues(kb_select);
             console.log("selected kbs: "+selected_kbs)
             filterKBs(selected_kbs)
             console.log("KB filter threshold: "+threshold)
             filterEdges(threshold)
             return false
         } 
          
             function getMaxWeight(allEdges) {
                 var weight_arr = []
                 for (var i = 0; i < allEdges.length; i++) {
                     var edgeData = (allEdges[i]).data()
                     var weight = edgeData.thickness
                     weight_arr.push(weight)
                 }
                 Array.prototype.max = function() {
                   return Math.max.apply(null, this);
                 };
                 var maxWeight = weight_arr.max()
                 return(maxWeight)
             }
                  
            function getMaxWeightUnion(allEdges) {
                 var weight_arrR = []
                 var weight_arrBG = []
                 for (var i = 0; i < allEdges.length; i++) {
                     var edgeData = (allEdges[i]).data()
                     var weightR = edgeData.thickness_r
                     var weightBG = edgeData.thickness_bg
                     weight_arrR.push(weightR)
                     weight_arrBG.push(weightBG)
                 }
                 Array.prototype.max = function() {
                   return Math.max.apply(null, this);
                 };
                 var maxWeightR = weight_arrR.max()
                 var maxWeightBG = weight_arrBG.max()
                 return([maxWeightR, maxWeightBG])
             }     
         
           
             var filteredEdges = cy.edges().filter('[thickness < 0]');
             var filteredNodes = cy.nodes().filter(function (ele) {
                 return ele.degree() == -2;
             });
             filteredEdges = cy.remove(filteredEdges);
             filteredNodes = cy.remove(filteredNodes);
          
            filterEdges = function(threshold) {
                filteredNodes.removeClass("transp");
                filteredEdges.restore();
                var cur_layer = document.getElementById("layer-button").value
                
                filteredEdges = cy.edges().filter(function(ele) {
                    return((ele.data("thickness") < threshold) && (ele.data("layer")==cur_layer))
                });
                filteredEdges = cy.remove(filteredEdges);
                filteredNodes = cy.nodes().filter(function (ele) {
                    return ((ele.degree() == 0) && (ele.data("type") != "Query")&& (ele.data("layer")==cur_layer));
                });
                filteredNodes.addClass("transp");
                rerun_layout();
            }
                  
            filterEdgesUnion = function(threshold_r, threshold_bg, threshold_total) {
                filteredNodes.removeClass("transp");
                filteredEdges.restore();
                
                filteredEdges = cy.edges().filter(function(ele) {
                    return((((ele.data("thickness_r") < threshold_r) && (ele.data("thickness_bg") < threshold_bg)) |
                          (ele.data("thickness") < threshold_total)) && (ele.data("layer")=="union"))
                });
                filteredEdges = cy.remove(filteredEdges);
                filteredNodes = cy.nodes().filter(function (ele) {
                    return ((ele.degree() == 0) && (ele.data("type") != "Query")&& (ele.data("layer")=="union"));
                });
                filteredNodes.addClass("transp");
                rerun_layout();
            }
         
            var slider = document.getElementById("myRange");
            var allEdges = cy.edges().filter(function(ele) {return((ele.data("layer")=="reach"))})    
            var allMax = Math.ceil(getMaxWeight(allEdges))
            var allEdgesBG = cy.edges().filter(function(ele) {return((ele.data("layer")=="biogrid"))})    
            var allMaxBG = Math.ceil(getMaxWeight(allEdgesBG))
            var allEdgesUnion = cy.edges().filter(function(ele) {return((ele.data("layer")=="union"))})    
            var allMaxUnion = Math.ceil(getMaxWeight(allEdgesUnion))
            var [maxR, maxBG] = getMaxWeightUnion(allEdgesUnion)
            slider.max = allMax
            var input_qty = document.getElementById("quantity");
            input_qty.max = allMax
            var output = document.getElementById("quantity");
            output.innerHTML = slider.value;
            var input_thickness = document.getElementById("input_thickness") 
            slider.oninput = function () {
                var cur_layer = document.getElementById("layer-button").value
                threshold = this.value;
                if (cur_layer != "union") {
                    filterEdges(threshold)
                } else {
                    var thresholdR = document.getElementById("quantityR").value;
                    var thresholdBG = document.getElementById("quantityBG").value;
                    console.log("BG: "+thresholdBG+", R: "+thresholdR+", total: "+threshold)
                    filterEdgesUnion(thresholdR, thresholdBG, threshold)
                }
                filterKBs(selected_kbs)
                output.innerHTML = this.value;
                input_qty.value = this.value
            }
            input_thickness.onsubmit = function () {          
                var thickness_val = document.getElementById("quantity");
                var threshold = thickness_val.value;
                var cur_layer = document.getElementById("layer-button").value
                if (cur_layer != "union") {
                    filterEdges(threshold)
                } else {
                    var thresholdR = document.getElementById("quantityR").value;
                    var thresholdBG = document.getElementById("quantityBG").value;
                    filterEdgesUnion(thresholdR, thresholdBG, threshold)                    
                }                
                filterKBs(selected_kbs)
                output.innerHTML = threshold
                slider.value=threshold
                return false
            }
                  
            var sliderR = document.getElementById("myRangeR");
            var sliderBG = document.getElementById("myRangeBG");
            sliderR.max = maxR
            sliderBG.max = maxBG    
            var input_qtyR = document.getElementById("quantityR");
            input_qtyR.max = maxR
            input_qtyR.innerHTML = sliderR.value;
            var input_qtyBG = document.getElementById("quantityBG");
            input_qtyBG.max = maxBG
            input_qtyBG.innerHTML = sliderBG.value;
            var input_thicknessR = document.getElementById("input_thicknessR") 
            var input_thicknessBG = document.getElementById("input_thicknessBG") 
            var thresholdR = sliderR.value
            var thresholdBG = sliderBG.value
            sliderR.oninput = function () {
                var thresholdR = this.value;
                var thresholdBG = document.getElementById("quantityBG").value;
                var thresholdTotal = document.getElementById("quantity").value
                console.log("BG: "+thresholdBG+", R: "+thresholdR)
                filterEdgesUnion(thresholdR, thresholdBG, thresholdTotal)
                filterKBs(selected_kbs)
                input_qtyR.innerHTML = this.value;
                input_qtyR.value = this.value
            }
            input_thicknessR.onsubmit = function () {          
                var thickness_valR = document.getElementById("quantityR");
                var thresholdBG = document.getElementById("quantityBG").value
                var thresholdTotal = document.getElementById("quantity").value
                var thresholdR = thickness_valR.value;
                filterEdgesUnion(thresholdR, thresholdBG, thresholdTotal)
                filterKBs(selected_kbs)
                input_qtyR.innerHTML = thresholdR
                sliderR.value=thresholdR
                return false
            }
            sliderBG.oninput = function () {
                var thresholdBG = this.value;
                var thresholdR = document.getElementById("quantityR").value
                var thresholdTotal = document.getElementById("quantity").value
                console.log("BG: "+thresholdBG+", R: "+thresholdR)
                filterEdgesUnion(thresholdR, thresholdBG, thresholdTotal)
                filterKBs(selected_kbs)
                input_qtyBG.innerHTML = this.value;
                input_qtyBG.value = this.value
            }
            input_thicknessBG.onsubmit = function () {          
                var thickness_valBG = document.getElementById("quantityBG");
                var thresholdTotal = document.getElementById("quantity").value
                var thresholdR = document.getElementById("quantityR").value
                var thresholdBG = thickness_valBG.value;
                filterEdgesUnion(thresholdR, thresholdBG, thresholdTotal)
                filterKBs(selected_kbs)
                input_qtyBG.innerHTML = thresholdBG
                sliderBG.value=thresholdBG
                return false
            }
          
          
            function updateCollapsible(el_id, search, nodes){
                var options = document.getElementById(el_id);
                options.innerHTML="";
                for(var i=0; i<nodes.length; i++) {
                    var sel = nodes[i];
                    var syn = sel.data().syn.toLowerCase();

                    // String-matching part
                    if (syn.includes(search)) {
                        // Content: append other stuff to this for the scrolling menu
                        // Making the input radio
                        var input_el = document.createElement("input");
                        input_el.type = "radio";
                        input_el.style.display = "inline";
                        input_el.name = "nodeSel";
                        input_el.value = sel.id();
                        input_el.id = sel.id();

                        options.appendChild(input_el);

                        // Making the button
                        var btn_el = document.createElement("button");
                        btn_el.className = "collapsible";
                        btn_el.id = "btn_el";
                        btn_el.type = "button"
                        btn_el.innerHTML = sel.data().label + " ("+sel.data().display_id+")";

                        options.appendChild(btn_el);

                        // Making the div to contain the synonyms (parent of ul_el)
                        var div_el = document.createElement("div");
                        div_el.className = "content";

                        // Making the ul to contain the synonyms (parent of li_el)
                        var ul_el = document.createElement("ul");

                        // Turn the synonyms into usable text
                        var syn_split = syn.split("%%");
                        syn_split = [...new Set(syn_split)];    // Turn split into array
                        for (var j = 0; j < syn_split.length; j++) {
                            // Making the li to contain the synonym (child of ul_el)
                            var li_el = document.createElement("li");
                            li_el.innerHTML = syn_split[j];

                            ul_el.appendChild(li_el);
                        }

                        div_el.appendChild(ul_el);

                        options.appendChild(div_el);
                    }
                }
            }
          
             function updateOptions(ele_id, search, nodes, name="match") {
                var options = document.getElementById(ele_id)
                options.innerHTML=""
                for (var i=0; i<nodes.length; i++) {
                    var sel = nodes[i]
                    var syn = sel.data().syn
                    if (syn.includes(search)) {
                        var cont = document.createElement("div");
                        cont.setAttribute("class", "matchDiv")
                        var header = document.createElement("input");
                        header.setAttribute('value', sel.id());
                        header.setAttribute('type', 'radio');
                        header.setAttribute('name', name);
                        header.setAttribute("id", sel.id());
                        cont.appendChild(header)
                        var newlabel = document.createElement("Label");
                        newlabel.setAttribute("for",sel.id());
                        var labelText = sel.data().label + " ("+sel.data().display_id+")"
                        newlabel.innerHTML = labelText
                        cont.appendChild(newlabel)
                        var syn_split = syn.split("%%");
                        syn_split = [...new Set(syn_split)];
                        var syn_list = document.createElement("ul")
                        for (var j = 0; j < syn_split.length; j++) {
                            var item = document.createElement('li');
                            var subcont = document.createElement("div");
                            var text = syn_split[j];
                            if (text.includes(search)) {
                                item.appendChild(document.createTextNode(text));
                                subcont.appendChild(item)
                                subcont.style.padding = "0px 0px 20px 0px";
                                syn_list.appendChild(subcont);
                            }   
                        }
                        cont.appendChild(syn_list)
                        options.appendChild(cont)
                    }
                }
             }
             
             var node_search = document.getElementById("node_search");
             var reset_button = document.getElementById("reset")  
             node_search.onsubmit = function () {
                 var modal = document.getElementById("searchModal")
                 var span = document.getElementsByClassName("close")[2];
                 reset_button.style="background-color:#4CAF50;"
                 
                 //cy.nodes().removeClass("transp");
                 cy.edges().removeClass("transp");
                 cy.nodes().removeClass("searched");
                 
                 var node_name = document.getElementById("node_name");
                 var search = node_name.value.toLowerCase();
                 var nodes = cy.nodes().filter(function(ele) {return((ele.style()["display"] != "none") && 
                            (ele.style()["opacity"] != "0"))})
                 
                 console.log("nodes length: "+nodes.length)
                 
                 updateCollapsible("matchOptions", search, nodes)

                 modal.style.display = "block";
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        var modalBody = document.getElementById("modalBody");
                        modalBody.scrollTop = 0;
                        modal.style.display = "none";
                    }
                }
            
                span.onclick = function () {
                    var modalBody = document.getElementById("modalBody");
                    modalBody.scrollTop = 0;
                    modal.style.display = "none";
                }

                return false
             }
          
          var matchForm = document.getElementById("matchForm")
          var current_query = document.getElementById("current_query");
            matchForm.onsubmit = function() {
                var choice = document.querySelector('input[name="nodeSel"]:checked').value;
                var results_nodes = cy.nodes().filter(function(ele) {
                    return ((ele.id() === choice));})
                var cq =  results_nodes.data().label + " ("+results_nodes.data().display_id+")"
                current_query.innerHTML = cq; 
                results_nodes.addClass('searched')
                var neighbors = results_nodes.outgoers().union(results_nodes.incomers());
                var results_edges = results_nodes.connectedEdges()
                var results_nodes = results_nodes.union(neighbors)
                cy.nodes().difference(results_nodes).addClass('transp');
                cy.edges().difference(results_edges).addClass('transp');
                var modal = document.getElementById("searchModal")
                var modalBody = document.getElementById("modalBody");
                modalBody.scrollTop = 0;
                modal.style.display = "none";
                return false
            }
          

             function reset_query() {
                 var node_name = document.getElementById("node_name");
                 currently_querying = false;
                 cy.nodes().removeClass("transp");
                 cy.edges().removeClass("transp");
                 cy.nodes().removeClass("searched");
                 var slider = document.getElementById("myRange");
                 var threshold=slider.value
                 var cur_layer = document.getElementById("layer-button").value
                 if (cur_layer!="union") {
                     filterEdges(threshold)
                 } else {
                    var thresholdR = document.getElementById("quantityR").value;
                    var thresholdBG = document.getElementById("quantityBG").value;
                    filterEdgesUnion(thresholdR, thresholdBG, threshold)                       
                 }
                 filterKBs(selected_kbs)
                 current_query.innerHTML = "None"; 
                 node_name.value=""
                reset_button.style.display = "None"
             }
         
             var excludedEdges = cy.edges().filter('[thickness < 0]');
             var excludedNodes = cy.nodes().filter(function (ele) {
                 return ele.degree() == -2;
             });
             excludedEdges = cy.remove(excludedEdges);
             excludedNodes = cy.remove(excludedNodes);
              
             filterKBs = function(kb_list) {
                resetKBs()
                if (kb_list.length!=0) {
                    excludedNodes = cy.nodes().filter(function(ele) {
                        return (!((kb_list.includes(ele.data("KB")) && ele.degree()!=0)) &&(ele.data("layer")=="reach") && (ele.data("depth")!=0))
                    });   
                    excludedNodes.addClass("transp");
                    excludedEdges = cy.edges().filter(function(ele) {
                        return ((excludedNodes.includes(ele.source()) | excludedNodes.includes(ele.target())))
                    })
                    excludedEdges = cy.remove(excludedEdges)
                    rerun_layout();                
                }
            } 
             
             resetKBs = function() {
                 excludedNodes.removeClass("transp")
                 excludedEdges.restore()
                 rerun_layout();
             }
                  
                              //Set the min value of the thickness filter when switching layers
            function resetSliderMin(layer) {
                var slider = document.getElementById("myRange");
                var input_qty = document.getElementById("quantity");
                if (layer=="reach") {
                    slider.value=2
                    input_qty.value=2
                    slider.min=2
                    input_qty.min=2
                } else {
                    slider.min=1
                    input_qty.min=1
                    slider.value=1
                    input_qty.value=1
                    
                }
            } 
              
            //Set the max value of the thickness filter when switching layers      
            resetSliderMax = function() {
                var slider = document.getElementById("myRange");
                var input_qty = document.getElementById("quantity");
                var cur_layer = document.getElementById("layer-button").value
                if (cur_layer=="reach") {
                    slider.max = allMax
                    input_qty.max = allMax
                } else if (cur_layer=="biogrid") {
                    slider.max = allMaxBG
                    input_qty.max = allMaxBG
                } else if (cur_layer=="union") {
                    slider.max = allMaxUnion
                    input_qty.max = allMaxUnion
                }
            }
            
        const download = function (data, filename) {

            // Creating a Blob for having a csv file format 
            // and passing the data with type
            const blob = new Blob([data], { type: 'text/csv' });

            // Creating an object for downloading url
            const url = window.URL.createObjectURL(blob)

            // Creating an anchor(a) tag of HTML
            const a = document.createElement('a')

            // Passing the blob downloading url 
            a.setAttribute('href', url)

            // Setting the anchor tag attribute for downloading
            // and passing the download file name
            a.setAttribute('download', filename);

            // Performing a download with click
            a.click()
        }
          
        function getNodes()  {
            var eles = cy.nodes().filter(function(ele) {return((ele.style("display")=="element") & (!ele.hasClass("transp")))}).jsons()
            var nodes_str = JSON.stringify(eles)
            var retval;
            $.ajaxSetup({
                async: false
            });
            $.post('/getNodes', {subset_nodes: nodes_str}, function(data){
                retval = data.nodes_df
            });  
            download(retval, "nodes.tsv")
          }
                  
         function getEdges()  {
            var eles = cy.edges().filter(function(ele) {
                return((ele.source().style("display")=="element") & (ele.target().style("display")=="element") &
                       (!ele.hasClass("transp")) & (!ele.source().hasClass("transp")) & (!ele.target().hasClass("transp")))}).jsons()
            var edges_str = JSON.stringify(eles)
            var retval;
            $.ajaxSetup({
                async: false
            });
            $.post('/getEdges', {subset_edges: edges_str}, function(data){
                retval = data.edges_df
            });
            download(retval, "edges.tsv")
          }
             
            //Switch between REACH, BG, and union
            function switch_layer() {
                var cur_layer = document.getElementById("layer-button").value;
                console.log("cur_layer: "+cur_layer)
                var biogrid_eles = cy.elements().filter(function (ele) {
                        return((ele.data("layer")=="biogrid"))
                    })
                var reach_eles =  cy.elements().filter(function (ele) {
                        return((ele.data("layer")=="reach"))
                    })
                var union_eles =  cy.elements().filter(function (ele) {
                        return((ele.data("layer")=="union"))
                    })
                var totalLabel = document.getElementById("totalLabel")
                var indFilter = document.getElementById("IndFilter")
                if (cur_layer=="biogrid") {
                    reach_eles.style("display", "none")
                    union_eles.style("display", "none")
                    biogrid_eles.style("display", "element")
                    totalLabel.style.display = "none"
                    indFilter.style.display="none"
                    document.getElementById("kb_div").style.display = "none"
                    document.getElementById("legend").style.display = "none"
                    document.getElementById("color-scheme").style.display = "none"
                    cy.edges().style('target-arrow-shape', 'none')
                } else if (cur_layer=="reach") {
                    reach_eles.style("display", "element")
                    union_eles.style("display", "none")
                    biogrid_eles.style("display", "none")
                    totalLabel.style.display = "none"
                    indFilter.style.display="none"
                    document.getElementById("kb_div").style.display = "block"
                    document.getElementById("legend").style.display = "none"
                    document.getElementById("color-scheme").style.display = "none"
                    cy.edges().style('target-arrow-shape', 'triangle')
                    filterKBs(selected_kbs)
                } else {
                    reach_eles.style("display", "none")
                    union_eles.style("display", "element")
                    biogrid_eles.style("display", "none")
                    totalLabel.style.display = "block"
                    indFilter.style.display="block"
                    document.getElementById("kb_div").style.display = "none"
                    document.getElementById("legend").style.display = "block"
                    document.getElementById("color-scheme").style.display = "block"
                    cy.edges().style('target-arrow-shape', 'triangle')
                }
                resetSliderMax()
                resetSliderMin(cur_layer) 
                var slider = document.getElementById("myRange");
                var threshold=slider.value
                if (cur_layer != "union") {
                    filterEdges(threshold)
                } else {
                    var thresholdR = document.getElementById("quantityR").value;
                    var thresholdBG = document.getElementById("quantityBG").value;
                    console.log("BG: "+thresholdBG+", R: "+thresholdR+", total: "+threshold)
                    filterEdgesUnion(thresholdR, thresholdBG, threshold)                    
                }
                rerun_layout()
                return false
            }

            
           //Add loader to layer switching       
           function run_switch_layer() {
                const status = document.querySelector('#layer_loading');
                const loader = document.querySelector('#layer_loader');
                const wait = (ms = 5000) => {
                    return new Promise((resolve) => {
                    setTimeout(() => {
                        switch_layer()
                        resolve();
                    },ms)
                  })
                }
                status.innerHTML = "Loading network...";
                loader.classList.toggle('show', true);
                wait(500)
                .then(() => {
                    status.innerHTML = "";
                    loader.classList.toggle('show', false);
                })
            }
         
         function add_colors() {
           var x = document.getElementById("color-button");
           if (x.innerHTML === "Show Color") {
             x.innerHTML = "Hide Color";
             cy.edges().addClass("colors");
           } else {
             x.innerHTML = "Show Color";
             cy.edges().removeClass("colors");
           }
         }
        
        let tc_scheme = true
        function run_change_scheme() {
            const status = document.querySelector('#layer_loading');
            const loader = document.querySelector('#layer_loader');
            
            const wait = (ms = 5000) => {
                return new Promise((resolve) => {
                setTimeout(() => {
                    change_scheme(tc_scheme);
                    rerun_layout();
                    if (tc_scheme) {
                        tc_scheme = false
                    } else {
                        tc_scheme = true
                    }
                    resolve();
                },ms)
              })
            }
            
            if (tc_scheme) {
                status.innerHTML = "Coloring by dataset...";
            } else {
                status.innerHTML = "Coloring by evidence...";
            }
            
            loader.classList.toggle('tc_scheme', true);
            wait(500)
            .then(() => {
                status.innerHTML = "";
                loader.classList.toggle('tc_scheme', false);
            })
        }

        function change_scheme(tc_scheme=true){
            var cur_layer = document.getElementById("layer-button").value 
            if (tc_scheme) {
                cy.edges().style("line-color", function (ele) { return ele.data("dataset_color"); })
                cy.edges().style("target-arrow-color", function (ele) { return ele.data("dataset_color"); })
            
            } else {
                cy.edges().style("line-color", function (ele) { return ele.data("color"); })
                cy.edges().style("target-arrow-color", function (ele) { return ele.data("color"); })
            }
        }
         
         function switch_color() {
           var x = document.getElementById("current-color");
           if (x.innerHTML === "Current: Positive interactions") {
             x.innerHTML = "Current: Negative interactions";
             cy.edges().removeClass("pos_colors");
             cy.edges().addClass("neg_colors");
           } else if (x.innerHTML == "Current: Negative interactions") {
             x.innerHTML = "Current: Inconclusive interactions";
             cy.edges().removeClass("neg_colors");
             cy.edges().addClass("inc_colors");
           } else if (x.innerHTML == "Current: Inconclusive interactions") {
             x.innerHTML = "Current: None";
             cy.edges().removeClass("inc_colors");
           } else {
             x.innerHTML = "Current: Positive interactions";
             cy.edges().addClass("pos_colors");
           }
         }
          
          // Add listener to dynamically created buttons
          document.addEventListener("click", function(e){
            const target = e.target.closest("#btn_el"); // Or any other selector.
  
            if(target){
              target.classList.toggle("active");
              var content = target.nextElementSibling;
              if (content.style.maxHeight){
                content.style.maxHeight = null;
              } else {
                content.style.maxHeight = content.scrollHeight + "px";
              }
            }
          });

      </script>
      <button class="w3-button w3-teal w3-xlarge" onclick="w3_open()" style="z-index:2">☰</button>
   </body>
</html>